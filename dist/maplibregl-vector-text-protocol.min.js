!function(g,I){"object"==typeof exports&&"undefined"!=typeof module?I(exports):"function"==typeof define&&define.amd?define(["exports"],I):I((g="undefined"!=typeof globalThis?globalThis:g||self).VectorTextProtocol={})}(this,(function(g){"use strict";function I(g,I){return I.forEach((function(I){I&&"string"!=typeof I&&!Array.isArray(I)&&Object.keys(I).forEach((function(C){if("default"!==C&&!(C in g)){var A=Object.getOwnPropertyDescriptor(I,C);Object.defineProperty(g,C,A.get?A:{enumerable:!0,get:function(){return I[C]}})}}))})),Object.freeze(g)}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var C={exports:{}};!function(g,I){!function(g){function I(g){return new Function("d","return {"+g.map((function(g,I){return JSON.stringify(g)+": d["+I+"]"})).join(",")+"}")}function C(g,C){var A=I(g);return function(I,l){return C(A(I),l,g)}}function A(g){var I=Object.create(null),C=[];return g.forEach((function(g){for(var A in g)A in I||C.push(I[A]=A)})),C}function l(g){var l=new RegExp('["'+g+"\n]"),b=g.charCodeAt(0);function c(g,A){var l,b,c=Z(g,(function(g,c){if(l)return l(g,c-1);b=g,l=A?C(g,A):I(g)}));return c.columns=b,c}function Z(g,I){var C,A,l={},c={},Z=[],o=g.length,d=0,e=0;function G(){if(d>=o)return c;if(A)return A=!1,l;var I,C=d;if(34===g.charCodeAt(C)){for(var Z=C;Z++<o;)if(34===g.charCodeAt(Z)){if(34!==g.charCodeAt(Z+1))break;++Z}return d=Z+2,13===(I=g.charCodeAt(Z+1))?(A=!0,10===g.charCodeAt(Z+2)&&++d):10===I&&(A=!0),g.slice(C+1,Z).replace(/""/g,'"')}for(;d<o;){var e=1;if(10===(I=g.charCodeAt(d++)))A=!0;else if(13===I)A=!0,10===g.charCodeAt(d)&&(++d,++e);else if(I!==b)continue;return g.slice(C,d-e)}return g.slice(C)}for(;(C=G())!==c;){for(var t=[];C!==l&&C!==c;)t.push(C),C=G();I&&null==(t=I(t,e++))||Z.push(t)}return Z}function o(I,C){return null==C&&(C=A(I)),[C.map(G).join(g)].concat(I.map((function(I){return C.map((function(g){return G(I[g])})).join(g)}))).join("\n")}function d(g){return g.map(e).join("\n")}function e(I){return I.map(G).join(g)}function G(g){return null==g?"":l.test(g+="")?'"'+g.replace(/\"/g,'""')+'"':g}return{parse:c,parseRows:Z,format:o,formatRows:d}}var b=l(","),c=b.parse,Z=b.parseRows,o=b.format,d=b.formatRows,e=l("\t"),G=e.parse,t=e.parseRows,s=e.format,n=e.formatRows;g.dsvFormat=l,g.csvParse=c,g.csvParseRows=Z,g.csvFormat=o,g.csvFormatRows=d,g.tsvParse=G,g.tsvParseRows=t,g.tsvFormat=s,g.tsvFormatRows=n,Object.defineProperty(g,"__esModule",{value:!0})}(I)}(0,C.exports);var A={exports:{}};function l(g,I){var C=b(g,I);return C.whole+"° "+(C.minutes?C.minutes+"' ":"")+(C.seconds?C.seconds+'" ':"")+C.dir}function b(g,I){var C=({lat:["N","S"],lon:["E","W"]}[I]||"")[g>=0?0:1],A=Math.abs(g),l=Math.floor(A),b=60*(A-l),c=Math.floor(b);return{whole:l,minutes:c,seconds:Math.floor(60*(b-c)),dir:C}}function c(g,I){if(I||(I="NSEW"),"string"!=typeof g)return null;var C=(g=g.toUpperCase()).match(/^[\s\,]*([NSEW])?\s*([\-|\—|\―]?[0-9.]+)[°º˚]?\s*(?:([0-9.]+)['’′‘]\s*)?(?:([0-9.]+)(?:''|"|”|″)\s*)?([NSEW])?/);if(!C)return null;var A,l=C[0];if(C[1]&&C[5]?(A=C[1],l=l.slice(0,-1)):A=C[1]||C[5],A&&-1===I.indexOf(A))return null;var b=C[2]?parseFloat(C[2]):0,c=C[3]?parseFloat(C[3])/60:0,Z=C[4]?parseFloat(C[4])/3600:0,o=b<0?-1:1;return"S"!==A&&"W"!==A||(o*=-1),{val:(Math.abs(b)+c+Z)*o,dim:A,matched:l,remain:g.slice(l.length)}}A.exports=function(g,I){var C=c(g,I);return null===C?null:C.val},A.exports.pair=function(g,I){var C=c(g=g.trim(),I);if(!C)return null;var A=c(g=C.remain.trim(),I);if(!A||A.remain)return null;return C.dim?function(g,I,C){if("N"===C||"S"===C)return[g,I];if("W"===C||"E"===C)return[I,g]}(C.val,A.val,C.dim):[C.val,A.val]},A.exports.format=l,A.exports.formatPair=function(g){return l(g.lat,"lat")+" "+l(g.lon,"lon")},A.exports.coordToDMS=b;var Z=C.exports,o=A.exports,d=/(Lat)(itude)?/gi,e=/(L)(on|ng)(gitude)?/i;function G(g,I){var C,A,l;for(var b in g)(A=b.match(I))&&(!C||A[0].length/b.length>l)&&(l=A[0].length/b.length,C=b);return C}function t(g){return G(g,d)}function s(g){return G(g,e)}function n(g){return"object"==typeof g?Object.keys(g).length:0}function m(g){var I=[];return[",",";","\t","|"].forEach((function(C){var A=Z.dsvFormat(C).parse(g);if(A.length>=1){for(var l=n(A[0]),b=0;b<A.length;b++)if(n(A[b])!==l)return;I.push({delimiter:C,arity:Object.keys(A[0]).length})}})),I.length?I.sort((function(g,I){return I.arity-g.arity}))[0].delimiter:null}var W={isLon:function(g){return!!g.match(e)},isLat:function(g){return!!g.match(d)},guessLatHeader:t,guessLonHeader:s,csv:Z.csvParse,tsv:Z.tsvParse,dsv:Z,auto:function(g){var I=m(g);return I?function(g){return delete g.columns,g}(Z.dsvFormat(I).parse(g)):null},csv2geojson:function(g,I,C){C||(C=I,I={}),I.delimiter=I.delimiter||",";var A=I.latfield||"",l=I.lonfield||"",b=I.crs||"",c=[],d={type:"FeatureCollection",features:c};if(""!==b&&(d.crs={type:"name",properties:{name:b}}),"auto"!==I.delimiter||"string"!=typeof g||(I.delimiter=m(g),I.delimiter)){var e=I.numericFields?I.numericFields.split(","):null,G="string"==typeof g?Z.dsvFormat(I.delimiter).parse(g,(function(g){if(e)for(var I in g)e.includes(I)&&(g[I]=+g[I]);return g})):g;if(G.length){var n,W=[];if(A||(A=t(G[0])),l||(l=s(G[0])),!A||!l){for(n=0;n<G.length;n++)c.push({type:"Feature",properties:G[n],geometry:null});C(W.length?W:null,d)}else{for(n=0;n<G.length;n++)if(void 0!==G[n][l]&&void 0!==G[n][A]){var B,i,a,V=G[n][l],y=G[n][A];(a=o(V,"EW"))&&(V=a),(a=o(y,"NS"))&&(y=a),B=parseFloat(V),i=parseFloat(y),isNaN(B)||isNaN(i)?W.push({message:"A row contained an invalid value for latitude or longitude",row:G[n],index:n}):(I.includeLatLon||(delete G[n][l],delete G[n][A]),c.push({type:"Feature",properties:G[n],geometry:{type:"Point",coordinates:[parseFloat(B),parseFloat(i)]}}))}C(W.length?W:null,d)}}else C(null,d)}else C({type:"Error",message:"Could not autodetect delimiter"})},toLine:function(g){for(var I=g.features,C={type:"Feature",geometry:{type:"LineString",coordinates:[]}},A=0;A<I.length;A++)C.geometry.coordinates.push(I[A].geometry.coordinates);return C.properties=I.reduce((function(g,I){for(var C in I.properties)g[C]||(g[C]=[]),g[C].push(I.properties[C]);return g}),{}),{type:"FeatureCollection",features:[C]}},toPolygon:function(g){for(var I=g.features,C={type:"Feature",geometry:{type:"Polygon",coordinates:[[]]}},A=0;A<I.length;A++)C.geometry.coordinates[0].push(I[A].geometry.coordinates);return C.properties=I.reduce((function(g,I){for(var C in I.properties)g[C]||(g[C]=[]),g[C].push(I.properties[C]);return g}),{}),{type:"FeatureCollection",features:[C]}}};function B(g){return g}function i(g,I){var C=I.id,A=I.bbox,l=null==I.properties?{}:I.properties,b=function(g,I){var C=function(g){if(null==g)return B;var I,C,A=g.scale[0],l=g.scale[1],b=g.translate[0],c=g.translate[1];return function(g,Z){Z||(I=C=0);var o=2,d=g.length,e=new Array(d);for(e[0]=(I+=g[0])*A+b,e[1]=(C+=g[1])*l+c;o<d;)e[o]=g[o],++o;return e}}(g.transform),A=g.arcs;function l(g,I){I.length&&I.pop();for(var l=A[g<0?~g:g],b=0,c=l.length;b<c;++b)I.push(C(l[b],b));g<0&&function(g,I){for(var C,A=g.length,l=A-I;l<--A;)C=g[l],g[l++]=g[A],g[A]=C}(I,c)}function b(g){return C(g)}function c(g){for(var I=[],C=0,A=g.length;C<A;++C)l(g[C],I);return I.length<2&&I.push(I[0]),I}function Z(g){for(var I=c(g);I.length<4;)I.push(I[0]);return I}function o(g){return g.map(Z)}function d(g){var I,C=g.type;switch(C){case"GeometryCollection":return{type:C,geometries:g.geometries.map(d)};case"Point":I=b(g.coordinates);break;case"MultiPoint":I=g.coordinates.map(b);break;case"LineString":I=c(g.arcs);break;case"MultiLineString":I=g.arcs.map(c);break;case"Polygon":I=o(g.arcs);break;case"MultiPolygon":I=g.arcs.map(o);break;default:return null}return{type:C,coordinates:I}}return d(I)}(g,I);return null==C&&null==A?{type:"Feature",properties:l,geometry:b}:null==A?{type:"Feature",id:C,properties:l,geometry:b}:{type:"Feature",id:C,bbox:A,properties:l,geometry:b}}var a={};function V(g){return g&&g.normalize&&g.normalize(),g&&g.textContent||""}function y(g,I){const C=g.getElementsByTagName(I);return C.length?C[0]:null}function J(g){const I={};if(g){const C=y(g,"line");if(C){const g=V(y(C,"color")),A=parseFloat(V(y(C,"opacity"))),l=parseFloat(V(y(C,"width")));g&&(I.stroke=g),isNaN(A)||(I["stroke-opacity"]=A),isNaN(l)||(I["stroke-width"]=96*l/25.4)}}return I}function S(g,I){const C={};let A,l;for(l=0;l<I.length;l++)A=y(g,I[l]),A&&(C[I[l]]=V(A));return C}function u(g){const I=S(g,["name","cmt","desc","type","time","keywords"]),C=g.getElementsByTagNameNS("http://www.garmin.com/xmlschemas/GpxExtensions/v3","*");for(let A=0;A<C.length;A++){const l=C[A];l.parentNode.parentNode===g&&(I[l.tagName.replace(":","_")]=V(l))}const A=g.getElementsByTagName("link");A.length&&(I.links=[]);for(let g=0;g<A.length;g++)I.links.push(Object.assign({href:A[g].getAttribute("href")},S(A[g],["text","type"])));return I}function k(g){const I=[parseFloat(g.getAttribute("lon")),parseFloat(g.getAttribute("lat"))],C=y(g,"ele"),A=y(g,"gpxtpx:hr")||y(g,"hr"),l=y(g,"time");let b;C&&(b=parseFloat(V(C)),isNaN(b)||I.push(b));const c={coordinates:I,time:l?V(l):null,extendedValues:[]};A&&c.extendedValues.push(["heart",parseFloat(V(A))]);const Z=y(g,"extensions");if(null!==Z)for(const g of["speed","course","hAcc","vAcc"]){const I=parseFloat(V(y(Z,g)));isNaN(I)||c.extendedValues.push([g,I])}return c}function H(g){const I=p(g,"rtept");if(I)return{type:"Feature",properties:Object.assign(u(g),J(y(g,"extensions")),{_gpxType:"rte"}),geometry:{type:"LineString",coordinates:I.line}}}function p(g,I){const C=g.getElementsByTagName(I);if(C.length<2)return;const A=[],l=[],b={};for(let g=0;g<C.length;g++){const I=k(C[g]);A.push(I.coordinates),I.time&&l.push(I.time);for(let A=0;A<I.extendedValues.length;A++){const[l,c]=I.extendedValues[A],Z="heart"===l?l:l+"s";b[Z]||(b[Z]=Array(C.length).fill(null)),b[Z][g]=c}}return{line:A,times:l,extendedValues:b}}function K(g){const I=g.getElementsByTagName("trkseg"),C=[],A=[],l=[];for(let g=0;g<I.length;g++){const C=p(I[g],"trkpt");C&&(l.push(C),C.times&&C.times.length&&A.push(C.times))}if(0===l.length)return;const b=l.length>1,c=Object.assign(u(g),J(y(g,"extensions")),{_gpxType:"trk"},A.length?{coordinateProperties:{times:b?A:A[0]}}:{});for(let g=0;g<l.length;g++){const I=l[g];C.push(I.line);for(const[C,A]of Object.entries(I.extendedValues)){let I=c;"heart"===C&&(c.coordinateProperties||(c.coordinateProperties={}),I=c.coordinateProperties),b?(I[C]||(I[C]=l.map((g=>new Array(g.line.length).fill(null)))),I[C][g]=A):I[C]=A}}return{type:"Feature",properties:c,geometry:b?{type:"MultiLineString",coordinates:C}:{type:"LineString",coordinates:C[0]}}}function*X(g){const I=g.getElementsByTagName("trk"),C=g.getElementsByTagName("rte"),A=g.getElementsByTagName("wpt");for(let g=0;g<I.length;g++){const C=K(I[g]);C&&(yield C)}for(let g=0;g<C.length;g++){const I=H(C[g]);I&&(yield I)}for(let g=0;g<A.length;g++)yield(l=A[g],{type:"Feature",properties:Object.assign(u(l),S(l,["sym"])),geometry:{type:"Point",coordinates:k(l).coordinates}});var l}Object.defineProperty(a,"__esModule",{value:!0});const h=[["heartRate","heartRates"],["Cadence","cadences"],["Speed","speeds"],["Watts","watts"]],r=[["TotalTimeSeconds","totalTimeSeconds"],["DistanceMeters","distanceMeters"],["MaximumSpeed","maxSpeed"],["AverageHeartRateBpm","avgHeartRate"],["MaximumHeartRateBpm","maxHeartRate"],["AvgSpeed","avgSpeed"],["AvgWatts","avgWatts"],["MaxWatts","maxWatts"]];function R(g,I){const C=[];for(const[A,l]of I){let I=y(g,A);if(!I){const C=g.getElementsByTagNameNS("http://www.garmin.com/xmlschemas/ActivityExtension/v2",A);C.length&&(I=C[0])}const b=parseFloat(V(I));isNaN(b)||C.push([l,b])}return C}function w(g){const I=V(y(g,"LongitudeDegrees")),C=V(y(g,"LatitudeDegrees"));if(!I.length||!C.length)return null;const A=[parseFloat(I),parseFloat(C)],l=y(g,"AltitudeMeters"),b=y(g,"HeartRateBpm"),c=y(g,"Time");let Z;return l&&(Z=parseFloat(V(l)),isNaN(Z)||A.push(Z)),{coordinates:A,time:c?V(c):null,heartRate:b?parseFloat(V(b)):null,extensions:R(g,h)}}function Y(g,I){const C=g.getElementsByTagName(I),A=[],l=[],b=[];if(C.length<2)return null;const c={extendedProperties:{}};for(let g=0;g<C.length;g++){const I=w(C[g]);if(null!==I){A.push(I.coordinates),I.time&&l.push(I.time),I.heartRate&&b.push(I.heartRate);for(const[A,l]of I.extensions)c.extendedProperties[A]||(c.extendedProperties[A]=Array(C.length).fill(null)),c.extendedProperties[A][g]=l}}return Object.assign(c,{line:A,times:l,heartRates:b})}function v(g){const I=g.getElementsByTagName("Track"),C=[],A=[],l=[],b=[];let c;const Z=function(g){const I={};for(const[C,A]of g)I[C]=A;return I}(R(g,r)),o=y(g,"Name");o&&(Z.name=V(o));for(let g=0;g<I.length;g++)c=Y(I[g],"Trackpoint"),c&&(C.push(c.line),c.times.length&&A.push(c.times),c.heartRates.length&&l.push(c.heartRates),b.push(c.extendedProperties));for(let g=0;g<b.length;g++){const A=b[g];for(const l in A)1===I.length?Z[l]=c.extendedProperties[l]:(Z[l]||(Z[l]=C.map((g=>Array(g.length).fill(null)))),Z[l][g]=A[l])}if(0!==C.length)return(A.length||l.length)&&(Z.coordinateProperties=Object.assign(A.length?{times:1===C.length?A[0]:A}:{},l.length?{heart:1===C.length?l[0]:l}:{})),{type:"Feature",properties:Z,geometry:{type:1===C.length?"LineString":"MultiLineString",coordinates:1===C.length?C[0]:C}}}function*N(g){const I=g.getElementsByTagName("Lap");for(let g=0;g<I.length;g++){const C=v(I[g]);C&&(yield C)}const C=g.getElementsByTagName("Courses");for(let g=0;g<C.length;g++){const I=v(C[g]);I&&(yield I)}}const F=/\s*/g,z=/^\s*|\s*$/g,x=/\s+/;function f(g){if(!g||!g.length)return 0;let I=0;for(let C=0;C<g.length;C++)I=(I<<5)-I+g.charCodeAt(C)|0;return I}function Q(g){return g.replace(F,"").split(",").map(parseFloat)}function L(g){return g.replace(z,"").split(x).map(Q)}function T(g){if(void 0!==g.xml)return g.xml;if(g.tagName){let I=g.tagName;for(let C=0;C<g.attributes.length;C++)I+=g.attributes[C].name+g.attributes[C].value;for(let C=0;C<g.childNodes.length;C++)I+=T(g.childNodes[C]);return I}return"#text"===g.nodeName?(g.nodeValue||g.value||"").trim():"#cdata-section"===g.nodeName?g.nodeValue:""}const D=["Polygon","LineString","Point","Track","gx:Track"];function U(g,I,C){let A=V(y(I,"color"))||"";const l="stroke"==C||"fill"===C?C:C+"-color";"#"===A.substr(0,1)&&(A=A.substr(1)),6===A.length||3===A.length?g[l]=A:8===A.length&&(g[C+"-opacity"]=parseInt(A.substr(0,2),16)/255,g[l]="#"+A.substr(6,2)+A.substr(4,2)+A.substr(2,2))}function M(g,I,C,A){const l=parseFloat(V(y(I,C)));isNaN(l)||(g[A]=l)}function O(g){let I=g.getElementsByTagName("coord");const C=[],A=[];0===I.length&&(I=g.getElementsByTagName("gx:coord"));for(let g=0;g<I.length;g++)C.push(V(I[g]).split(" ").map(parseFloat));const l=g.getElementsByTagName("when");for(let g=0;g<l.length;g++)A.push(V(l[g]));return{coords:C,times:A}}function j(g){let I,C,A,l,b;const c=[],Z=[];if(y(g,"MultiGeometry"))return j(y(g,"MultiGeometry"));if(y(g,"MultiTrack"))return j(y(g,"MultiTrack"));if(y(g,"gx:MultiTrack"))return j(y(g,"gx:MultiTrack"));for(A=0;A<D.length;A++)if(C=g.getElementsByTagName(D[A]),C)for(l=0;l<C.length;l++)if(I=C[l],"Point"===D[A])c.push({type:"Point",coordinates:Q(V(y(I,"coordinates")))});else if("LineString"===D[A])c.push({type:"LineString",coordinates:L(V(y(I,"coordinates")))});else if("Polygon"===D[A]){const g=I.getElementsByTagName("LinearRing"),C=[];for(b=0;b<g.length;b++)C.push(L(V(y(g[b],"coordinates"))));c.push({type:"Polygon",coordinates:C})}else if("Track"===D[A]||"gx:Track"===D[A]){const g=O(I);c.push({type:"LineString",coordinates:g.coords}),g.times.length&&Z.push(g.times)}return{geoms:c,coordTimes:Z}}function P(g,I,C,A){const l=j(g);let b;const c={},Z=V(y(g,"name")),o=V(y(g,"address"));let d=V(y(g,"styleUrl"));const e=V(y(g,"description")),G=y(g,"TimeSpan"),t=y(g,"TimeStamp"),s=y(g,"ExtendedData");let n=y(g,"IconStyle"),m=y(g,"LabelStyle"),W=y(g,"LineStyle"),B=y(g,"PolyStyle");const i=y(g,"visibility");if(Z&&(c.name=Z),o&&(c.address=o),d){"#"!==d[0]&&(d="#"+d),c.styleUrl=d,I[d]&&(c.styleHash=I[d]),C[d]&&(c.styleMapHash=C[d],c.styleHash=I[C[d].normal]);const g=A[c.styleHash];g&&(n||(n=y(g,"IconStyle")),m||(m=y(g,"LabelStyle")),W||(W=y(g,"LineStyle")),B||(B=y(g,"PolyStyle")))}if(e&&(c.description=e),G){const g=V(y(G,"begin")),I=V(y(G,"end"));c.timespan={begin:g,end:I}}if(t&&(c.timestamp=V(y(t,"when"))),n){U(c,n,"icon"),M(c,n,"scale","icon-scale"),M(c,n,"heading","icon-heading");const g=y(n,"hotSpot");if(g){const I=parseFloat(g.getAttribute("x")),C=parseFloat(g.getAttribute("y"));isNaN(I)||isNaN(C)||(c["icon-offset"]=[I,C])}const I=y(n,"Icon");if(I){const g=V(y(I,"href"));g&&(c.icon=g)}}if(m&&(U(c,m,"label"),M(c,m,"scale","label-scale")),W&&(U(c,W,"stroke"),M(c,W,"width","stroke-width")),B){U(c,B,"fill");const g=V(y(B,"fill")),I=V(y(B,"outline"));g&&(c["fill-opacity"]="1"===g?c["fill-opacity"]||1:0),I&&(c["stroke-opacity"]="1"===I?c["stroke-opacity"]||1:0)}if(s){const g=s.getElementsByTagName("Data"),I=s.getElementsByTagName("SimpleData");for(b=0;b<g.length;b++)c[g[b].getAttribute("name")]=V(y(g[b],"value"));for(b=0;b<I.length;b++)c[I[b].getAttribute("name")]=V(I[b])}i&&(c.visibility=V(i)),l.coordTimes.length&&(c.coordinateProperties={times:1===l.coordTimes.length?l.coordTimes[0]:l.coordTimes});const a={type:"Feature",geometry:0===l.geoms.length?null:1===l.geoms.length?l.geoms[0]:{type:"GeometryCollection",geometries:l.geoms},properties:c};return g.getAttribute("id")&&(a.id=g.getAttribute("id")),a}function*E(g){const I={},C={},A={},l=g.getElementsByTagName("Placemark"),b=g.getElementsByTagName("Style"),c=g.getElementsByTagName("StyleMap");for(let g=0;g<b.length;g++){const A=f(T(b[g])).toString(16);I["#"+b[g].getAttribute("id")]=A,C[A]=b[g]}for(let g=0;g<c.length;g++){I["#"+c[g].getAttribute("id")]=f(T(c[g])).toString(16);const C=c[g].getElementsByTagName("Pair"),l={};for(let g=0;g<C.length;g++)l[V(y(C[g],"key"))]=V(y(C[g],"styleUrl"));A["#"+c[g].getAttribute("id")]=l}for(let g=0;g<l.length;g++){const b=P(l[g],I,A,C);b&&(yield b)}}var q=a.gpx=function(g){return{type:"FeatureCollection",features:Array.from(X(g))}},_=a.gpxGen=X,$=a.kml=function(g){return{type:"FeatureCollection",features:Array.from(E(g))}},gg=a.kmlGen=E,Ig=a.tcx=function(g){return{type:"FeatureCollection",features:Array.from(N(g))}},Cg=a.tcxGen=N,Ag=Object.freeze(I({__proto__:null,gpx:q,gpxGen:_,kml:$,kmlGen:gg,tcx:Ig,tcxGen:Cg,default:a},[a]));const lg=["topojson","kml","gpx","tcx","csv","tsv"];class bg{constructor(g,I){this.blankGeoJSON=()=>({type:"FeatureCollection",features:[]}),this._rawData=I,this._format=g;const C={topojson:this.loadTopoJson,kml:this.loadXml,gpx:this.loadXml,tcx:this.loadXml,csv:this.loadCsv,tsv:this.loadCsv};this._conversionFn=C[g]}async convert(){return this._conversionFn?this._conversionFn():new Promise(((g,I)=>I(`No converter exists for ${this._format}`)))}async loadXml(){return Ag[this._format]((new DOMParser).parseFromString(this._rawData,"text/xml"))}async loadCsv(){let g=this.blankGeoJSON(),I={};return"tsv"===this._format&&(I.delimiter="\t"),g=await new Promise(((g,C)=>{W.csv2geojson(this._rawData,I,((I,A)=>I?C(I):g(A)))})),g}async loadTopoJson(){let g={};try{g=JSON.parse(this._rawData)}catch(g){throw"Invalid TopoJson"}let I=this.blankGeoJSON();return"Topology"===g.type&&void 0!==g.objects&&(I={type:"FeatureCollection",features:I.features=Object.keys(g.objects).map((I=>{return C=g,"string"==typeof(A=I)&&(A=C.objects[A]),"GeometryCollection"===A.type?{type:"FeatureCollection",features:A.geometries.map((function(g){return i(C,g)}))}:i(C,A);var C,A})).reduce(((g,I)=>[...g,...I.features]),[])}),I}}var cg=null;try{var Zg="undefined"!=typeof module&&"function"==typeof module.require&&module.require("worker_threads")||"function"==typeof __non_webpack_require__&&__non_webpack_require__("worker_threads")||"function"==typeof require&&require("worker_threads");cg=Zg.Worker}catch(g){}function og(g,I,C){var A=void 0===I?null:I,l=function(g,I){return Buffer.from(g,"base64").toString(I?"utf16":"utf8")}(g,void 0!==C&&C),b=l.indexOf("\n",10)+1,c=l.substring(b)+(A?"//# sourceMappingURL="+A:"");return function(g){return new cg(c,Object.assign({},g,{eval:!0}))}}function dg(g,I,C){var A=void 0===I?null:I,l=function(g,I){var C=atob(g);if(I){for(var A=new Uint8Array(C.length),l=0,b=C.length;l<b;++l)A[l]=C.charCodeAt(l);return String.fromCharCode.apply(null,new Uint16Array(A.buffer))}return C}(g,void 0!==C&&C),b=l.indexOf("\n",10)+1,c=l.substring(b)+(A?"//# sourceMappingURL="+A:""),Z=new Blob([c],{type:"application/javascript"});return URL.createObjectURL(Z)}var eg="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);var Gg,tg,sg,ng=(Gg="Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewoJJ3VzZSBzdHJpY3QnOwoKCWZ1bmN0aW9uIF9tZXJnZU5hbWVzcGFjZXMobiwgbSkgewoJCW0uZm9yRWFjaChmdW5jdGlvbiAoZSkgewoJCQllICYmIHR5cGVvZiBlICE9PSAnc3RyaW5nJyAmJiAhQXJyYXkuaXNBcnJheShlKSAmJiBPYmplY3Qua2V5cyhlKS5mb3JFYWNoKGZ1bmN0aW9uIChrKSB7CgkJCQlpZiAoayAhPT0gJ2RlZmF1bHQnICYmICEoayBpbiBuKSkgewoJCQkJCXZhciBkID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCBrKTsKCQkJCQlPYmplY3QuZGVmaW5lUHJvcGVydHkobiwgaywgZC5nZXQgPyBkIDogewoJCQkJCQllbnVtZXJhYmxlOiB0cnVlLAoJCQkJCQlnZXQ6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIGVba107IH0KCQkJCQl9KTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIE9iamVjdC5mcmVlemUobik7Cgl9CgoJdmFyIGNvbW1vbmpzR2xvYmFsID0gdHlwZW9mIGdsb2JhbFRoaXMgIT09ICd1bmRlZmluZWQnID8gZ2xvYmFsVGhpcyA6IHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnID8gd2luZG93IDogdHlwZW9mIGdsb2JhbCAhPT0gJ3VuZGVmaW5lZCcgPyBnbG9iYWwgOiB0eXBlb2Ygc2VsZiAhPT0gJ3VuZGVmaW5lZCcgPyBzZWxmIDoge307CgoJdmFyIGQzRHN2ID0ge2V4cG9ydHM6IHt9fTsKCgkoZnVuY3Rpb24gKG1vZHVsZSwgZXhwb3J0cykgewoJLy8gaHR0cHM6Ly9kM2pzLm9yZy9kMy1kc3YvIFZlcnNpb24gMS4wLjEuIENvcHlyaWdodCAyMDE2IE1pa2UgQm9zdG9jay4KCShmdW5jdGlvbiAoZ2xvYmFsLCBmYWN0b3J5KSB7CgkgIGZhY3RvcnkoZXhwb3J0cykgOwoJfShjb21tb25qc0dsb2JhbCwgZnVuY3Rpb24gKGV4cG9ydHMpIHsKCSAgZnVuY3Rpb24gb2JqZWN0Q29udmVydGVyKGNvbHVtbnMpIHsKCSAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKCJkIiwgInJldHVybiB7IiArIGNvbHVtbnMubWFwKGZ1bmN0aW9uKG5hbWUsIGkpIHsKCSAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShuYW1lKSArICI6IGRbIiArIGkgKyAiXSI7CgkgICAgfSkuam9pbigiLCIpICsgIn0iKTsKCSAgfQoKCSAgZnVuY3Rpb24gY3VzdG9tQ29udmVydGVyKGNvbHVtbnMsIGYpIHsKCSAgICB2YXIgb2JqZWN0ID0gb2JqZWN0Q29udmVydGVyKGNvbHVtbnMpOwoJICAgIHJldHVybiBmdW5jdGlvbihyb3csIGkpIHsKCSAgICAgIHJldHVybiBmKG9iamVjdChyb3cpLCBpLCBjb2x1bW5zKTsKCSAgICB9OwoJICB9CgoJICAvLyBDb21wdXRlIHVuaXF1ZSBjb2x1bW5zIGluIG9yZGVyIG9mIGRpc2NvdmVyeS4KCSAgZnVuY3Rpb24gaW5mZXJDb2x1bW5zKHJvd3MpIHsKCSAgICB2YXIgY29sdW1uU2V0ID0gT2JqZWN0LmNyZWF0ZShudWxsKSwKCSAgICAgICAgY29sdW1ucyA9IFtdOwoKCSAgICByb3dzLmZvckVhY2goZnVuY3Rpb24ocm93KSB7CgkgICAgICBmb3IgKHZhciBjb2x1bW4gaW4gcm93KSB7CgkgICAgICAgIGlmICghKGNvbHVtbiBpbiBjb2x1bW5TZXQpKSB7CgkgICAgICAgICAgY29sdW1ucy5wdXNoKGNvbHVtblNldFtjb2x1bW5dID0gY29sdW1uKTsKCSAgICAgICAgfQoJICAgICAgfQoJICAgIH0pOwoKCSAgICByZXR1cm4gY29sdW1uczsKCSAgfQoKCSAgZnVuY3Rpb24gZHN2KGRlbGltaXRlcikgewoJICAgIHZhciByZUZvcm1hdCA9IG5ldyBSZWdFeHAoIltcIiIgKyBkZWxpbWl0ZXIgKyAiXG5dIiksCgkgICAgICAgIGRlbGltaXRlckNvZGUgPSBkZWxpbWl0ZXIuY2hhckNvZGVBdCgwKTsKCgkgICAgZnVuY3Rpb24gcGFyc2UodGV4dCwgZikgewoJICAgICAgdmFyIGNvbnZlcnQsIGNvbHVtbnMsIHJvd3MgPSBwYXJzZVJvd3ModGV4dCwgZnVuY3Rpb24ocm93LCBpKSB7CgkgICAgICAgIGlmIChjb252ZXJ0KSByZXR1cm4gY29udmVydChyb3csIGkgLSAxKTsKCSAgICAgICAgY29sdW1ucyA9IHJvdywgY29udmVydCA9IGYgPyBjdXN0b21Db252ZXJ0ZXIocm93LCBmKSA6IG9iamVjdENvbnZlcnRlcihyb3cpOwoJICAgICAgfSk7CgkgICAgICByb3dzLmNvbHVtbnMgPSBjb2x1bW5zOwoJICAgICAgcmV0dXJuIHJvd3M7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBwYXJzZVJvd3ModGV4dCwgZikgewoJICAgICAgdmFyIEVPTCA9IHt9LCAvLyBzZW50aW5lbCB2YWx1ZSBmb3IgZW5kLW9mLWxpbmUKCSAgICAgICAgICBFT0YgPSB7fSwgLy8gc2VudGluZWwgdmFsdWUgZm9yIGVuZC1vZi1maWxlCgkgICAgICAgICAgcm93cyA9IFtdLCAvLyBvdXRwdXQgcm93cwoJICAgICAgICAgIE4gPSB0ZXh0Lmxlbmd0aCwKCSAgICAgICAgICBJID0gMCwgLy8gY3VycmVudCBjaGFyYWN0ZXIgaW5kZXgKCSAgICAgICAgICBuID0gMCwgLy8gdGhlIGN1cnJlbnQgbGluZSBudW1iZXIKCSAgICAgICAgICB0LCAvLyB0aGUgY3VycmVudCB0b2tlbgoJICAgICAgICAgIGVvbDsgLy8gaXMgdGhlIGN1cnJlbnQgdG9rZW4gZm9sbG93ZWQgYnkgRU9MPwoKCSAgICAgIGZ1bmN0aW9uIHRva2VuKCkgewoJICAgICAgICBpZiAoSSA+PSBOKSByZXR1cm4gRU9GOyAvLyBzcGVjaWFsIGNhc2U6IGVuZCBvZiBmaWxlCgkgICAgICAgIGlmIChlb2wpIHJldHVybiBlb2wgPSBmYWxzZSwgRU9MOyAvLyBzcGVjaWFsIGNhc2U6IGVuZCBvZiBsaW5lCgoJICAgICAgICAvLyBzcGVjaWFsIGNhc2U6IHF1b3RlcwoJICAgICAgICB2YXIgaiA9IEksIGM7CgkgICAgICAgIGlmICh0ZXh0LmNoYXJDb2RlQXQoaikgPT09IDM0KSB7CgkgICAgICAgICAgdmFyIGkgPSBqOwoJICAgICAgICAgIHdoaWxlIChpKysgPCBOKSB7CgkgICAgICAgICAgICBpZiAodGV4dC5jaGFyQ29kZUF0KGkpID09PSAzNCkgewoJICAgICAgICAgICAgICBpZiAodGV4dC5jaGFyQ29kZUF0KGkgKyAxKSAhPT0gMzQpIGJyZWFrOwoJICAgICAgICAgICAgICArK2k7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgfQoJICAgICAgICAgIEkgPSBpICsgMjsKCSAgICAgICAgICBjID0gdGV4dC5jaGFyQ29kZUF0KGkgKyAxKTsKCSAgICAgICAgICBpZiAoYyA9PT0gMTMpIHsKCSAgICAgICAgICAgIGVvbCA9IHRydWU7CgkgICAgICAgICAgICBpZiAodGV4dC5jaGFyQ29kZUF0KGkgKyAyKSA9PT0gMTApICsrSTsKCSAgICAgICAgICB9IGVsc2UgaWYgKGMgPT09IDEwKSB7CgkgICAgICAgICAgICBlb2wgPSB0cnVlOwoJICAgICAgICAgIH0KCSAgICAgICAgICByZXR1cm4gdGV4dC5zbGljZShqICsgMSwgaSkucmVwbGFjZSgvIiIvZywgIlwiIik7CgkgICAgICAgIH0KCgkgICAgICAgIC8vIGNvbW1vbiBjYXNlOiBmaW5kIG5leHQgZGVsaW1pdGVyIG9yIG5ld2xpbmUKCSAgICAgICAgd2hpbGUgKEkgPCBOKSB7CgkgICAgICAgICAgdmFyIGsgPSAxOwoJICAgICAgICAgIGMgPSB0ZXh0LmNoYXJDb2RlQXQoSSsrKTsKCSAgICAgICAgICBpZiAoYyA9PT0gMTApIGVvbCA9IHRydWU7IC8vIFxuCgkgICAgICAgICAgZWxzZSBpZiAoYyA9PT0gMTMpIHsgZW9sID0gdHJ1ZTsgaWYgKHRleHQuY2hhckNvZGVBdChJKSA9PT0gMTApICsrSSwgKytrOyB9IC8vIFxyfFxyXG4KCSAgICAgICAgICBlbHNlIGlmIChjICE9PSBkZWxpbWl0ZXJDb2RlKSBjb250aW51ZTsKCSAgICAgICAgICByZXR1cm4gdGV4dC5zbGljZShqLCBJIC0gayk7CgkgICAgICAgIH0KCgkgICAgICAgIC8vIHNwZWNpYWwgY2FzZTogbGFzdCB0b2tlbiBiZWZvcmUgRU9GCgkgICAgICAgIHJldHVybiB0ZXh0LnNsaWNlKGopOwoJICAgICAgfQoKCSAgICAgIHdoaWxlICgodCA9IHRva2VuKCkpICE9PSBFT0YpIHsKCSAgICAgICAgdmFyIGEgPSBbXTsKCSAgICAgICAgd2hpbGUgKHQgIT09IEVPTCAmJiB0ICE9PSBFT0YpIHsKCSAgICAgICAgICBhLnB1c2godCk7CgkgICAgICAgICAgdCA9IHRva2VuKCk7CgkgICAgICAgIH0KCSAgICAgICAgaWYgKGYgJiYgKGEgPSBmKGEsIG4rKykpID09IG51bGwpIGNvbnRpbnVlOwoJICAgICAgICByb3dzLnB1c2goYSk7CgkgICAgICB9CgoJICAgICAgcmV0dXJuIHJvd3M7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBmb3JtYXQocm93cywgY29sdW1ucykgewoJICAgICAgaWYgKGNvbHVtbnMgPT0gbnVsbCkgY29sdW1ucyA9IGluZmVyQ29sdW1ucyhyb3dzKTsKCSAgICAgIHJldHVybiBbY29sdW1ucy5tYXAoZm9ybWF0VmFsdWUpLmpvaW4oZGVsaW1pdGVyKV0uY29uY2F0KHJvd3MubWFwKGZ1bmN0aW9uKHJvdykgewoJICAgICAgICByZXR1cm4gY29sdW1ucy5tYXAoZnVuY3Rpb24oY29sdW1uKSB7CgkgICAgICAgICAgcmV0dXJuIGZvcm1hdFZhbHVlKHJvd1tjb2x1bW5dKTsKCSAgICAgICAgfSkuam9pbihkZWxpbWl0ZXIpOwoJICAgICAgfSkpLmpvaW4oIlxuIik7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBmb3JtYXRSb3dzKHJvd3MpIHsKCSAgICAgIHJldHVybiByb3dzLm1hcChmb3JtYXRSb3cpLmpvaW4oIlxuIik7CgkgICAgfQoKCSAgICBmdW5jdGlvbiBmb3JtYXRSb3cocm93KSB7CgkgICAgICByZXR1cm4gcm93Lm1hcChmb3JtYXRWYWx1ZSkuam9pbihkZWxpbWl0ZXIpOwoJICAgIH0KCgkgICAgZnVuY3Rpb24gZm9ybWF0VmFsdWUodGV4dCkgewoJICAgICAgcmV0dXJuIHRleHQgPT0gbnVsbCA/ICIiCgkgICAgICAgICAgOiByZUZvcm1hdC50ZXN0KHRleHQgKz0gIiIpID8gIlwiIiArIHRleHQucmVwbGFjZSgvXCIvZywgIlwiXCIiKSArICJcIiIKCSAgICAgICAgICA6IHRleHQ7CgkgICAgfQoKCSAgICByZXR1cm4gewoJICAgICAgcGFyc2U6IHBhcnNlLAoJICAgICAgcGFyc2VSb3dzOiBwYXJzZVJvd3MsCgkgICAgICBmb3JtYXQ6IGZvcm1hdCwKCSAgICAgIGZvcm1hdFJvd3M6IGZvcm1hdFJvd3MKCSAgICB9OwoJICB9CgoJICB2YXIgY3N2ID0gZHN2KCIsIik7CgoJICB2YXIgY3N2UGFyc2UgPSBjc3YucGFyc2U7CgkgIHZhciBjc3ZQYXJzZVJvd3MgPSBjc3YucGFyc2VSb3dzOwoJICB2YXIgY3N2Rm9ybWF0ID0gY3N2LmZvcm1hdDsKCSAgdmFyIGNzdkZvcm1hdFJvd3MgPSBjc3YuZm9ybWF0Um93czsKCgkgIHZhciB0c3YgPSBkc3YoIlx0Iik7CgoJICB2YXIgdHN2UGFyc2UgPSB0c3YucGFyc2U7CgkgIHZhciB0c3ZQYXJzZVJvd3MgPSB0c3YucGFyc2VSb3dzOwoJICB2YXIgdHN2Rm9ybWF0ID0gdHN2LmZvcm1hdDsKCSAgdmFyIHRzdkZvcm1hdFJvd3MgPSB0c3YuZm9ybWF0Um93czsKCgkgIGV4cG9ydHMuZHN2Rm9ybWF0ID0gZHN2OwoJICBleHBvcnRzLmNzdlBhcnNlID0gY3N2UGFyc2U7CgkgIGV4cG9ydHMuY3N2UGFyc2VSb3dzID0gY3N2UGFyc2VSb3dzOwoJICBleHBvcnRzLmNzdkZvcm1hdCA9IGNzdkZvcm1hdDsKCSAgZXhwb3J0cy5jc3ZGb3JtYXRSb3dzID0gY3N2Rm9ybWF0Um93czsKCSAgZXhwb3J0cy50c3ZQYXJzZSA9IHRzdlBhcnNlOwoJICBleHBvcnRzLnRzdlBhcnNlUm93cyA9IHRzdlBhcnNlUm93czsKCSAgZXhwb3J0cy50c3ZGb3JtYXQgPSB0c3ZGb3JtYXQ7CgkgIGV4cG9ydHMudHN2Rm9ybWF0Um93cyA9IHRzdkZvcm1hdFJvd3M7CgoJICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7IHZhbHVlOiB0cnVlIH0pOwoKCX0pKTsKCX0oZDNEc3YsIGQzRHN2LmV4cG9ydHMpKTsKCgl2YXIgc2V4YWdlc2ltYWwkMSA9IHtleHBvcnRzOiB7fX07CgoJc2V4YWdlc2ltYWwkMS5leHBvcnRzID0gZWxlbWVudDsKCXNleGFnZXNpbWFsJDEuZXhwb3J0cy5wYWlyID0gcGFpcjsKCXNleGFnZXNpbWFsJDEuZXhwb3J0cy5mb3JtYXQgPSBmb3JtYXQ7CglzZXhhZ2VzaW1hbCQxLmV4cG9ydHMuZm9ybWF0UGFpciA9IGZvcm1hdFBhaXI7CglzZXhhZ2VzaW1hbCQxLmV4cG9ydHMuY29vcmRUb0RNUyA9IGNvb3JkVG9ETVM7CgoKCWZ1bmN0aW9uIGVsZW1lbnQoaW5wdXQsIGRpbXMpIHsKCSAgdmFyIHJlc3VsdCA9IHNlYXJjaChpbnB1dCwgZGltcyk7CgkgIHJldHVybiAocmVzdWx0ID09PSBudWxsKSA/IG51bGwgOiByZXN1bHQudmFsOwoJfQoKCglmdW5jdGlvbiBmb3JtYXRQYWlyKGlucHV0KSB7CgkgIHJldHVybiBmb3JtYXQoaW5wdXQubGF0LCAnbGF0JykgKyAnICcgKyBmb3JtYXQoaW5wdXQubG9uLCAnbG9uJyk7Cgl9CgoKCS8vIElzIDAgTm9ydGggb3IgU291dGg/CglmdW5jdGlvbiBmb3JtYXQoaW5wdXQsIGRpbSkgewoJICB2YXIgZG1zID0gY29vcmRUb0RNUyhpbnB1dCwgZGltKTsKCSAgcmV0dXJuIGRtcy53aG9sZSArICfCsCAnICsKCSAgICAoZG1zLm1pbnV0ZXMgPyBkbXMubWludXRlcyArICdcJyAnIDogJycpICsKCSAgICAoZG1zLnNlY29uZHMgPyBkbXMuc2Vjb25kcyArICciICcgOiAnJykgKyBkbXMuZGlyOwoJfQoKCglmdW5jdGlvbiBjb29yZFRvRE1TKGlucHV0LCBkaW0pIHsKCSAgdmFyIGRpcnMgPSB7IGxhdDogWydOJywgJ1MnXSwgbG9uOiBbJ0UnLCAnVyddIH1bZGltXSB8fCAnJzsKCSAgdmFyIGRpciA9IGRpcnNbaW5wdXQgPj0gMCA/IDAgOiAxXTsKCSAgdmFyIGFicyA9IE1hdGguYWJzKGlucHV0KTsKCSAgdmFyIHdob2xlID0gTWF0aC5mbG9vcihhYnMpOwoJICB2YXIgZnJhY3Rpb24gPSBhYnMgLSB3aG9sZTsKCSAgdmFyIGZyYWN0aW9uTWludXRlcyA9IGZyYWN0aW9uICogNjA7CgkgIHZhciBtaW51dGVzID0gTWF0aC5mbG9vcihmcmFjdGlvbk1pbnV0ZXMpOwoJICB2YXIgc2Vjb25kcyA9IE1hdGguZmxvb3IoKGZyYWN0aW9uTWludXRlcyAtIG1pbnV0ZXMpICogNjApOwoKCSAgcmV0dXJuIHsKCSAgICB3aG9sZTogd2hvbGUsCgkgICAgbWludXRlczogbWludXRlcywKCSAgICBzZWNvbmRzOiBzZWNvbmRzLAoJICAgIGRpcjogZGlyCgkgIH07Cgl9CgoKCWZ1bmN0aW9uIHNlYXJjaChpbnB1dCwgZGltcykgewoJICBpZiAoIWRpbXMpIGRpbXMgPSAnTlNFVyc7CgkgIGlmICh0eXBlb2YgaW5wdXQgIT09ICdzdHJpbmcnKSByZXR1cm4gbnVsbDsKCgkgIGlucHV0ID0gaW5wdXQudG9VcHBlckNhc2UoKTsKCSAgdmFyIHJlZ2V4ID0gL15bXHNcLF0qKFtOU0VXXSk/XHMqKFtcLXxc4oCUfFzigJVdP1swLTkuXSspW8KwwrrLml0/XHMqKD86KFswLTkuXSspWyfigJnigLLigJhdXHMqKT8oPzooWzAtOS5dKykoPzonJ3wifOKAnXzigLMpXHMqKT8oW05TRVddKT8vOwoKCSAgdmFyIG0gPSBpbnB1dC5tYXRjaChyZWdleCk7CgkgIGlmICghbSkgcmV0dXJuIG51bGw7ICAvLyBubyBtYXRjaAoKCSAgdmFyIG1hdGNoZWQgPSBtWzBdOwoKCSAgLy8gZXh0cmFjdCBkaW1lbnNpb24uLiBtWzFdID0gbGVhZGluZywgbVs1XSA9IHRyYWlsaW5nCgkgIHZhciBkaW07CgkgIGlmIChtWzFdICYmIG1bNV0pIHsgICAgICAgICAgICAgICAgIC8vIGlmIG1hdGNoZWQgYm90aC4uCgkgICAgZGltID0gbVsxXTsgICAgICAgICAgICAgICAgICAgICAgIC8vIGtlZXAgbGVhZGluZwoJICAgIG1hdGNoZWQgPSBtYXRjaGVkLnNsaWNlKDAsIC0xKTsgICAvLyByZW1vdmUgdHJhaWxpbmcgZGltZW5zaW9uIGZyb20gbWF0Y2gKCSAgfSBlbHNlIHsKCSAgICBkaW0gPSBtWzFdIHx8IG1bNV07CgkgIH0KCgkgIC8vIGlmIHVucmVjb2duaXplZCBkaW1lbnNpb24KCSAgaWYgKGRpbSAmJiBkaW1zLmluZGV4T2YoZGltKSA9PT0gLTEpIHJldHVybiBudWxsOwoKCSAgLy8gZXh0cmFjdCBETVMKCSAgdmFyIGRlZyA9IG1bMl0gPyBwYXJzZUZsb2F0KG1bMl0pIDogMDsKCSAgdmFyIG1pbiA9IG1bM10gPyBwYXJzZUZsb2F0KG1bM10pIC8gNjAgOiAwOwoJICB2YXIgc2VjID0gbVs0XSA/IHBhcnNlRmxvYXQobVs0XSkgLyAzNjAwIDogMDsKCSAgdmFyIHNpZ24gPSAoZGVnIDwgMCkgPyAtMSA6IDE7CgkgIGlmIChkaW0gPT09ICdTJyB8fCBkaW0gPT09ICdXJykgc2lnbiAqPSAtMTsKCgkgIHJldHVybiB7CgkgICAgdmFsOiAoTWF0aC5hYnMoZGVnKSArIG1pbiArIHNlYykgKiBzaWduLAoJICAgIGRpbTogZGltLAoJICAgIG1hdGNoZWQ6IG1hdGNoZWQsCgkgICAgcmVtYWluOiBpbnB1dC5zbGljZShtYXRjaGVkLmxlbmd0aCkKCSAgfTsKCX0KCgoJZnVuY3Rpb24gcGFpcihpbnB1dCwgZGltcykgewoJICBpbnB1dCA9IGlucHV0LnRyaW0oKTsKCSAgdmFyIG9uZSA9IHNlYXJjaChpbnB1dCwgZGltcyk7CgkgIGlmICghb25lKSByZXR1cm4gbnVsbDsKCgkgIGlucHV0ID0gb25lLnJlbWFpbi50cmltKCk7CgkgIHZhciB0d28gPSBzZWFyY2goaW5wdXQsIGRpbXMpOwoJICBpZiAoIXR3byB8fCB0d28ucmVtYWluKSByZXR1cm4gbnVsbDsKCgkgIGlmIChvbmUuZGltKSB7CgkgICAgcmV0dXJuIHN3YXBkaW0ob25lLnZhbCwgdHdvLnZhbCwgb25lLmRpbSk7CgkgIH0gZWxzZSB7CgkgICAgcmV0dXJuIFtvbmUudmFsLCB0d28udmFsXTsKCSAgfQoJfQoKCglmdW5jdGlvbiBzd2FwZGltKGEsIGIsIGRpbSkgewoJICBpZiAoZGltID09PSAnTicgfHwgZGltID09PSAnUycpIHJldHVybiBbYSwgYl07CgkgIGlmIChkaW0gPT09ICdXJyB8fCBkaW0gPT09ICdFJykgcmV0dXJuIFtiLCBhXTsKCX0KCgl2YXIgZHN2ID0gZDNEc3YuZXhwb3J0cywKCSAgICBzZXhhZ2VzaW1hbCA9IHNleGFnZXNpbWFsJDEuZXhwb3J0czsKCgl2YXIgbGF0UmVnZXggPSAvKExhdCkoaXR1ZGUpPy9naSwKCSAgICBsb25SZWdleCA9IC8oTCkob258bmcpKGdpdHVkZSk/L2k7CgoJZnVuY3Rpb24gZ3Vlc3NIZWFkZXIocm93LCByZWdleHApIHsKCSAgICB2YXIgbmFtZSwgbWF0Y2gsIHNjb3JlOwoJICAgIGZvciAodmFyIGYgaW4gcm93KSB7CgkgICAgICAgIG1hdGNoID0gZi5tYXRjaChyZWdleHApOwoJICAgICAgICBpZiAobWF0Y2ggJiYgKCFuYW1lIHx8IG1hdGNoWzBdLmxlbmd0aCAvIGYubGVuZ3RoID4gc2NvcmUpKSB7CgkgICAgICAgICAgICBzY29yZSA9IG1hdGNoWzBdLmxlbmd0aCAvIGYubGVuZ3RoOwoJICAgICAgICAgICAgbmFtZSA9IGY7CgkgICAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIG5hbWU7Cgl9CgoJZnVuY3Rpb24gZ3Vlc3NMYXRIZWFkZXIocm93KSB7IHJldHVybiBndWVzc0hlYWRlcihyb3csIGxhdFJlZ2V4KTsgfQoJZnVuY3Rpb24gZ3Vlc3NMb25IZWFkZXIocm93KSB7IHJldHVybiBndWVzc0hlYWRlcihyb3csIGxvblJlZ2V4KTsgfQoKCWZ1bmN0aW9uIGlzTGF0KGYpIHsgcmV0dXJuICEhZi5tYXRjaChsYXRSZWdleCk7IH0KCWZ1bmN0aW9uIGlzTG9uKGYpIHsgcmV0dXJuICEhZi5tYXRjaChsb25SZWdleCk7IH0KCglmdW5jdGlvbiBrZXlDb3VudChvKSB7CgkgICAgcmV0dXJuICh0eXBlb2YgbyA9PSAnb2JqZWN0JykgPyBPYmplY3Qua2V5cyhvKS5sZW5ndGggOiAwOwoJfQoKCWZ1bmN0aW9uIGF1dG9EZWxpbWl0ZXIoeCkgewoJICAgIHZhciBkZWxpbWl0ZXJzID0gWycsJywgJzsnLCAnXHQnLCAnfCddOwoJICAgIHZhciByZXN1bHRzID0gW107CgoJICAgIGRlbGltaXRlcnMuZm9yRWFjaChmdW5jdGlvbiAoZGVsaW1pdGVyKSB7CgkgICAgICAgIHZhciByZXMgPSBkc3YuZHN2Rm9ybWF0KGRlbGltaXRlcikucGFyc2UoeCk7CgkgICAgICAgIGlmIChyZXMubGVuZ3RoID49IDEpIHsKCSAgICAgICAgICAgIHZhciBjb3VudCA9IGtleUNvdW50KHJlc1swXSk7CgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlcy5sZW5ndGg7IGkrKykgewoJICAgICAgICAgICAgICAgIGlmIChrZXlDb3VudChyZXNbaV0pICE9PSBjb3VudCkgcmV0dXJuOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHsKCSAgICAgICAgICAgICAgICBkZWxpbWl0ZXI6IGRlbGltaXRlciwKCSAgICAgICAgICAgICAgICBhcml0eTogT2JqZWN0LmtleXMocmVzWzBdKS5sZW5ndGgsCgkgICAgICAgICAgICB9KTsKCSAgICAgICAgfQoJICAgIH0pOwoKCSAgICBpZiAocmVzdWx0cy5sZW5ndGgpIHsKCSAgICAgICAgcmV0dXJuIHJlc3VsdHMuc29ydChmdW5jdGlvbiAoYSwgYikgewoJICAgICAgICAgICAgcmV0dXJuIGIuYXJpdHkgLSBhLmFyaXR5OwoJICAgICAgICB9KVswXS5kZWxpbWl0ZXI7CgkgICAgfSBlbHNlIHsKCSAgICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoJfQoKCS8qKgoJICogU2lsbHkgc3RvcGdhcCBmb3IgZHN2IHRvIGQzLWRzdiB1cGdyYWRlCgkgKgoJICogQHBhcmFtIHtBcnJheX0geCBkc3Ygb3V0cHV0CgkgKiBAcmV0dXJucyB7QXJyYXl9IGFycmF5IHdpdGhvdXQgY29sdW1ucyBtZW1iZXIKCSAqLwoJZnVuY3Rpb24gZGVsZXRlQ29sdW1ucyh4KSB7CgkgICAgZGVsZXRlIHguY29sdW1uczsKCSAgICByZXR1cm4geDsKCX0KCglmdW5jdGlvbiBhdXRvKHgpIHsKCSAgICB2YXIgZGVsaW1pdGVyID0gYXV0b0RlbGltaXRlcih4KTsKCSAgICBpZiAoIWRlbGltaXRlcikgcmV0dXJuIG51bGw7CgkgICAgcmV0dXJuIGRlbGV0ZUNvbHVtbnMoZHN2LmRzdkZvcm1hdChkZWxpbWl0ZXIpLnBhcnNlKHgpKTsKCX0KCglmdW5jdGlvbiBjc3YyZ2VvanNvbih4LCBvcHRpb25zLCBjYWxsYmFjaykgewoKCSAgICBpZiAoIWNhbGxiYWNrKSB7CgkgICAgICAgIGNhbGxiYWNrID0gb3B0aW9uczsKCSAgICAgICAgb3B0aW9ucyA9IHt9OwoJICAgIH0KCgkgICAgb3B0aW9ucy5kZWxpbWl0ZXIgPSBvcHRpb25zLmRlbGltaXRlciB8fCAnLCc7CgoJICAgIHZhciBsYXRmaWVsZCA9IG9wdGlvbnMubGF0ZmllbGQgfHwgJycsCgkgICAgICAgIGxvbmZpZWxkID0gb3B0aW9ucy5sb25maWVsZCB8fCAnJywKCSAgICAgICAgY3JzID0gb3B0aW9ucy5jcnMgfHwgJyc7CgoJICAgIHZhciBmZWF0dXJlcyA9IFtdLAoJICAgICAgICBmZWF0dXJlY29sbGVjdGlvbiA9IHt0eXBlOiAnRmVhdHVyZUNvbGxlY3Rpb24nLCBmZWF0dXJlczogZmVhdHVyZXN9OwoKCSAgICBpZiAoY3JzICE9PSAnJykgewoJICAgICAgICBmZWF0dXJlY29sbGVjdGlvbi5jcnMgPSB7dHlwZTogJ25hbWUnLCBwcm9wZXJ0aWVzOiB7bmFtZTogY3JzfX07CgkgICAgfQoKCSAgICBpZiAob3B0aW9ucy5kZWxpbWl0ZXIgPT09ICdhdXRvJyAmJiB0eXBlb2YgeCA9PSAnc3RyaW5nJykgewoJICAgICAgICBvcHRpb25zLmRlbGltaXRlciA9IGF1dG9EZWxpbWl0ZXIoeCk7CgkgICAgICAgIGlmICghb3B0aW9ucy5kZWxpbWl0ZXIpIHsKCSAgICAgICAgICAgIGNhbGxiYWNrKHsKCSAgICAgICAgICAgICAgICB0eXBlOiAnRXJyb3InLAoJICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdDb3VsZCBub3QgYXV0b2RldGVjdCBkZWxpbWl0ZXInCgkgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIHJldHVybjsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgdmFyIG51bWVyaWNGaWVsZHMgPSBvcHRpb25zLm51bWVyaWNGaWVsZHMgPyBvcHRpb25zLm51bWVyaWNGaWVsZHMuc3BsaXQoJywnKSA6IG51bGw7CgoJICAgIHZhciBwYXJzZWQgPSAodHlwZW9mIHggPT0gJ3N0cmluZycpID8KCSAgICAgICAgZHN2LmRzdkZvcm1hdChvcHRpb25zLmRlbGltaXRlcikucGFyc2UoeCwgZnVuY3Rpb24gKGQpIHsKCSAgICAgICAgICAgIGlmIChudW1lcmljRmllbGRzKSB7CgkgICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGQpIHsKCSAgICAgICAgICAgICAgICAgICAgaWYgKG51bWVyaWNGaWVsZHMuaW5jbHVkZXMoa2V5KSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgZFtrZXldID0gK2Rba2V5XTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiBkOwoJICAgICAgICB9KSA6IHg7CgoJICAgIGlmICghcGFyc2VkLmxlbmd0aCkgewoJICAgICAgICBjYWxsYmFjayhudWxsLCBmZWF0dXJlY29sbGVjdGlvbik7CgkgICAgICAgIHJldHVybjsKCSAgICB9CgoJICAgIHZhciBlcnJvcnMgPSBbXTsKCSAgICB2YXIgaTsKCgoJICAgIGlmICghbGF0ZmllbGQpIGxhdGZpZWxkID0gZ3Vlc3NMYXRIZWFkZXIocGFyc2VkWzBdKTsKCSAgICBpZiAoIWxvbmZpZWxkKSBsb25maWVsZCA9IGd1ZXNzTG9uSGVhZGVyKHBhcnNlZFswXSk7CgkgICAgdmFyIG5vR2VvbWV0cnkgPSAoIWxhdGZpZWxkIHx8ICFsb25maWVsZCk7CgoJICAgIGlmIChub0dlb21ldHJ5KSB7CgkgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwYXJzZWQubGVuZ3RoOyBpKyspIHsKCSAgICAgICAgICAgIGZlYXR1cmVzLnB1c2goewoJICAgICAgICAgICAgICAgIHR5cGU6ICdGZWF0dXJlJywKCSAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiBwYXJzZWRbaV0sCgkgICAgICAgICAgICAgICAgZ2VvbWV0cnk6IG51bGwKCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9CgkgICAgICAgIGNhbGxiYWNrKGVycm9ycy5sZW5ndGggPyBlcnJvcnMgOiBudWxsLCBmZWF0dXJlY29sbGVjdGlvbik7CgkgICAgICAgIHJldHVybjsKCSAgICB9CgoJICAgIGZvciAoaSA9IDA7IGkgPCBwYXJzZWQubGVuZ3RoOyBpKyspIHsKCSAgICAgICAgaWYgKHBhcnNlZFtpXVtsb25maWVsZF0gIT09IHVuZGVmaW5lZCAmJgoJICAgICAgICAgICAgcGFyc2VkW2ldW2xhdGZpZWxkXSAhPT0gdW5kZWZpbmVkKSB7CgoJICAgICAgICAgICAgdmFyIGxvbmsgPSBwYXJzZWRbaV1bbG9uZmllbGRdLAoJICAgICAgICAgICAgICAgIGxhdGsgPSBwYXJzZWRbaV1bbGF0ZmllbGRdLAoJICAgICAgICAgICAgICAgIGxvbmYsIGxhdGYsCgkgICAgICAgICAgICAgICAgYTsKCgkgICAgICAgICAgICBhID0gc2V4YWdlc2ltYWwobG9uaywgJ0VXJyk7CgkgICAgICAgICAgICBpZiAoYSkgbG9uayA9IGE7CgkgICAgICAgICAgICBhID0gc2V4YWdlc2ltYWwobGF0aywgJ05TJyk7CgkgICAgICAgICAgICBpZiAoYSkgbGF0ayA9IGE7CgoJICAgICAgICAgICAgbG9uZiA9IHBhcnNlRmxvYXQobG9uayk7CgkgICAgICAgICAgICBsYXRmID0gcGFyc2VGbG9hdChsYXRrKTsKCgkgICAgICAgICAgICBpZiAoaXNOYU4obG9uZikgfHwKCSAgICAgICAgICAgICAgICBpc05hTihsYXRmKSkgewoJICAgICAgICAgICAgICAgIGVycm9ycy5wdXNoKHsKCSAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogJ0Egcm93IGNvbnRhaW5lZCBhbiBpbnZhbGlkIHZhbHVlIGZvciBsYXRpdHVkZSBvciBsb25naXR1ZGUnLAoJICAgICAgICAgICAgICAgICAgICByb3c6IHBhcnNlZFtpXSwKCSAgICAgICAgICAgICAgICAgICAgaW5kZXg6IGkKCSAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgaWYgKCFvcHRpb25zLmluY2x1ZGVMYXRMb24pIHsKCSAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHBhcnNlZFtpXVtsb25maWVsZF07CgkgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBwYXJzZWRbaV1bbGF0ZmllbGRdOwoJICAgICAgICAgICAgICAgIH0KCgkgICAgICAgICAgICAgICAgZmVhdHVyZXMucHVzaCh7CgkgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdGZWF0dXJlJywKCSAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllczogcGFyc2VkW2ldLAoJICAgICAgICAgICAgICAgICAgICBnZW9tZXRyeTogewoJICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ1BvaW50JywKCSAgICAgICAgICAgICAgICAgICAgICAgIGNvb3JkaW5hdGVzOiBbCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VGbG9hdChsb25mKSwKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJzZUZsb2F0KGxhdGYpCgkgICAgICAgICAgICAgICAgICAgICAgICBdCgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgIH0KCgkgICAgY2FsbGJhY2soZXJyb3JzLmxlbmd0aCA/IGVycm9ycyA6IG51bGwsIGZlYXR1cmVjb2xsZWN0aW9uKTsKCX0KCglmdW5jdGlvbiB0b0xpbmUoZ2opIHsKCSAgICB2YXIgZmVhdHVyZXMgPSBnai5mZWF0dXJlczsKCSAgICB2YXIgbGluZSA9IHsKCSAgICAgICAgdHlwZTogJ0ZlYXR1cmUnLAoJICAgICAgICBnZW9tZXRyeTogewoJICAgICAgICAgICAgdHlwZTogJ0xpbmVTdHJpbmcnLAoJICAgICAgICAgICAgY29vcmRpbmF0ZXM6IFtdCgkgICAgICAgIH0KCSAgICB9OwoJICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZmVhdHVyZXMubGVuZ3RoOyBpKyspIHsKCSAgICAgICAgbGluZS5nZW9tZXRyeS5jb29yZGluYXRlcy5wdXNoKGZlYXR1cmVzW2ldLmdlb21ldHJ5LmNvb3JkaW5hdGVzKTsKCSAgICB9CgkgICAgbGluZS5wcm9wZXJ0aWVzID0gZmVhdHVyZXMucmVkdWNlKGZ1bmN0aW9uIChhZ2dyZWdhdGVkUHJvcGVydGllcywgbmV3RmVhdHVyZSkgewoJICAgICAgICBmb3IgKHZhciBrZXkgaW4gbmV3RmVhdHVyZS5wcm9wZXJ0aWVzKSB7CgkgICAgICAgICAgICBpZiAoIWFnZ3JlZ2F0ZWRQcm9wZXJ0aWVzW2tleV0pIHsKCSAgICAgICAgICAgICAgICBhZ2dyZWdhdGVkUHJvcGVydGllc1trZXldID0gW107CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBhZ2dyZWdhdGVkUHJvcGVydGllc1trZXldLnB1c2gobmV3RmVhdHVyZS5wcm9wZXJ0aWVzW2tleV0pOwoJICAgICAgICB9CgkgICAgICAgIHJldHVybiBhZ2dyZWdhdGVkUHJvcGVydGllczsKCSAgICB9LCB7fSk7CgkgICAgcmV0dXJuIHsKCSAgICAgICAgdHlwZTogJ0ZlYXR1cmVDb2xsZWN0aW9uJywKCSAgICAgICAgZmVhdHVyZXM6IFtsaW5lXQoJICAgIH07Cgl9CgoJZnVuY3Rpb24gdG9Qb2x5Z29uKGdqKSB7CgkgICAgdmFyIGZlYXR1cmVzID0gZ2ouZmVhdHVyZXM7CgkgICAgdmFyIHBvbHkgPSB7CgkgICAgICAgIHR5cGU6ICdGZWF0dXJlJywKCSAgICAgICAgZ2VvbWV0cnk6IHsKCSAgICAgICAgICAgIHR5cGU6ICdQb2x5Z29uJywKCSAgICAgICAgICAgIGNvb3JkaW5hdGVzOiBbW11dCgkgICAgICAgIH0KCSAgICB9OwoJICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZmVhdHVyZXMubGVuZ3RoOyBpKyspIHsKCSAgICAgICAgcG9seS5nZW9tZXRyeS5jb29yZGluYXRlc1swXS5wdXNoKGZlYXR1cmVzW2ldLmdlb21ldHJ5LmNvb3JkaW5hdGVzKTsKCSAgICB9CgkgICAgcG9seS5wcm9wZXJ0aWVzID0gZmVhdHVyZXMucmVkdWNlKGZ1bmN0aW9uIChhZ2dyZWdhdGVkUHJvcGVydGllcywgbmV3RmVhdHVyZSkgewoJICAgICAgICBmb3IgKHZhciBrZXkgaW4gbmV3RmVhdHVyZS5wcm9wZXJ0aWVzKSB7CgkgICAgICAgICAgICBpZiAoIWFnZ3JlZ2F0ZWRQcm9wZXJ0aWVzW2tleV0pIHsKCSAgICAgICAgICAgICAgICBhZ2dyZWdhdGVkUHJvcGVydGllc1trZXldID0gW107CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBhZ2dyZWdhdGVkUHJvcGVydGllc1trZXldLnB1c2gobmV3RmVhdHVyZS5wcm9wZXJ0aWVzW2tleV0pOwoJICAgICAgICB9CgkgICAgICAgIHJldHVybiBhZ2dyZWdhdGVkUHJvcGVydGllczsKCSAgICB9LCB7fSk7CgkgICAgcmV0dXJuIHsKCSAgICAgICAgdHlwZTogJ0ZlYXR1cmVDb2xsZWN0aW9uJywKCSAgICAgICAgZmVhdHVyZXM6IFtwb2x5XQoJICAgIH07Cgl9CgoJdmFyIGNzdjJnZW9qc29uXzEgPSB7CgkgICAgaXNMb246IGlzTG9uLAoJICAgIGlzTGF0OiBpc0xhdCwKCSAgICBndWVzc0xhdEhlYWRlcjogZ3Vlc3NMYXRIZWFkZXIsCgkgICAgZ3Vlc3NMb25IZWFkZXI6IGd1ZXNzTG9uSGVhZGVyLAoJICAgIGNzdjogZHN2LmNzdlBhcnNlLAoJICAgIHRzdjogZHN2LnRzdlBhcnNlLAoJICAgIGRzdjogZHN2LAoJICAgIGF1dG86IGF1dG8sCgkgICAgY3N2Mmdlb2pzb246IGNzdjJnZW9qc29uLAoJICAgIHRvTGluZTogdG9MaW5lLAoJICAgIHRvUG9seWdvbjogdG9Qb2x5Z29uCgl9OwoKCWZ1bmN0aW9uIGlkZW50aXR5KHgpIHsKCSAgcmV0dXJuIHg7Cgl9CgoJZnVuY3Rpb24gdHJhbnNmb3JtKHRyYW5zZm9ybSkgewoJICBpZiAodHJhbnNmb3JtID09IG51bGwpIHJldHVybiBpZGVudGl0eTsKCSAgdmFyIHgwLAoJICAgICAgeTAsCgkgICAgICBreCA9IHRyYW5zZm9ybS5zY2FsZVswXSwKCSAgICAgIGt5ID0gdHJhbnNmb3JtLnNjYWxlWzFdLAoJICAgICAgZHggPSB0cmFuc2Zvcm0udHJhbnNsYXRlWzBdLAoJICAgICAgZHkgPSB0cmFuc2Zvcm0udHJhbnNsYXRlWzFdOwoJICByZXR1cm4gZnVuY3Rpb24oaW5wdXQsIGkpIHsKCSAgICBpZiAoIWkpIHgwID0geTAgPSAwOwoJICAgIHZhciBqID0gMiwgbiA9IGlucHV0Lmxlbmd0aCwgb3V0cHV0ID0gbmV3IEFycmF5KG4pOwoJICAgIG91dHB1dFswXSA9ICh4MCArPSBpbnB1dFswXSkgKiBreCArIGR4OwoJICAgIG91dHB1dFsxXSA9ICh5MCArPSBpbnB1dFsxXSkgKiBreSArIGR5OwoJICAgIHdoaWxlIChqIDwgbikgb3V0cHV0W2pdID0gaW5wdXRbal0sICsrajsKCSAgICByZXR1cm4gb3V0cHV0OwoJICB9OwoJfQoKCWZ1bmN0aW9uIHJldmVyc2UoYXJyYXksIG4pIHsKCSAgdmFyIHQsIGogPSBhcnJheS5sZW5ndGgsIGkgPSBqIC0gbjsKCSAgd2hpbGUgKGkgPCAtLWopIHQgPSBhcnJheVtpXSwgYXJyYXlbaSsrXSA9IGFycmF5W2pdLCBhcnJheVtqXSA9IHQ7Cgl9CgoJZnVuY3Rpb24gdG9wb2pzb25GZWF0dXJlKHRvcG9sb2d5LCBvKSB7CgkgIGlmICh0eXBlb2YgbyA9PT0gInN0cmluZyIpIG8gPSB0b3BvbG9neS5vYmplY3RzW29dOwoJICByZXR1cm4gby50eXBlID09PSAiR2VvbWV0cnlDb2xsZWN0aW9uIgoJICAgICAgPyB7dHlwZTogIkZlYXR1cmVDb2xsZWN0aW9uIiwgZmVhdHVyZXM6IG8uZ2VvbWV0cmllcy5tYXAoZnVuY3Rpb24obykgeyByZXR1cm4gZmVhdHVyZSh0b3BvbG9neSwgbyk7IH0pfQoJICAgICAgOiBmZWF0dXJlKHRvcG9sb2d5LCBvKTsKCX0KCglmdW5jdGlvbiBmZWF0dXJlKHRvcG9sb2d5LCBvKSB7CgkgIHZhciBpZCA9IG8uaWQsCgkgICAgICBiYm94ID0gby5iYm94LAoJICAgICAgcHJvcGVydGllcyA9IG8ucHJvcGVydGllcyA9PSBudWxsID8ge30gOiBvLnByb3BlcnRpZXMsCgkgICAgICBnZW9tZXRyeSA9IG9iamVjdCh0b3BvbG9neSwgbyk7CgkgIHJldHVybiBpZCA9PSBudWxsICYmIGJib3ggPT0gbnVsbCA/IHt0eXBlOiAiRmVhdHVyZSIsIHByb3BlcnRpZXM6IHByb3BlcnRpZXMsIGdlb21ldHJ5OiBnZW9tZXRyeX0KCSAgICAgIDogYmJveCA9PSBudWxsID8ge3R5cGU6ICJGZWF0dXJlIiwgaWQ6IGlkLCBwcm9wZXJ0aWVzOiBwcm9wZXJ0aWVzLCBnZW9tZXRyeTogZ2VvbWV0cnl9CgkgICAgICA6IHt0eXBlOiAiRmVhdHVyZSIsIGlkOiBpZCwgYmJveDogYmJveCwgcHJvcGVydGllczogcHJvcGVydGllcywgZ2VvbWV0cnk6IGdlb21ldHJ5fTsKCX0KCglmdW5jdGlvbiBvYmplY3QodG9wb2xvZ3ksIG8pIHsKCSAgdmFyIHRyYW5zZm9ybVBvaW50ID0gdHJhbnNmb3JtKHRvcG9sb2d5LnRyYW5zZm9ybSksCgkgICAgICBhcmNzID0gdG9wb2xvZ3kuYXJjczsKCgkgIGZ1bmN0aW9uIGFyYyhpLCBwb2ludHMpIHsKCSAgICBpZiAocG9pbnRzLmxlbmd0aCkgcG9pbnRzLnBvcCgpOwoJICAgIGZvciAodmFyIGEgPSBhcmNzW2kgPCAwID8gfmkgOiBpXSwgayA9IDAsIG4gPSBhLmxlbmd0aDsgayA8IG47ICsraykgewoJICAgICAgcG9pbnRzLnB1c2godHJhbnNmb3JtUG9pbnQoYVtrXSwgaykpOwoJICAgIH0KCSAgICBpZiAoaSA8IDApIHJldmVyc2UocG9pbnRzLCBuKTsKCSAgfQoKCSAgZnVuY3Rpb24gcG9pbnQocCkgewoJICAgIHJldHVybiB0cmFuc2Zvcm1Qb2ludChwKTsKCSAgfQoKCSAgZnVuY3Rpb24gbGluZShhcmNzKSB7CgkgICAgdmFyIHBvaW50cyA9IFtdOwoJICAgIGZvciAodmFyIGkgPSAwLCBuID0gYXJjcy5sZW5ndGg7IGkgPCBuOyArK2kpIGFyYyhhcmNzW2ldLCBwb2ludHMpOwoJICAgIGlmIChwb2ludHMubGVuZ3RoIDwgMikgcG9pbnRzLnB1c2gocG9pbnRzWzBdKTsgLy8gVGhpcyBzaG91bGQgbmV2ZXIgaGFwcGVuIHBlciB0aGUgc3BlY2lmaWNhdGlvbi4KCSAgICByZXR1cm4gcG9pbnRzOwoJICB9CgoJICBmdW5jdGlvbiByaW5nKGFyY3MpIHsKCSAgICB2YXIgcG9pbnRzID0gbGluZShhcmNzKTsKCSAgICB3aGlsZSAocG9pbnRzLmxlbmd0aCA8IDQpIHBvaW50cy5wdXNoKHBvaW50c1swXSk7IC8vIFRoaXMgbWF5IGhhcHBlbiBpZiBhbiBhcmMgaGFzIG9ubHkgdHdvIHBvaW50cy4KCSAgICByZXR1cm4gcG9pbnRzOwoJICB9CgoJICBmdW5jdGlvbiBwb2x5Z29uKGFyY3MpIHsKCSAgICByZXR1cm4gYXJjcy5tYXAocmluZyk7CgkgIH0KCgkgIGZ1bmN0aW9uIGdlb21ldHJ5KG8pIHsKCSAgICB2YXIgdHlwZSA9IG8udHlwZSwgY29vcmRpbmF0ZXM7CgkgICAgc3dpdGNoICh0eXBlKSB7CgkgICAgICBjYXNlICJHZW9tZXRyeUNvbGxlY3Rpb24iOiByZXR1cm4ge3R5cGU6IHR5cGUsIGdlb21ldHJpZXM6IG8uZ2VvbWV0cmllcy5tYXAoZ2VvbWV0cnkpfTsKCSAgICAgIGNhc2UgIlBvaW50IjogY29vcmRpbmF0ZXMgPSBwb2ludChvLmNvb3JkaW5hdGVzKTsgYnJlYWs7CgkgICAgICBjYXNlICJNdWx0aVBvaW50IjogY29vcmRpbmF0ZXMgPSBvLmNvb3JkaW5hdGVzLm1hcChwb2ludCk7IGJyZWFrOwoJICAgICAgY2FzZSAiTGluZVN0cmluZyI6IGNvb3JkaW5hdGVzID0gbGluZShvLmFyY3MpOyBicmVhazsKCSAgICAgIGNhc2UgIk11bHRpTGluZVN0cmluZyI6IGNvb3JkaW5hdGVzID0gby5hcmNzLm1hcChsaW5lKTsgYnJlYWs7CgkgICAgICBjYXNlICJQb2x5Z29uIjogY29vcmRpbmF0ZXMgPSBwb2x5Z29uKG8uYXJjcyk7IGJyZWFrOwoJICAgICAgY2FzZSAiTXVsdGlQb2x5Z29uIjogY29vcmRpbmF0ZXMgPSBvLmFyY3MubWFwKHBvbHlnb24pOyBicmVhazsKCSAgICAgIGRlZmF1bHQ6IHJldHVybiBudWxsOwoJICAgIH0KCSAgICByZXR1cm4ge3R5cGU6IHR5cGUsIGNvb3JkaW5hdGVzOiBjb29yZGluYXRlc307CgkgIH0KCgkgIHJldHVybiBnZW9tZXRyeShvKTsKCX0KCgl2YXIgdG9nZW9qc29uID0ge307CgoJT2JqZWN0LmRlZmluZVByb3BlcnR5KHRvZ2VvanNvbiwgJ19fZXNNb2R1bGUnLCB7IHZhbHVlOiB0cnVlIH0pOwoKCS8vIGNhc3QgYXJyYXkgeCBpbnRvIG51bWJlcnMKCS8vIGdldCB0aGUgY29udGVudCBvZiBhIHRleHQgbm9kZSwgaWYgYW55CglmdW5jdGlvbiBub2RlVmFsKHgpIHsKCSAgaWYgKHggJiYgeC5ub3JtYWxpemUpIHsKCSAgICB4Lm5vcm1hbGl6ZSgpOwoJICB9CgkgIHJldHVybiAoeCAmJiB4LnRleHRDb250ZW50KSB8fCAiIjsKCX0KCgkvLyBvbmUgWSBjaGlsZCBvZiBYLCBpZiBhbnksIG90aGVyd2lzZSBudWxsCglmdW5jdGlvbiBnZXQxKHgsIHkpIHsKCSAgY29uc3QgbiA9IHguZ2V0RWxlbWVudHNCeVRhZ05hbWUoeSk7CgkgIHJldHVybiBuLmxlbmd0aCA/IG5bMF0gOiBudWxsOwoJfQoKCWZ1bmN0aW9uIGdldExpbmVTdHlsZShleHRlbnNpb25zKSB7CgkgIGNvbnN0IHN0eWxlID0ge307CgkgIGlmIChleHRlbnNpb25zKSB7CgkgICAgY29uc3QgbGluZVN0eWxlID0gZ2V0MShleHRlbnNpb25zLCAibGluZSIpOwoJICAgIGlmIChsaW5lU3R5bGUpIHsKCSAgICAgIGNvbnN0IGNvbG9yID0gbm9kZVZhbChnZXQxKGxpbmVTdHlsZSwgImNvbG9yIikpLAoJICAgICAgICBvcGFjaXR5ID0gcGFyc2VGbG9hdChub2RlVmFsKGdldDEobGluZVN0eWxlLCAib3BhY2l0eSIpKSksCgkgICAgICAgIHdpZHRoID0gcGFyc2VGbG9hdChub2RlVmFsKGdldDEobGluZVN0eWxlLCAid2lkdGgiKSkpOwoJICAgICAgaWYgKGNvbG9yKSBzdHlsZS5zdHJva2UgPSBjb2xvcjsKCSAgICAgIGlmICghaXNOYU4ob3BhY2l0eSkpIHN0eWxlWyJzdHJva2Utb3BhY2l0eSJdID0gb3BhY2l0eTsKCSAgICAgIC8vIEdQWCB3aWR0aCBpcyBpbiBtbSwgY29udmVydCB0byBweCB3aXRoIDk2IHB4IHBlciBpbmNoCgkgICAgICBpZiAoIWlzTmFOKHdpZHRoKSkgc3R5bGVbInN0cm9rZS13aWR0aCJdID0gKHdpZHRoICogOTYpIC8gMjUuNDsKCSAgICB9CgkgIH0KCSAgcmV0dXJuIHN0eWxlOwoJfQoKCS8vIGdldCB0aGUgY29udGVudHMgb2YgbXVsdGlwbGUgdGV4dCBub2RlcywgaWYgcHJlc2VudAoJZnVuY3Rpb24gZ2V0TXVsdGkoeCwgeXMpIHsKCSAgY29uc3QgbyA9IHt9OwoJICBsZXQgbjsKCSAgbGV0IGs7CgkgIGZvciAoayA9IDA7IGsgPCB5cy5sZW5ndGg7IGsrKykgewoJICAgIG4gPSBnZXQxKHgsIHlzW2tdKTsKCSAgICBpZiAobikgb1t5c1trXV0gPSBub2RlVmFsKG4pOwoJICB9CgkgIHJldHVybiBvOwoJfQoJZnVuY3Rpb24gZ2V0UHJvcGVydGllcyQxKG5vZGUpIHsKCSAgY29uc3QgcHJvcCA9IGdldE11bHRpKG5vZGUsIFsKCSAgICAibmFtZSIsCgkgICAgImNtdCIsCgkgICAgImRlc2MiLAoJICAgICJ0eXBlIiwKCSAgICAidGltZSIsCgkgICAgImtleXdvcmRzIiwKCSAgXSk7CgkgIC8vIFBhcnNlIGFkZGl0aW9uYWwgZGF0YSBmcm9tIG91ciBHYXJtaW4gZXh0ZW5zaW9uKHMpCgkgIGNvbnN0IGV4dGVuc2lvbnMgPSBub2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lTlMoCgkgICAgImh0dHA6Ly93d3cuZ2FybWluLmNvbS94bWxzY2hlbWFzL0dweEV4dGVuc2lvbnMvdjMiLAoJICAgICIqIgoJICApOwoJICBmb3IgKGxldCBpID0gMDsgaSA8IGV4dGVuc2lvbnMubGVuZ3RoOyBpKyspIHsKCSAgICBjb25zdCBleHRlbnNpb24gPSBleHRlbnNpb25zW2ldOwoJICAgIC8vIElnbm9yZSBuZXN0ZWQgZXh0ZW5zaW9ucywgbGlrZSB0aG9zZSBvbiByb3V0ZXBvaW50cyBvciB0cmFja3BvaW50cwoJICAgIGlmIChleHRlbnNpb24ucGFyZW50Tm9kZS5wYXJlbnROb2RlID09PSBub2RlKSB7CgkgICAgICBwcm9wW2V4dGVuc2lvbi50YWdOYW1lLnJlcGxhY2UoIjoiLCAiXyIpXSA9IG5vZGVWYWwoZXh0ZW5zaW9uKTsKCSAgICB9CgkgIH0KCSAgY29uc3QgbGlua3MgPSBub2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJsaW5rIik7CgkgIGlmIChsaW5rcy5sZW5ndGgpIHByb3AubGlua3MgPSBbXTsKCSAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaW5rcy5sZW5ndGg7IGkrKykgewoJICAgIHByb3AubGlua3MucHVzaCgKCSAgICAgIE9iamVjdC5hc3NpZ24oCgkgICAgICAgIHsgaHJlZjogbGlua3NbaV0uZ2V0QXR0cmlidXRlKCJocmVmIikgfSwKCSAgICAgICAgZ2V0TXVsdGkobGlua3NbaV0sIFsidGV4dCIsICJ0eXBlIl0pCgkgICAgICApCgkgICAgKTsKCSAgfQoJICByZXR1cm4gcHJvcDsKCX0KCglmdW5jdGlvbiBjb29yZFBhaXIkMSh4KSB7CgkgIGNvbnN0IGxsID0gWwoJICAgIHBhcnNlRmxvYXQoeC5nZXRBdHRyaWJ1dGUoImxvbiIpKSwKCSAgICBwYXJzZUZsb2F0KHguZ2V0QXR0cmlidXRlKCJsYXQiKSksCgkgIF07CgkgIGNvbnN0IGVsZSA9IGdldDEoeCwgImVsZSIpOwoJICAvLyBoYW5kbGUgbmFtZXNwYWNlZCBhdHRyaWJ1dGUgaW4gYnJvd3NlcgoJICBjb25zdCBoZWFydCA9IGdldDEoeCwgImdweHRweDpociIpIHx8IGdldDEoeCwgImhyIik7CgkgIGNvbnN0IHRpbWUgPSBnZXQxKHgsICJ0aW1lIik7CgkgIGxldCBlOwoJICBpZiAoZWxlKSB7CgkgICAgZSA9IHBhcnNlRmxvYXQobm9kZVZhbChlbGUpKTsKCSAgICBpZiAoIWlzTmFOKGUpKSB7CgkgICAgICBsbC5wdXNoKGUpOwoJICAgIH0KCSAgfQoJICBjb25zdCByZXN1bHQgPSB7CgkgICAgY29vcmRpbmF0ZXM6IGxsLAoJICAgIHRpbWU6IHRpbWUgPyBub2RlVmFsKHRpbWUpIDogbnVsbCwKCSAgICBleHRlbmRlZFZhbHVlczogW10sCgkgIH07CgoJICBpZiAoaGVhcnQpIHsKCSAgICByZXN1bHQuZXh0ZW5kZWRWYWx1ZXMucHVzaChbImhlYXJ0IiwgcGFyc2VGbG9hdChub2RlVmFsKGhlYXJ0KSldKTsKCSAgfQoKCSAgY29uc3QgZXh0ZW5zaW9ucyA9IGdldDEoeCwgImV4dGVuc2lvbnMiKTsKCSAgaWYgKGV4dGVuc2lvbnMgIT09IG51bGwpIHsKCSAgICBmb3IgKGNvbnN0IG5hbWUgb2YgWyJzcGVlZCIsICJjb3Vyc2UiLCAiaEFjYyIsICJ2QWNjIl0pIHsKCSAgICAgIGNvbnN0IHYgPSBwYXJzZUZsb2F0KG5vZGVWYWwoZ2V0MShleHRlbnNpb25zLCBuYW1lKSkpOwoJICAgICAgaWYgKCFpc05hTih2KSkgewoJICAgICAgICByZXN1bHQuZXh0ZW5kZWRWYWx1ZXMucHVzaChbbmFtZSwgdl0pOwoJICAgICAgfQoJICAgIH0KCSAgfQoJICByZXR1cm4gcmVzdWx0OwoJfQoJZnVuY3Rpb24gZ2V0Um91dGUobm9kZSkgewoJICBjb25zdCBsaW5lID0gZ2V0UG9pbnRzJDEobm9kZSwgInJ0ZXB0Iik7CgkgIGlmICghbGluZSkgcmV0dXJuOwoJICByZXR1cm4gewoJICAgIHR5cGU6ICJGZWF0dXJlIiwKCSAgICBwcm9wZXJ0aWVzOiBPYmplY3QuYXNzaWduKAoJICAgICAgZ2V0UHJvcGVydGllcyQxKG5vZGUpLAoJICAgICAgZ2V0TGluZVN0eWxlKGdldDEobm9kZSwgImV4dGVuc2lvbnMiKSksCgkgICAgICB7IF9ncHhUeXBlOiAicnRlIiB9CgkgICAgKSwKCSAgICBnZW9tZXRyeTogewoJICAgICAgdHlwZTogIkxpbmVTdHJpbmciLAoJICAgICAgY29vcmRpbmF0ZXM6IGxpbmUubGluZSwKCSAgICB9LAoJICB9OwoJfQoKCWZ1bmN0aW9uIGdldFBvaW50cyQxKG5vZGUsIHBvaW50bmFtZSkgewoJICBjb25zdCBwdHMgPSBub2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKHBvaW50bmFtZSk7CgkgIGlmIChwdHMubGVuZ3RoIDwgMikgcmV0dXJuOyAvLyBJbnZhbGlkIGxpbmUgaW4gR2VvSlNPTgoKCSAgY29uc3QgbGluZSA9IFtdOwoJICBjb25zdCB0aW1lcyA9IFtdOwoJICBjb25zdCBleHRlbmRlZFZhbHVlcyA9IHt9OwoJICBmb3IgKGxldCBpID0gMDsgaSA8IHB0cy5sZW5ndGg7IGkrKykgewoJICAgIGNvbnN0IGMgPSBjb29yZFBhaXIkMShwdHNbaV0pOwoJICAgIGxpbmUucHVzaChjLmNvb3JkaW5hdGVzKTsKCSAgICBpZiAoYy50aW1lKSB0aW1lcy5wdXNoKGMudGltZSk7CgkgICAgZm9yIChsZXQgaiA9IDA7IGogPCBjLmV4dGVuZGVkVmFsdWVzLmxlbmd0aDsgaisrKSB7CgkgICAgICBjb25zdCBbbmFtZSwgdmFsXSA9IGMuZXh0ZW5kZWRWYWx1ZXNbal07CgkgICAgICBjb25zdCBwbHVyYWwgPSBuYW1lID09PSAiaGVhcnQiID8gbmFtZSA6IG5hbWUgKyAicyI7CgkgICAgICBpZiAoIWV4dGVuZGVkVmFsdWVzW3BsdXJhbF0pIHsKCSAgICAgICAgZXh0ZW5kZWRWYWx1ZXNbcGx1cmFsXSA9IEFycmF5KHB0cy5sZW5ndGgpLmZpbGwobnVsbCk7CgkgICAgICB9CgkgICAgICBleHRlbmRlZFZhbHVlc1twbHVyYWxdW2ldID0gdmFsOwoJICAgIH0KCSAgfQoJICByZXR1cm4gewoJICAgIGxpbmU6IGxpbmUsCgkgICAgdGltZXM6IHRpbWVzLAoJICAgIGV4dGVuZGVkVmFsdWVzOiBleHRlbmRlZFZhbHVlcywKCSAgfTsKCX0KCglmdW5jdGlvbiBnZXRUcmFjayhub2RlKSB7CgkgIGNvbnN0IHNlZ21lbnRzID0gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgidHJrc2VnIik7CgkgIGNvbnN0IHRyYWNrID0gW107CgkgIGNvbnN0IHRpbWVzID0gW107CgkgIGNvbnN0IGV4dHJhY3RlZExpbmVzID0gW107CgoJICBmb3IgKGxldCBpID0gMDsgaSA8IHNlZ21lbnRzLmxlbmd0aDsgaSsrKSB7CgkgICAgY29uc3QgbGluZSA9IGdldFBvaW50cyQxKHNlZ21lbnRzW2ldLCAidHJrcHQiKTsKCSAgICBpZiAobGluZSkgewoJICAgICAgZXh0cmFjdGVkTGluZXMucHVzaChsaW5lKTsKCSAgICAgIGlmIChsaW5lLnRpbWVzICYmIGxpbmUudGltZXMubGVuZ3RoKSB0aW1lcy5wdXNoKGxpbmUudGltZXMpOwoJICAgIH0KCSAgfQoKCSAgaWYgKGV4dHJhY3RlZExpbmVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwoKCSAgY29uc3QgbXVsdGkgPSBleHRyYWN0ZWRMaW5lcy5sZW5ndGggPiAxOwoKCSAgY29uc3QgcHJvcGVydGllcyA9IE9iamVjdC5hc3NpZ24oCgkgICAgZ2V0UHJvcGVydGllcyQxKG5vZGUpLAoJICAgIGdldExpbmVTdHlsZShnZXQxKG5vZGUsICJleHRlbnNpb25zIikpLAoJICAgIHsgX2dweFR5cGU6ICJ0cmsiIH0sCgkgICAgdGltZXMubGVuZ3RoCgkgICAgICA/IHsKCSAgICAgICAgICBjb29yZGluYXRlUHJvcGVydGllczogewoJICAgICAgICAgICAgdGltZXM6IG11bHRpID8gdGltZXMgOiB0aW1lc1swXSwKCSAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICAgIDoge30KCSAgKTsKCgkgIGZvciAobGV0IGkgPSAwOyBpIDwgZXh0cmFjdGVkTGluZXMubGVuZ3RoOyBpKyspIHsKCSAgICBjb25zdCBsaW5lID0gZXh0cmFjdGVkTGluZXNbaV07CgkgICAgdHJhY2sucHVzaChsaW5lLmxpbmUpOwoJICAgIGZvciAoY29uc3QgW25hbWUsIHZhbF0gb2YgT2JqZWN0LmVudHJpZXMobGluZS5leHRlbmRlZFZhbHVlcykpIHsKCSAgICAgIGxldCBwcm9wcyA9IHByb3BlcnRpZXM7CgkgICAgICBpZiAobmFtZSA9PT0gImhlYXJ0IikgewoJICAgICAgICBpZiAoIXByb3BlcnRpZXMuY29vcmRpbmF0ZVByb3BlcnRpZXMpIHsKCSAgICAgICAgICBwcm9wZXJ0aWVzLmNvb3JkaW5hdGVQcm9wZXJ0aWVzID0ge307CgkgICAgICAgIH0KCSAgICAgICAgcHJvcHMgPSBwcm9wZXJ0aWVzLmNvb3JkaW5hdGVQcm9wZXJ0aWVzOwoJICAgICAgfQoJICAgICAgaWYgKG11bHRpKSB7CgkgICAgICAgIGlmICghcHJvcHNbbmFtZV0pCgkgICAgICAgICAgcHJvcHNbbmFtZV0gPSBleHRyYWN0ZWRMaW5lcy5tYXAoKGxpbmUpID0+CgkgICAgICAgICAgICBuZXcgQXJyYXkobGluZS5saW5lLmxlbmd0aCkuZmlsbChudWxsKQoJICAgICAgICAgICk7CgkgICAgICAgIHByb3BzW25hbWVdW2ldID0gdmFsOwoJICAgICAgfSBlbHNlIHsKCSAgICAgICAgcHJvcHNbbmFtZV0gPSB2YWw7CgkgICAgICB9CgkgICAgfQoJICB9CgoJICByZXR1cm4gewoJICAgIHR5cGU6ICJGZWF0dXJlIiwKCSAgICBwcm9wZXJ0aWVzOiBwcm9wZXJ0aWVzLAoJICAgIGdlb21ldHJ5OiBtdWx0aQoJICAgICAgPyB7CgkgICAgICAgIHR5cGU6ICJNdWx0aUxpbmVTdHJpbmciLAoJICAgICAgICBjb29yZGluYXRlczogdHJhY2ssCgkgICAgICB9CgkgICAgICA6IHsKCSAgICAgICAgdHlwZTogIkxpbmVTdHJpbmciLAoJICAgICAgICBjb29yZGluYXRlczogdHJhY2tbMF0sCgkgICAgICB9LAoJICB9OwoJfQoKCWZ1bmN0aW9uIGdldFBvaW50KG5vZGUpIHsKCSAgcmV0dXJuIHsKCSAgICB0eXBlOiAiRmVhdHVyZSIsCgkgICAgcHJvcGVydGllczogT2JqZWN0LmFzc2lnbihnZXRQcm9wZXJ0aWVzJDEobm9kZSksIGdldE11bHRpKG5vZGUsIFsic3ltIl0pKSwKCSAgICBnZW9tZXRyeTogewoJICAgICAgdHlwZTogIlBvaW50IiwKCSAgICAgIGNvb3JkaW5hdGVzOiBjb29yZFBhaXIkMShub2RlKS5jb29yZGluYXRlcywKCSAgICB9LAoJICB9OwoJfQoKCWZ1bmN0aW9uKiBncHhHZW4oZG9jKSB7CgkgIGNvbnN0IHRyYWNrcyA9IGRvYy5nZXRFbGVtZW50c0J5VGFnTmFtZSgidHJrIik7CgkgIGNvbnN0IHJvdXRlcyA9IGRvYy5nZXRFbGVtZW50c0J5VGFnTmFtZSgicnRlIik7CgkgIGNvbnN0IHdheXBvaW50cyA9IGRvYy5nZXRFbGVtZW50c0J5VGFnTmFtZSgid3B0Iik7CgoJICBmb3IgKGxldCBpID0gMDsgaSA8IHRyYWNrcy5sZW5ndGg7IGkrKykgewoJICAgIGNvbnN0IGZlYXR1cmUgPSBnZXRUcmFjayh0cmFja3NbaV0pOwoJICAgIGlmIChmZWF0dXJlKSB5aWVsZCBmZWF0dXJlOwoJICB9CgkgIGZvciAobGV0IGkgPSAwOyBpIDwgcm91dGVzLmxlbmd0aDsgaSsrKSB7CgkgICAgY29uc3QgZmVhdHVyZSA9IGdldFJvdXRlKHJvdXRlc1tpXSk7CgkgICAgaWYgKGZlYXR1cmUpIHlpZWxkIGZlYXR1cmU7CgkgIH0KCSAgZm9yIChsZXQgaSA9IDA7IGkgPCB3YXlwb2ludHMubGVuZ3RoOyBpKyspIHsKCSAgICB5aWVsZCBnZXRQb2ludCh3YXlwb2ludHNbaV0pOwoJICB9Cgl9CgoJZnVuY3Rpb24gZ3B4KGRvYykgewoJICByZXR1cm4gewoJICAgIHR5cGU6ICJGZWF0dXJlQ29sbGVjdGlvbiIsCgkgICAgZmVhdHVyZXM6IEFycmF5LmZyb20oZ3B4R2VuKGRvYykpLAoJICB9OwoJfQoKCWNvbnN0IEVYVEVOU0lPTlNfTlMgPSAiaHR0cDovL3d3dy5nYXJtaW4uY29tL3htbHNjaGVtYXMvQWN0aXZpdHlFeHRlbnNpb24vdjIiOwoKCWNvbnN0IFRSQUNLUE9JTlRfQVRUUklCVVRFUyA9IFsKCSAgWyJoZWFydFJhdGUiLCAiaGVhcnRSYXRlcyJdLAoJICBbIkNhZGVuY2UiLCAiY2FkZW5jZXMiXSwKCSAgLy8gRXh0ZW5kZWQgVHJhY2twb2ludCBhdHRyaWJ1dGVzCgkgIFsiU3BlZWQiLCAic3BlZWRzIl0sCgkgIFsiV2F0dHMiLCAid2F0dHMiXSwKCV07CgoJY29uc3QgTEFQX0FUVFJJQlVURVMgPSBbCgkgIFsiVG90YWxUaW1lU2Vjb25kcyIsICJ0b3RhbFRpbWVTZWNvbmRzIl0sCgkgIFsiRGlzdGFuY2VNZXRlcnMiLCAiZGlzdGFuY2VNZXRlcnMiXSwKCSAgWyJNYXhpbXVtU3BlZWQiLCAibWF4U3BlZWQiXSwKCSAgWyJBdmVyYWdlSGVhcnRSYXRlQnBtIiwgImF2Z0hlYXJ0UmF0ZSJdLAoJICBbIk1heGltdW1IZWFydFJhdGVCcG0iLCAibWF4SGVhcnRSYXRlIl0sCgoJICAvLyBFeHRlbmRlZCBMYXAgYXR0cmlidXRlcwoJICBbIkF2Z1NwZWVkIiwgImF2Z1NwZWVkIl0sCgkgIFsiQXZnV2F0dHMiLCAiYXZnV2F0dHMiXSwKCSAgWyJNYXhXYXR0cyIsICJtYXhXYXR0cyJdLAoJXTsKCglmdW5jdGlvbiBmcm9tRW50cmllcyhhcnIpIHsKCSAgY29uc3Qgb2JqID0ge307CgkgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIGFycikgewoJICAgIG9ialtrZXldID0gdmFsdWU7CgkgIH0KCSAgcmV0dXJuIG9iajsKCX0KCglmdW5jdGlvbiBnZXRQcm9wZXJ0aWVzKG5vZGUsIGF0dHJpYnV0ZU5hbWVzKSB7CgkgIGNvbnN0IHByb3BlcnRpZXMgPSBbXTsKCgkgIGZvciAoY29uc3QgW3RhZywgYWxpYXNdIG9mIGF0dHJpYnV0ZU5hbWVzKSB7CgkgICAgbGV0IGVsZW0gPSBnZXQxKG5vZGUsIHRhZyk7CgkgICAgaWYgKCFlbGVtKSB7CgkgICAgICBjb25zdCBlbGVtZW50cyA9IG5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWVOUyhFWFRFTlNJT05TX05TLCB0YWcpOwoJICAgICAgaWYgKGVsZW1lbnRzLmxlbmd0aCkgewoJICAgICAgICBlbGVtID0gZWxlbWVudHNbMF07CgkgICAgICB9CgkgICAgfQoJICAgIGNvbnN0IHZhbCA9IHBhcnNlRmxvYXQobm9kZVZhbChlbGVtKSk7CgkgICAgaWYgKCFpc05hTih2YWwpKSB7CgkgICAgICBwcm9wZXJ0aWVzLnB1c2goW2FsaWFzLCB2YWxdKTsKCSAgICB9CgkgIH0KCgkgIHJldHVybiBwcm9wZXJ0aWVzOwoJfQoKCWZ1bmN0aW9uIGNvb3JkUGFpcih4KSB7CgkgIGNvbnN0IGxvbiA9IG5vZGVWYWwoZ2V0MSh4LCAiTG9uZ2l0dWRlRGVncmVlcyIpKTsKCSAgY29uc3QgbGF0ID0gbm9kZVZhbChnZXQxKHgsICJMYXRpdHVkZURlZ3JlZXMiKSk7CgkgIGlmICghbG9uLmxlbmd0aCB8fCAhbGF0Lmxlbmd0aCkgewoJICAgIHJldHVybiBudWxsOwoJICB9CgkgIGNvbnN0IGxsID0gW3BhcnNlRmxvYXQobG9uKSwgcGFyc2VGbG9hdChsYXQpXTsKCSAgY29uc3QgYWx0ID0gZ2V0MSh4LCAiQWx0aXR1ZGVNZXRlcnMiKTsKCSAgY29uc3QgaGVhcnRSYXRlID0gZ2V0MSh4LCAiSGVhcnRSYXRlQnBtIik7CgkgIGNvbnN0IHRpbWUgPSBnZXQxKHgsICJUaW1lIik7CgkgIGxldCBhOwoJICBpZiAoYWx0KSB7CgkgICAgYSA9IHBhcnNlRmxvYXQobm9kZVZhbChhbHQpKTsKCSAgICBpZiAoIWlzTmFOKGEpKSB7CgkgICAgICBsbC5wdXNoKGEpOwoJICAgIH0KCSAgfQoJICByZXR1cm4gewoJICAgIGNvb3JkaW5hdGVzOiBsbCwKCSAgICB0aW1lOiB0aW1lID8gbm9kZVZhbCh0aW1lKSA6IG51bGwsCgkgICAgaGVhcnRSYXRlOiBoZWFydFJhdGUgPyBwYXJzZUZsb2F0KG5vZGVWYWwoaGVhcnRSYXRlKSkgOiBudWxsLAoJICAgIGV4dGVuc2lvbnM6IGdldFByb3BlcnRpZXMoeCwgVFJBQ0tQT0lOVF9BVFRSSUJVVEVTKSwKCSAgfTsKCX0KCglmdW5jdGlvbiBnZXRQb2ludHMobm9kZSwgcG9pbnRuYW1lKSB7CgkgIGNvbnN0IHB0cyA9IG5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUocG9pbnRuYW1lKTsKCSAgY29uc3QgbGluZSA9IFtdOwoJICBjb25zdCB0aW1lcyA9IFtdOwoJICBjb25zdCBoZWFydFJhdGVzID0gW107CgkgIGlmIChwdHMubGVuZ3RoIDwgMikgcmV0dXJuIG51bGw7IC8vIEludmFsaWQgbGluZSBpbiBHZW9KU09OCgkgIGNvbnN0IHJlc3VsdCA9IHsgZXh0ZW5kZWRQcm9wZXJ0aWVzOiB7fSB9OwoJICBmb3IgKGxldCBpID0gMDsgaSA8IHB0cy5sZW5ndGg7IGkrKykgewoJICAgIGNvbnN0IGMgPSBjb29yZFBhaXIocHRzW2ldKTsKCSAgICBpZiAoYyA9PT0gbnVsbCkgY29udGludWU7CgkgICAgbGluZS5wdXNoKGMuY29vcmRpbmF0ZXMpOwoJICAgIGlmIChjLnRpbWUpIHRpbWVzLnB1c2goYy50aW1lKTsKCSAgICBpZiAoYy5oZWFydFJhdGUpIGhlYXJ0UmF0ZXMucHVzaChjLmhlYXJ0UmF0ZSk7CgkgICAgZm9yIChjb25zdCBbYWxpYXMsIHZhbHVlXSBvZiBjLmV4dGVuc2lvbnMpIHsKCSAgICAgIGlmICghcmVzdWx0LmV4dGVuZGVkUHJvcGVydGllc1thbGlhc10pIHsKCSAgICAgICAgcmVzdWx0LmV4dGVuZGVkUHJvcGVydGllc1thbGlhc10gPSBBcnJheShwdHMubGVuZ3RoKS5maWxsKG51bGwpOwoJICAgICAgfQoJICAgICAgcmVzdWx0LmV4dGVuZGVkUHJvcGVydGllc1thbGlhc11baV0gPSB2YWx1ZTsKCSAgICB9CgkgIH0KCSAgcmV0dXJuIE9iamVjdC5hc3NpZ24ocmVzdWx0LCB7CgkgICAgbGluZTogbGluZSwKCSAgICB0aW1lczogdGltZXMsCgkgICAgaGVhcnRSYXRlczogaGVhcnRSYXRlcywKCSAgfSk7Cgl9CgoJZnVuY3Rpb24gZ2V0TGFwKG5vZGUpIHsKCSAgY29uc3Qgc2VnbWVudHMgPSBub2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJUcmFjayIpOwoJICBjb25zdCB0cmFjayA9IFtdOwoJICBjb25zdCB0aW1lcyA9IFtdOwoJICBjb25zdCBoZWFydFJhdGVzID0gW107CgkgIGNvbnN0IGFsbEV4dGVuZGVkUHJvcGVydGllcyA9IFtdOwoJICBsZXQgbGluZTsKCSAgY29uc3QgcHJvcGVydGllcyA9IGZyb21FbnRyaWVzKGdldFByb3BlcnRpZXMobm9kZSwgTEFQX0FUVFJJQlVURVMpKTsKCgkgIGNvbnN0IG5hbWVFbGVtZW50ID0gZ2V0MShub2RlLCAnTmFtZScpOwoJICBpZiAobmFtZUVsZW1lbnQpIHsKCSAgICBwcm9wZXJ0aWVzLm5hbWUgPSBub2RlVmFsKG5hbWVFbGVtZW50KTsKCSAgfQoKCSAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZWdtZW50cy5sZW5ndGg7IGkrKykgewoJICAgIGxpbmUgPSBnZXRQb2ludHMoc2VnbWVudHNbaV0sICJUcmFja3BvaW50Iik7CgkgICAgaWYgKGxpbmUpIHsKCSAgICAgIHRyYWNrLnB1c2gobGluZS5saW5lKTsKCSAgICAgIGlmIChsaW5lLnRpbWVzLmxlbmd0aCkgdGltZXMucHVzaChsaW5lLnRpbWVzKTsKCSAgICAgIGlmIChsaW5lLmhlYXJ0UmF0ZXMubGVuZ3RoKSBoZWFydFJhdGVzLnB1c2gobGluZS5oZWFydFJhdGVzKTsKCSAgICAgIGFsbEV4dGVuZGVkUHJvcGVydGllcy5wdXNoKGxpbmUuZXh0ZW5kZWRQcm9wZXJ0aWVzKTsKCSAgICB9CgkgIH0KCSAgZm9yIChsZXQgaSA9IDA7IGkgPCBhbGxFeHRlbmRlZFByb3BlcnRpZXMubGVuZ3RoOyBpKyspIHsKCSAgICBjb25zdCBleHRlbmRlZFByb3BlcnRpZXMgPSBhbGxFeHRlbmRlZFByb3BlcnRpZXNbaV07CgkgICAgZm9yIChjb25zdCBwcm9wZXJ0eSBpbiBleHRlbmRlZFByb3BlcnRpZXMpIHsKCSAgICAgIGlmIChzZWdtZW50cy5sZW5ndGggPT09IDEpIHsKCSAgICAgICAgcHJvcGVydGllc1twcm9wZXJ0eV0gPSBsaW5lLmV4dGVuZGVkUHJvcGVydGllc1twcm9wZXJ0eV07CgkgICAgICB9IGVsc2UgewoJICAgICAgICBpZiAoIXByb3BlcnRpZXNbcHJvcGVydHldKSB7CgkgICAgICAgICAgcHJvcGVydGllc1twcm9wZXJ0eV0gPSB0cmFjay5tYXAoKHRyYWNrKSA9PgoJICAgICAgICAgICAgQXJyYXkodHJhY2subGVuZ3RoKS5maWxsKG51bGwpCgkgICAgICAgICAgKTsKCSAgICAgICAgfQoJICAgICAgICBwcm9wZXJ0aWVzW3Byb3BlcnR5XVtpXSA9IGV4dGVuZGVkUHJvcGVydGllc1twcm9wZXJ0eV07CgkgICAgICB9CgkgICAgfQoJICB9CgkgIGlmICh0cmFjay5sZW5ndGggPT09IDApIHJldHVybjsKCgkgIGlmICh0aW1lcy5sZW5ndGggfHwgaGVhcnRSYXRlcy5sZW5ndGgpIHsKCSAgICBwcm9wZXJ0aWVzLmNvb3JkaW5hdGVQcm9wZXJ0aWVzID0gT2JqZWN0LmFzc2lnbigKCSAgICAgIHRpbWVzLmxlbmd0aAoJICAgICAgICA/IHsKCSAgICAgICAgICAgIHRpbWVzOiB0cmFjay5sZW5ndGggPT09IDEgPyB0aW1lc1swXSA6IHRpbWVzLAoJICAgICAgICAgIH0KCSAgICAgICAgOiB7fSwKCSAgICAgIGhlYXJ0UmF0ZXMubGVuZ3RoCgkgICAgICAgID8gewoJICAgICAgICAgICAgaGVhcnQ6IHRyYWNrLmxlbmd0aCA9PT0gMSA/IGhlYXJ0UmF0ZXNbMF0gOiBoZWFydFJhdGVzLAoJICAgICAgICAgIH0KCSAgICAgICAgOiB7fQoJICAgICk7CgkgIH0KCgkgIHJldHVybiB7CgkgICAgdHlwZTogIkZlYXR1cmUiLAoJICAgIHByb3BlcnRpZXM6IHByb3BlcnRpZXMsCgkgICAgZ2VvbWV0cnk6IHsKCSAgICAgIHR5cGU6IHRyYWNrLmxlbmd0aCA9PT0gMSA/ICJMaW5lU3RyaW5nIiA6ICJNdWx0aUxpbmVTdHJpbmciLAoJICAgICAgY29vcmRpbmF0ZXM6IHRyYWNrLmxlbmd0aCA9PT0gMSA/IHRyYWNrWzBdIDogdHJhY2ssCgkgICAgfSwKCSAgfTsKCX0KCglmdW5jdGlvbiogdGN4R2VuKGRvYykgewoJICBjb25zdCBsYXBzID0gZG9jLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJMYXAiKTsKCgkgIGZvciAobGV0IGkgPSAwOyBpIDwgbGFwcy5sZW5ndGg7IGkrKykgewoJICAgIGNvbnN0IGZlYXR1cmUgPSBnZXRMYXAobGFwc1tpXSk7CgkgICAgaWYgKGZlYXR1cmUpIHlpZWxkIGZlYXR1cmU7CgkgIH0KCgkgIGNvbnN0IGNvdXJzZXMgPSBkb2MuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIkNvdXJzZXMiKTsKCgkgIGZvciAobGV0IGkgPSAwOyBpIDwgY291cnNlcy5sZW5ndGg7IGkrKykgewoJICAgIGNvbnN0IGZlYXR1cmUgPSBnZXRMYXAoY291cnNlc1tpXSk7CgkgICAgaWYgKGZlYXR1cmUpIHlpZWxkIGZlYXR1cmU7CgkgIH0KCX0KCglmdW5jdGlvbiB0Y3goZG9jKSB7CgkgIHJldHVybiB7CgkgICAgdHlwZTogIkZlYXR1cmVDb2xsZWN0aW9uIiwKCSAgICBmZWF0dXJlczogQXJyYXkuZnJvbSh0Y3hHZW4oZG9jKSksCgkgIH07Cgl9CgoJY29uc3QgcmVtb3ZlU3BhY2UgPSAvXHMqL2c7Cgljb25zdCB0cmltU3BhY2UgPSAvXlxzKnxccyokL2c7Cgljb25zdCBzcGxpdFNwYWNlID0gL1xzKy87CgoJLy8gZ2VuZXJhdGUgYSBzaG9ydCwgbnVtZXJpYyBoYXNoIG9mIGEgc3RyaW5nCglmdW5jdGlvbiBva2hhc2goeCkgewoJICBpZiAoIXggfHwgIXgubGVuZ3RoKSByZXR1cm4gMDsKCSAgbGV0IGggPSAwOwoJICBmb3IgKGxldCBpID0gMDsgaSA8IHgubGVuZ3RoOyBpKyspIHsKCSAgICBoID0gKChoIDw8IDUpIC0gaCArIHguY2hhckNvZGVBdChpKSkgfCAwOwoJICB9CgkgIHJldHVybiBoOwoJfQoKCS8vIGdldCBvbmUgY29vcmRpbmF0ZSBmcm9tIGEgY29vcmRpbmF0ZSBhcnJheSwgaWYgYW55CglmdW5jdGlvbiBjb29yZDEodikgewoJICByZXR1cm4gdi5yZXBsYWNlKHJlbW92ZVNwYWNlLCAiIikuc3BsaXQoIiwiKS5tYXAocGFyc2VGbG9hdCk7Cgl9CgoJLy8gZ2V0IGFsbCBjb29yZGluYXRlcyBmcm9tIGEgY29vcmRpbmF0ZSBhcnJheSBhcyBbW10sW11dCglmdW5jdGlvbiBjb29yZCh2KSB7CgkgIHJldHVybiB2LnJlcGxhY2UodHJpbVNwYWNlLCAiIikuc3BsaXQoc3BsaXRTcGFjZSkubWFwKGNvb3JkMSk7Cgl9CgoJZnVuY3Rpb24geG1sMnN0cihub2RlKSB7CgkgIGlmIChub2RlLnhtbCAhPT0gdW5kZWZpbmVkKSByZXR1cm4gbm9kZS54bWw7CgkgIGlmIChub2RlLnRhZ05hbWUpIHsKCSAgICBsZXQgb3V0cHV0ID0gbm9kZS50YWdOYW1lOwoJICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5hdHRyaWJ1dGVzLmxlbmd0aDsgaSsrKSB7CgkgICAgICBvdXRwdXQgKz0gbm9kZS5hdHRyaWJ1dGVzW2ldLm5hbWUgKyBub2RlLmF0dHJpYnV0ZXNbaV0udmFsdWU7CgkgICAgfQoJICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5jaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7CgkgICAgICBvdXRwdXQgKz0geG1sMnN0cihub2RlLmNoaWxkTm9kZXNbaV0pOwoJICAgIH0KCSAgICByZXR1cm4gb3V0cHV0OwoJICB9CgkgIGlmIChub2RlLm5vZGVOYW1lID09PSAiI3RleHQiKSB7CgkgICAgcmV0dXJuIChub2RlLm5vZGVWYWx1ZSB8fCBub2RlLnZhbHVlIHx8ICIiKS50cmltKCk7CgkgIH0KCSAgaWYgKG5vZGUubm9kZU5hbWUgPT09ICIjY2RhdGEtc2VjdGlvbiIpIHsKCSAgICByZXR1cm4gbm9kZS5ub2RlVmFsdWU7CgkgIH0KCSAgcmV0dXJuICIiOwoJfQoKCWNvbnN0IGdlb3R5cGVzID0gWyJQb2x5Z29uIiwgIkxpbmVTdHJpbmciLCAiUG9pbnQiLCAiVHJhY2siLCAiZ3g6VHJhY2siXTsKCglmdW5jdGlvbiBrbWxDb2xvcihwcm9wZXJ0aWVzLCBlbGVtLCBwcmVmaXgpIHsKCSAgbGV0IHYgPSBub2RlVmFsKGdldDEoZWxlbSwgImNvbG9yIikpIHx8ICIiOwoJICBjb25zdCBjb2xvclByb3AgPQoJICAgIHByZWZpeCA9PSAic3Ryb2tlIiB8fCBwcmVmaXggPT09ICJmaWxsIiA/IHByZWZpeCA6IHByZWZpeCArICItY29sb3IiOwoJICBpZiAodi5zdWJzdHIoMCwgMSkgPT09ICIjIikgewoJICAgIHYgPSB2LnN1YnN0cigxKTsKCSAgfQoJICBpZiAodi5sZW5ndGggPT09IDYgfHwgdi5sZW5ndGggPT09IDMpIHsKCSAgICBwcm9wZXJ0aWVzW2NvbG9yUHJvcF0gPSB2OwoJICB9IGVsc2UgaWYgKHYubGVuZ3RoID09PSA4KSB7CgkgICAgcHJvcGVydGllc1twcmVmaXggKyAiLW9wYWNpdHkiXSA9IHBhcnNlSW50KHYuc3Vic3RyKDAsIDIpLCAxNikgLyAyNTU7CgkgICAgcHJvcGVydGllc1tjb2xvclByb3BdID0KCSAgICAgICIjIiArIHYuc3Vic3RyKDYsIDIpICsgdi5zdWJzdHIoNCwgMikgKyB2LnN1YnN0cigyLCAyKTsKCSAgfQoJfQoKCWZ1bmN0aW9uIG51bWVyaWNQcm9wZXJ0eShwcm9wZXJ0aWVzLCBlbGVtLCBzb3VyY2UsIHRhcmdldCkgewoJICBjb25zdCB2YWwgPSBwYXJzZUZsb2F0KG5vZGVWYWwoZ2V0MShlbGVtLCBzb3VyY2UpKSk7CgkgIGlmICghaXNOYU4odmFsKSkgcHJvcGVydGllc1t0YXJnZXRdID0gdmFsOwoJfQoKCWZ1bmN0aW9uIGd4Q29vcmRzKHJvb3QpIHsKCSAgbGV0IGVsZW1zID0gcm9vdC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiY29vcmQiKTsKCSAgY29uc3QgY29vcmRzID0gW107CgkgIGNvbnN0IHRpbWVzID0gW107CgkgIGlmIChlbGVtcy5sZW5ndGggPT09IDApIGVsZW1zID0gcm9vdC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiZ3g6Y29vcmQiKTsKCSAgZm9yIChsZXQgaSA9IDA7IGkgPCBlbGVtcy5sZW5ndGg7IGkrKykgewoJICAgIGNvb3Jkcy5wdXNoKG5vZGVWYWwoZWxlbXNbaV0pLnNwbGl0KCIgIikubWFwKHBhcnNlRmxvYXQpKTsKCSAgfQoJICBjb25zdCB0aW1lRWxlbXMgPSByb290LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ3aGVuIik7CgkgIGZvciAobGV0IGogPSAwOyBqIDwgdGltZUVsZW1zLmxlbmd0aDsgaisrKSB0aW1lcy5wdXNoKG5vZGVWYWwodGltZUVsZW1zW2pdKSk7CgkgIHJldHVybiB7CgkgICAgY29vcmRzOiBjb29yZHMsCgkgICAgdGltZXM6IHRpbWVzLAoJICB9OwoJfQoKCWZ1bmN0aW9uIGdldEdlb21ldHJ5KHJvb3QpIHsKCSAgbGV0IGdlb21Ob2RlOwoJICBsZXQgZ2VvbU5vZGVzOwoJICBsZXQgaTsKCSAgbGV0IGo7CgkgIGxldCBrOwoJICBjb25zdCBnZW9tcyA9IFtdOwoJICBjb25zdCBjb29yZFRpbWVzID0gW107CgkgIGlmIChnZXQxKHJvb3QsICJNdWx0aUdlb21ldHJ5IikpIHsKCSAgICByZXR1cm4gZ2V0R2VvbWV0cnkoZ2V0MShyb290LCAiTXVsdGlHZW9tZXRyeSIpKTsKCSAgfQoJICBpZiAoZ2V0MShyb290LCAiTXVsdGlUcmFjayIpKSB7CgkgICAgcmV0dXJuIGdldEdlb21ldHJ5KGdldDEocm9vdCwgIk11bHRpVHJhY2siKSk7CgkgIH0KCSAgaWYgKGdldDEocm9vdCwgImd4Ok11bHRpVHJhY2siKSkgewoJICAgIHJldHVybiBnZXRHZW9tZXRyeShnZXQxKHJvb3QsICJneDpNdWx0aVRyYWNrIikpOwoJICB9CgkgIGZvciAoaSA9IDA7IGkgPCBnZW90eXBlcy5sZW5ndGg7IGkrKykgewoJICAgIGdlb21Ob2RlcyA9IHJvb3QuZ2V0RWxlbWVudHNCeVRhZ05hbWUoZ2VvdHlwZXNbaV0pOwoJICAgIGlmIChnZW9tTm9kZXMpIHsKCSAgICAgIGZvciAoaiA9IDA7IGogPCBnZW9tTm9kZXMubGVuZ3RoOyBqKyspIHsKCSAgICAgICAgZ2VvbU5vZGUgPSBnZW9tTm9kZXNbal07CgkgICAgICAgIGlmIChnZW90eXBlc1tpXSA9PT0gIlBvaW50IikgewoJICAgICAgICAgIGdlb21zLnB1c2goewoJICAgICAgICAgICAgdHlwZTogIlBvaW50IiwKCSAgICAgICAgICAgIGNvb3JkaW5hdGVzOiBjb29yZDEobm9kZVZhbChnZXQxKGdlb21Ob2RlLCAiY29vcmRpbmF0ZXMiKSkpLAoJICAgICAgICAgIH0pOwoJICAgICAgICB9IGVsc2UgaWYgKGdlb3R5cGVzW2ldID09PSAiTGluZVN0cmluZyIpIHsKCSAgICAgICAgICBnZW9tcy5wdXNoKHsKCSAgICAgICAgICAgIHR5cGU6ICJMaW5lU3RyaW5nIiwKCSAgICAgICAgICAgIGNvb3JkaW5hdGVzOiBjb29yZChub2RlVmFsKGdldDEoZ2VvbU5vZGUsICJjb29yZGluYXRlcyIpKSksCgkgICAgICAgICAgfSk7CgkgICAgICAgIH0gZWxzZSBpZiAoZ2VvdHlwZXNbaV0gPT09ICJQb2x5Z29uIikgewoJICAgICAgICAgIGNvbnN0IHJpbmdzID0gZ2VvbU5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIkxpbmVhclJpbmciKSwKCSAgICAgICAgICAgIGNvb3JkcyA9IFtdOwoJICAgICAgICAgIGZvciAoayA9IDA7IGsgPCByaW5ncy5sZW5ndGg7IGsrKykgewoJICAgICAgICAgICAgY29vcmRzLnB1c2goY29vcmQobm9kZVZhbChnZXQxKHJpbmdzW2tdLCAiY29vcmRpbmF0ZXMiKSkpKTsKCSAgICAgICAgICB9CgkgICAgICAgICAgZ2VvbXMucHVzaCh7CgkgICAgICAgICAgICB0eXBlOiAiUG9seWdvbiIsCgkgICAgICAgICAgICBjb29yZGluYXRlczogY29vcmRzLAoJICAgICAgICAgIH0pOwoJICAgICAgICB9IGVsc2UgaWYgKGdlb3R5cGVzW2ldID09PSAiVHJhY2siIHx8IGdlb3R5cGVzW2ldID09PSAiZ3g6VHJhY2siKSB7CgkgICAgICAgICAgY29uc3QgdHJhY2sgPSBneENvb3JkcyhnZW9tTm9kZSk7CgkgICAgICAgICAgZ2VvbXMucHVzaCh7CgkgICAgICAgICAgICB0eXBlOiAiTGluZVN0cmluZyIsCgkgICAgICAgICAgICBjb29yZGluYXRlczogdHJhY2suY29vcmRzLAoJICAgICAgICAgIH0pOwoJICAgICAgICAgIGlmICh0cmFjay50aW1lcy5sZW5ndGgpIGNvb3JkVGltZXMucHVzaCh0cmFjay50aW1lcyk7CgkgICAgICAgIH0KCSAgICAgIH0KCSAgICB9CgkgIH0KCSAgcmV0dXJuIHsKCSAgICBnZW9tczogZ2VvbXMsCgkgICAgY29vcmRUaW1lczogY29vcmRUaW1lcywKCSAgfTsKCX0KCglmdW5jdGlvbiBnZXRQbGFjZW1hcmsocm9vdCwgc3R5bGVJbmRleCwgc3R5bGVNYXBJbmRleCwgc3R5bGVCeUhhc2gpIHsKCSAgY29uc3QgZ2VvbXNBbmRUaW1lcyA9IGdldEdlb21ldHJ5KHJvb3QpOwoJICBsZXQgaTsKCSAgY29uc3QgcHJvcGVydGllcyA9IHt9OwoJICBjb25zdCBuYW1lID0gbm9kZVZhbChnZXQxKHJvb3QsICJuYW1lIikpOwoJICBjb25zdCBhZGRyZXNzID0gbm9kZVZhbChnZXQxKHJvb3QsICJhZGRyZXNzIikpOwoJICBsZXQgc3R5bGVVcmwgPSBub2RlVmFsKGdldDEocm9vdCwgInN0eWxlVXJsIikpOwoJICBjb25zdCBkZXNjcmlwdGlvbiA9IG5vZGVWYWwoZ2V0MShyb290LCAiZGVzY3JpcHRpb24iKSk7CgkgIGNvbnN0IHRpbWVTcGFuID0gZ2V0MShyb290LCAiVGltZVNwYW4iKTsKCSAgY29uc3QgdGltZVN0YW1wID0gZ2V0MShyb290LCAiVGltZVN0YW1wIik7CgkgIGNvbnN0IGV4dGVuZGVkRGF0YSA9IGdldDEocm9vdCwgIkV4dGVuZGVkRGF0YSIpOwoJICBsZXQgaWNvblN0eWxlID0gZ2V0MShyb290LCAiSWNvblN0eWxlIik7CgkgIGxldCBsYWJlbFN0eWxlID0gZ2V0MShyb290LCAiTGFiZWxTdHlsZSIpOwoJICBsZXQgbGluZVN0eWxlID0gZ2V0MShyb290LCAiTGluZVN0eWxlIik7CgkgIGxldCBwb2x5U3R5bGUgPSBnZXQxKHJvb3QsICJQb2x5U3R5bGUiKTsKCSAgY29uc3QgdmlzaWJpbGl0eSA9IGdldDEocm9vdCwgInZpc2liaWxpdHkiKTsKCgkgIGlmIChuYW1lKSBwcm9wZXJ0aWVzLm5hbWUgPSBuYW1lOwoJICBpZiAoYWRkcmVzcykgcHJvcGVydGllcy5hZGRyZXNzID0gYWRkcmVzczsKCSAgaWYgKHN0eWxlVXJsKSB7CgkgICAgaWYgKHN0eWxlVXJsWzBdICE9PSAiIyIpIHsKCSAgICAgIHN0eWxlVXJsID0gIiMiICsgc3R5bGVVcmw7CgkgICAgfQoKCSAgICBwcm9wZXJ0aWVzLnN0eWxlVXJsID0gc3R5bGVVcmw7CgkgICAgaWYgKHN0eWxlSW5kZXhbc3R5bGVVcmxdKSB7CgkgICAgICBwcm9wZXJ0aWVzLnN0eWxlSGFzaCA9IHN0eWxlSW5kZXhbc3R5bGVVcmxdOwoJICAgIH0KCSAgICBpZiAoc3R5bGVNYXBJbmRleFtzdHlsZVVybF0pIHsKCSAgICAgIHByb3BlcnRpZXMuc3R5bGVNYXBIYXNoID0gc3R5bGVNYXBJbmRleFtzdHlsZVVybF07CgkgICAgICBwcm9wZXJ0aWVzLnN0eWxlSGFzaCA9IHN0eWxlSW5kZXhbc3R5bGVNYXBJbmRleFtzdHlsZVVybF0ubm9ybWFsXTsKCSAgICB9CgkgICAgLy8gVHJ5IHRvIHBvcHVsYXRlIHRoZSBsaW5lU3R5bGUgb3IgcG9seVN0eWxlIHNpbmNlIHdlIGdvdCB0aGUgc3R5bGUgaGFzaAoJICAgIGNvbnN0IHN0eWxlID0gc3R5bGVCeUhhc2hbcHJvcGVydGllcy5zdHlsZUhhc2hdOwoJICAgIGlmIChzdHlsZSkgewoJICAgICAgaWYgKCFpY29uU3R5bGUpIGljb25TdHlsZSA9IGdldDEoc3R5bGUsICJJY29uU3R5bGUiKTsKCSAgICAgIGlmICghbGFiZWxTdHlsZSkgbGFiZWxTdHlsZSA9IGdldDEoc3R5bGUsICJMYWJlbFN0eWxlIik7CgkgICAgICBpZiAoIWxpbmVTdHlsZSkgbGluZVN0eWxlID0gZ2V0MShzdHlsZSwgIkxpbmVTdHlsZSIpOwoJICAgICAgaWYgKCFwb2x5U3R5bGUpIHBvbHlTdHlsZSA9IGdldDEoc3R5bGUsICJQb2x5U3R5bGUiKTsKCSAgICB9CgkgIH0KCSAgaWYgKGRlc2NyaXB0aW9uKSBwcm9wZXJ0aWVzLmRlc2NyaXB0aW9uID0gZGVzY3JpcHRpb247CgkgIGlmICh0aW1lU3BhbikgewoJICAgIGNvbnN0IGJlZ2luID0gbm9kZVZhbChnZXQxKHRpbWVTcGFuLCAiYmVnaW4iKSk7CgkgICAgY29uc3QgZW5kID0gbm9kZVZhbChnZXQxKHRpbWVTcGFuLCAiZW5kIikpOwoJICAgIHByb3BlcnRpZXMudGltZXNwYW4gPSB7IGJlZ2luOiBiZWdpbiwgZW5kOiBlbmQgfTsKCSAgfQoJICBpZiAodGltZVN0YW1wKSB7CgkgICAgcHJvcGVydGllcy50aW1lc3RhbXAgPSBub2RlVmFsKGdldDEodGltZVN0YW1wLCAid2hlbiIpKTsKCSAgfQoJICBpZiAoaWNvblN0eWxlKSB7CgkgICAga21sQ29sb3IocHJvcGVydGllcywgaWNvblN0eWxlLCAiaWNvbiIpOwoJICAgIG51bWVyaWNQcm9wZXJ0eShwcm9wZXJ0aWVzLCBpY29uU3R5bGUsICJzY2FsZSIsICJpY29uLXNjYWxlIik7CgkgICAgbnVtZXJpY1Byb3BlcnR5KHByb3BlcnRpZXMsIGljb25TdHlsZSwgImhlYWRpbmciLCAiaWNvbi1oZWFkaW5nIik7CgoJICAgIGNvbnN0IGhvdHNwb3QgPSBnZXQxKGljb25TdHlsZSwgImhvdFNwb3QiKTsKCSAgICBpZiAoaG90c3BvdCkgewoJICAgICAgY29uc3QgbGVmdCA9IHBhcnNlRmxvYXQoaG90c3BvdC5nZXRBdHRyaWJ1dGUoIngiKSk7CgkgICAgICBjb25zdCB0b3AgPSBwYXJzZUZsb2F0KGhvdHNwb3QuZ2V0QXR0cmlidXRlKCJ5IikpOwoJICAgICAgaWYgKCFpc05hTihsZWZ0KSAmJiAhaXNOYU4odG9wKSkgcHJvcGVydGllc1siaWNvbi1vZmZzZXQiXSA9IFtsZWZ0LCB0b3BdOwoJICAgIH0KCSAgICBjb25zdCBpY29uID0gZ2V0MShpY29uU3R5bGUsICJJY29uIik7CgkgICAgaWYgKGljb24pIHsKCSAgICAgIGNvbnN0IGhyZWYgPSBub2RlVmFsKGdldDEoaWNvbiwgImhyZWYiKSk7CgkgICAgICBpZiAoaHJlZikgcHJvcGVydGllcy5pY29uID0gaHJlZjsKCSAgICB9CgkgIH0KCSAgaWYgKGxhYmVsU3R5bGUpIHsKCSAgICBrbWxDb2xvcihwcm9wZXJ0aWVzLCBsYWJlbFN0eWxlLCAibGFiZWwiKTsKCSAgICBudW1lcmljUHJvcGVydHkocHJvcGVydGllcywgbGFiZWxTdHlsZSwgInNjYWxlIiwgImxhYmVsLXNjYWxlIik7CgkgIH0KCSAgaWYgKGxpbmVTdHlsZSkgewoJICAgIGttbENvbG9yKHByb3BlcnRpZXMsIGxpbmVTdHlsZSwgInN0cm9rZSIpOwoJICAgIG51bWVyaWNQcm9wZXJ0eShwcm9wZXJ0aWVzLCBsaW5lU3R5bGUsICJ3aWR0aCIsICJzdHJva2Utd2lkdGgiKTsKCSAgfQoJICBpZiAocG9seVN0eWxlKSB7CgkgICAga21sQ29sb3IocHJvcGVydGllcywgcG9seVN0eWxlLCAiZmlsbCIpOwoJICAgIGNvbnN0IGZpbGwgPSBub2RlVmFsKGdldDEocG9seVN0eWxlLCAiZmlsbCIpKTsKCSAgICBjb25zdCBvdXRsaW5lID0gbm9kZVZhbChnZXQxKHBvbHlTdHlsZSwgIm91dGxpbmUiKSk7CgkgICAgaWYgKGZpbGwpCgkgICAgICBwcm9wZXJ0aWVzWyJmaWxsLW9wYWNpdHkiXSA9CgkgICAgICAgIGZpbGwgPT09ICIxIiA/IHByb3BlcnRpZXNbImZpbGwtb3BhY2l0eSJdIHx8IDEgOiAwOwoJICAgIGlmIChvdXRsaW5lKQoJICAgICAgcHJvcGVydGllc1sic3Ryb2tlLW9wYWNpdHkiXSA9CgkgICAgICAgIG91dGxpbmUgPT09ICIxIiA/IHByb3BlcnRpZXNbInN0cm9rZS1vcGFjaXR5Il0gfHwgMSA6IDA7CgkgIH0KCSAgaWYgKGV4dGVuZGVkRGF0YSkgewoJICAgIGNvbnN0IGRhdGFzID0gZXh0ZW5kZWREYXRhLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJEYXRhIiksCgkgICAgICBzaW1wbGVEYXRhcyA9IGV4dGVuZGVkRGF0YS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiU2ltcGxlRGF0YSIpOwoKCSAgICBmb3IgKGkgPSAwOyBpIDwgZGF0YXMubGVuZ3RoOyBpKyspIHsKCSAgICAgIHByb3BlcnRpZXNbZGF0YXNbaV0uZ2V0QXR0cmlidXRlKCJuYW1lIildID0gbm9kZVZhbCgKCSAgICAgICAgZ2V0MShkYXRhc1tpXSwgInZhbHVlIikKCSAgICAgICk7CgkgICAgfQoJICAgIGZvciAoaSA9IDA7IGkgPCBzaW1wbGVEYXRhcy5sZW5ndGg7IGkrKykgewoJICAgICAgcHJvcGVydGllc1tzaW1wbGVEYXRhc1tpXS5nZXRBdHRyaWJ1dGUoIm5hbWUiKV0gPSBub2RlVmFsKHNpbXBsZURhdGFzW2ldKTsKCSAgICB9CgkgIH0KCSAgaWYgKHZpc2liaWxpdHkpIHsKCSAgICBwcm9wZXJ0aWVzLnZpc2liaWxpdHkgPSBub2RlVmFsKHZpc2liaWxpdHkpOwoJICB9CgkgIGlmIChnZW9tc0FuZFRpbWVzLmNvb3JkVGltZXMubGVuZ3RoKSB7CgkgICAgcHJvcGVydGllcy5jb29yZGluYXRlUHJvcGVydGllcyA9IHsKCSAgICAgIHRpbWVzOiBnZW9tc0FuZFRpbWVzLmNvb3JkVGltZXMubGVuZ3RoID09PSAxCgkgICAgICAgID8gZ2VvbXNBbmRUaW1lcy5jb29yZFRpbWVzWzBdCgkgICAgICAgIDogZ2VvbXNBbmRUaW1lcy5jb29yZFRpbWVzCgkgICAgfTsKCSAgfQoJICBjb25zdCBmZWF0dXJlID0gewoJICAgIHR5cGU6ICJGZWF0dXJlIiwKCSAgICBnZW9tZXRyeToKCSAgICAgIGdlb21zQW5kVGltZXMuZ2VvbXMubGVuZ3RoID09PSAwCgkgICAgICAgID8gbnVsbAoJICAgICAgICA6IGdlb21zQW5kVGltZXMuZ2VvbXMubGVuZ3RoID09PSAxCgkgICAgICAgID8gZ2VvbXNBbmRUaW1lcy5nZW9tc1swXQoJICAgICAgICA6IHsKCSAgICAgICAgICAgIHR5cGU6ICJHZW9tZXRyeUNvbGxlY3Rpb24iLAoJICAgICAgICAgICAgZ2VvbWV0cmllczogZ2VvbXNBbmRUaW1lcy5nZW9tcywKCSAgICAgICAgICB9LAoJICAgIHByb3BlcnRpZXM6IHByb3BlcnRpZXMsCgkgIH07CgkgIGlmIChyb290LmdldEF0dHJpYnV0ZSgiaWQiKSkgZmVhdHVyZS5pZCA9IHJvb3QuZ2V0QXR0cmlidXRlKCJpZCIpOwoJICByZXR1cm4gZmVhdHVyZTsKCX0KCglmdW5jdGlvbioga21sR2VuKGRvYykgewoJICAvLyBzdHlsZWluZGV4IGtlZXBzIHRyYWNrIG9mIGhhc2hlZCBzdHlsZXMgaW4gb3JkZXIgdG8gbWF0Y2ggZmVhdHVyZQoJICBjb25zdCBzdHlsZUluZGV4ID0ge307CgkgIGNvbnN0IHN0eWxlQnlIYXNoID0ge307CgkgIC8vIHN0eWxlbWFwaW5kZXgga2VlcHMgdHJhY2sgb2Ygc3R5bGUgbWFwcyB0byBleHBvc2UgaW4gcHJvcGVydGllcwoJICBjb25zdCBzdHlsZU1hcEluZGV4ID0ge307CgkgIC8vIGF0b21pYyBnZW9zcGF0aWFsIHR5cGVzIHN1cHBvcnRlZCBieSBLTUwgLSBNdWx0aUdlb21ldHJ5IGlzCgkgIC8vIGhhbmRsZWQgc2VwYXJhdGVseQoJICAvLyBhbGwgcm9vdCBwbGFjZW1hcmtzIGluIHRoZSBmaWxlCgkgIGNvbnN0IHBsYWNlbWFya3MgPSBkb2MuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIlBsYWNlbWFyayIpOwoJICBjb25zdCBzdHlsZXMgPSBkb2MuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIlN0eWxlIik7CgkgIGNvbnN0IHN0eWxlTWFwcyA9IGRvYy5nZXRFbGVtZW50c0J5VGFnTmFtZSgiU3R5bGVNYXAiKTsKCgkgIGZvciAobGV0IGsgPSAwOyBrIDwgc3R5bGVzLmxlbmd0aDsgaysrKSB7CgkgICAgY29uc3QgaGFzaCA9IG9raGFzaCh4bWwyc3RyKHN0eWxlc1trXSkpLnRvU3RyaW5nKDE2KTsKCSAgICBzdHlsZUluZGV4WyIjIiArIHN0eWxlc1trXS5nZXRBdHRyaWJ1dGUoImlkIildID0gaGFzaDsKCSAgICBzdHlsZUJ5SGFzaFtoYXNoXSA9IHN0eWxlc1trXTsKCSAgfQoJICBmb3IgKGxldCBsID0gMDsgbCA8IHN0eWxlTWFwcy5sZW5ndGg7IGwrKykgewoJICAgIHN0eWxlSW5kZXhbIiMiICsgc3R5bGVNYXBzW2xdLmdldEF0dHJpYnV0ZSgiaWQiKV0gPSBva2hhc2goCgkgICAgICB4bWwyc3RyKHN0eWxlTWFwc1tsXSkKCSAgICApLnRvU3RyaW5nKDE2KTsKCSAgICBjb25zdCBwYWlycyA9IHN0eWxlTWFwc1tsXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiUGFpciIpOwoJICAgIGNvbnN0IHBhaXJzTWFwID0ge307CgkgICAgZm9yIChsZXQgbSA9IDA7IG0gPCBwYWlycy5sZW5ndGg7IG0rKykgewoJICAgICAgcGFpcnNNYXBbbm9kZVZhbChnZXQxKHBhaXJzW21dLCAia2V5IikpXSA9IG5vZGVWYWwoCgkgICAgICAgIGdldDEocGFpcnNbbV0sICJzdHlsZVVybCIpCgkgICAgICApOwoJICAgIH0KCSAgICBzdHlsZU1hcEluZGV4WyIjIiArIHN0eWxlTWFwc1tsXS5nZXRBdHRyaWJ1dGUoImlkIildID0gcGFpcnNNYXA7CgkgIH0KCSAgZm9yIChsZXQgaiA9IDA7IGogPCBwbGFjZW1hcmtzLmxlbmd0aDsgaisrKSB7CgkgICAgY29uc3QgZmVhdHVyZSA9IGdldFBsYWNlbWFyaygKCSAgICAgIHBsYWNlbWFya3Nbal0sCgkgICAgICBzdHlsZUluZGV4LAoJICAgICAgc3R5bGVNYXBJbmRleCwKCSAgICAgIHN0eWxlQnlIYXNoCgkgICAgKTsKCSAgICBpZiAoZmVhdHVyZSkgeWllbGQgZmVhdHVyZTsKCSAgfQoJfQoKCWZ1bmN0aW9uIGttbChkb2MpIHsKCSAgcmV0dXJuIHsKCSAgICB0eXBlOiAiRmVhdHVyZUNvbGxlY3Rpb24iLAoJICAgIGZlYXR1cmVzOiBBcnJheS5mcm9tKGttbEdlbihkb2MpKSwKCSAgfTsKCX0KCgl2YXIgZ3B4XzEgPSB0b2dlb2pzb24uZ3B4ID0gZ3B4OwoJdmFyIGdweEdlbl8xID0gdG9nZW9qc29uLmdweEdlbiA9IGdweEdlbjsKCXZhciBrbWxfMSA9IHRvZ2VvanNvbi5rbWwgPSBrbWw7Cgl2YXIga21sR2VuXzEgPSB0b2dlb2pzb24ua21sR2VuID0ga21sR2VuOwoJdmFyIHRjeF8xID0gdG9nZW9qc29uLnRjeCA9IHRjeDsKCXZhciB0Y3hHZW5fMSA9IHRvZ2VvanNvbi50Y3hHZW4gPSB0Y3hHZW47CgoJdmFyIHRvR2VvSnNvbiA9IC8qI19fUFVSRV9fKi9PYmplY3QuZnJlZXplKC8qI19fUFVSRV9fKi9fbWVyZ2VOYW1lc3BhY2VzKHsKCQlfX3Byb3RvX186IG51bGwsCgkJZ3B4OiBncHhfMSwKCQlncHhHZW46IGdweEdlbl8xLAoJCWttbDoga21sXzEsCgkJa21sR2VuOiBrbWxHZW5fMSwKCQl0Y3g6IHRjeF8xLAoJCXRjeEdlbjogdGN4R2VuXzEsCgkJJ2RlZmF1bHQnOiB0b2dlb2pzb24KCX0sIFt0b2dlb2pzb25dKSk7CgoJY2xhc3MgQ29udmVydGVyIHsNCgkgICAgY29uc3RydWN0b3IoZm9ybWF0LCBkYXRhKSB7DQoJICAgICAgICB0aGlzLmJsYW5rR2VvSlNPTiA9ICgpID0+ICh7DQoJICAgICAgICAgICAgJ3R5cGUnOiAnRmVhdHVyZUNvbGxlY3Rpb24nLA0KCSAgICAgICAgICAgICdmZWF0dXJlcyc6IFtdDQoJICAgICAgICB9KTsNCgkgICAgICAgIHRoaXMuX3Jhd0RhdGEgPSBkYXRhOw0KCSAgICAgICAgdGhpcy5fZm9ybWF0ID0gZm9ybWF0Ow0KCSAgICAgICAgY29uc3QgY29udmVydGVycyA9IHsNCgkgICAgICAgICAgICAndG9wb2pzb24nOiB0aGlzLmxvYWRUb3BvSnNvbiwNCgkgICAgICAgICAgICAna21sJzogdGhpcy5sb2FkWG1sLA0KCSAgICAgICAgICAgICdncHgnOiB0aGlzLmxvYWRYbWwsDQoJICAgICAgICAgICAgJ3RjeCc6IHRoaXMubG9hZFhtbCwNCgkgICAgICAgICAgICAnY3N2JzogdGhpcy5sb2FkQ3N2LA0KCSAgICAgICAgICAgICd0c3YnOiB0aGlzLmxvYWRDc3YNCgkgICAgICAgIH07DQoJICAgICAgICB0aGlzLl9jb252ZXJzaW9uRm4gPSBjb252ZXJ0ZXJzW2Zvcm1hdF07DQoJICAgIH0NCgkgICAgYXN5bmMgY29udmVydCgpIHsNCgkgICAgICAgIGlmICghdGhpcy5fY29udmVyc2lvbkZuKSB7DQoJICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChfLCByZWopID0+IHJlaihgTm8gY29udmVydGVyIGV4aXN0cyBmb3IgJHt0aGlzLl9mb3JtYXR9YCkpOw0KCSAgICAgICAgfQ0KCSAgICAgICAgZWxzZSB7DQoJICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NvbnZlcnNpb25GbigpOw0KCSAgICAgICAgfQ0KCSAgICB9DQoJICAgIGFzeW5jIGxvYWRYbWwoKSB7DQoJICAgICAgICBjb25zdCBnZW9qc29uID0gdG9HZW9Kc29uW3RoaXMuX2Zvcm1hdF0obmV3IERPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyh0aGlzLl9yYXdEYXRhLCAidGV4dC94bWwiKSk7DQoJICAgICAgICByZXR1cm4gZ2VvanNvbjsNCgkgICAgfQ0KCSAgICBhc3luYyBsb2FkQ3N2KCkgew0KCSAgICAgICAgbGV0IGdlb2pzb24gPSB0aGlzLmJsYW5rR2VvSlNPTigpOw0KCSAgICAgICAgbGV0IG9wdGlvbnMgPSB7fTsNCgkgICAgICAgIGlmICh0aGlzLl9mb3JtYXQgPT09ICd0c3YnKSB7DQoJICAgICAgICAgICAgb3B0aW9ucy5kZWxpbWl0ZXIgPSAnXHQnOw0KCSAgICAgICAgfQ0KCSAgICAgICAgZ2VvanNvbiA9IGF3YWl0IG5ldyBQcm9taXNlKChyZXMsIHJlaikgPT4gew0KCSAgICAgICAgICAgIGNzdjJnZW9qc29uXzEuY3N2Mmdlb2pzb24odGhpcy5fcmF3RGF0YSwgb3B0aW9ucywgKGVyciwgZGF0YSkgPT4gZXJyID8gcmVqKGVycikgOiByZXMoZGF0YSkpOw0KCSAgICAgICAgfSk7DQoJICAgICAgICByZXR1cm4gZ2VvanNvbjsNCgkgICAgfQ0KCSAgICBhc3luYyBsb2FkVG9wb0pzb24oKSB7DQoJICAgICAgICBsZXQgdG9wb0pzb25EYXRhID0ge307DQoJICAgICAgICB0cnkgew0KCSAgICAgICAgICAgIHRvcG9Kc29uRGF0YSA9IEpTT04ucGFyc2UodGhpcy5fcmF3RGF0YSk7DQoJICAgICAgICB9DQoJICAgICAgICBjYXRjaCAoZSkgew0KCSAgICAgICAgICAgIHRocm93ICJJbnZhbGlkIFRvcG9Kc29uIjsNCgkgICAgICAgIH0NCgkgICAgICAgIC8vIENvbnZlcnQgdGhlIGRhdGENCgkgICAgICAgIGxldCByZXN1bHQgPSB0aGlzLmJsYW5rR2VvSlNPTigpOw0KCSAgICAgICAgaWYgKHRvcG9Kc29uRGF0YS50eXBlID09PSAiVG9wb2xvZ3kiICYmIHRvcG9Kc29uRGF0YS5vYmplY3RzICE9PSB1bmRlZmluZWQpIHsNCgkgICAgICAgICAgICByZXN1bHQgPSB7DQoJICAgICAgICAgICAgICAgIHR5cGU6ICJGZWF0dXJlQ29sbGVjdGlvbiIsDQoJICAgICAgICAgICAgICAgIGZlYXR1cmVzOiByZXN1bHQuZmVhdHVyZXMgPSBPYmplY3Qua2V5cyh0b3BvSnNvbkRhdGEub2JqZWN0cykubWFwKGtleSA9PiB0b3BvanNvbkZlYXR1cmUodG9wb0pzb25EYXRhLCBrZXkpKS5yZWR1Y2UoKGEsIHYpID0+IFsuLi5hLCAuLi52LmZlYXR1cmVzXSwgW10pDQoJICAgICAgICAgICAgfTsNCgkgICAgICAgIH0NCgkgICAgICAgIHJldHVybiByZXN1bHQ7DQoJICAgIH0NCgkgICAgOw0KCX0KCgljb25zdCBsaWJyYXJpZXMgPSB7DQoJICAgICdDb252ZXJ0ZXInOiBDb252ZXJ0ZXINCgl9Ow0KCWxldCBzdWJDbGFzczsNCglzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBlID0+IHsNCgkgICAgY29uc3QgZGF0YSA9IChlLmRhdGEgfHwgZSk7DQoJICAgIGNvbnN0IHBvc3QgPSAoaWQsIGVyciwgcmVzLCB0eXBlKSA9PiB7DQoJICAgICAgICBwb3N0TWVzc2FnZSh7DQoJICAgICAgICAgICAgdHlwZTogdHlwZSA/IHR5cGUgOiAoZXJyID8gJ2Vycm9yJyA6ICdyZXNwb25zZScpLA0KCSAgICAgICAgICAgIGlkOiBpZCwNCgkgICAgICAgICAgICBtZXNzYWdlOiByZXMsDQoJICAgICAgICAgICAgZXJyb3I6IGVycg0KCSAgICAgICAgfSk7DQoJICAgIH07DQoJICAgIGNvbnN0IGNvbW1hbmRzID0gew0KCSAgICAgICAgJ2luaXQnOiAobXNnKSA9PiB7DQoJICAgICAgICAgICAgY29uc3QgeyBpZCwgY29tbWFuZCwgbWVzc2FnZSB9ID0gbXNnOw0KCSAgICAgICAgICAgIHN1YkNsYXNzID0gbmV3IGxpYnJhcmllc1tjb21tYW5kXShtZXNzYWdlWzBdLCBtZXNzYWdlWzFdKTsNCgkgICAgICAgICAgICAvLyByZXR1cm4gdGhlIGNsYXNzJyBtZXRob2RzDQoJICAgICAgICAgICAgY29uc3QgZm5zID0gWw0KCSAgICAgICAgICAgICAgICAuLi5PYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhsaWJyYXJpZXNbY29tbWFuZF0ucHJvdG90eXBlKSwNCgkgICAgICAgICAgICAgICAgLi4uT2JqZWN0LmtleXMoc3ViQ2xhc3MpDQoJICAgICAgICAgICAgXS5tYXAoa2V5ID0+IFtrZXksIHR5cGVvZiBsaWJyYXJpZXNbY29tbWFuZF0ucHJvdG90eXBlW2tleV1dKQ0KCSAgICAgICAgICAgICAgICAucmVkdWNlKChhLCBjKSA9PiAoeyAuLi5hLCAuLi57IFtjWzBdXTogY1sxXSB9IH0pLCB7fSk7DQoJICAgICAgICAgICAgcG9zdChpZCwgdW5kZWZpbmVkLCBmbnMsICdpbml0X3Jlc3BvbnNlJyk7DQoJICAgICAgICB9LA0KCSAgICAgICAgJ2dldCc6IGZ1bmN0aW9uIChtc2cpIHsNCgkgICAgICAgICAgICBjb25zdCB7IGlkLCBjb21tYW5kIH0gPSBtc2c7DQoJICAgICAgICAgICAgaWYgKHN1YkNsYXNzICYmIHN1YkNsYXNzW2NvbW1hbmRdKSB7DQoJICAgICAgICAgICAgICAgIHBvc3QoaWQsIHVuZGVmaW5lZCwgc3ViQ2xhc3NbY29tbWFuZF0pOw0KCSAgICAgICAgICAgIH0NCgkgICAgICAgICAgICBlbHNlIHsNCgkgICAgICAgICAgICAgICAgcG9zdChpZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQpOw0KCSAgICAgICAgICAgIH0NCgkgICAgICAgIH0sDQoJICAgICAgICAnZXhlYyc6IGZ1bmN0aW9uIChtc2cpIHsNCgkgICAgICAgICAgICBjb25zdCB7IGlkLCBjb21tYW5kLCBtZXNzYWdlIH0gPSBtc2c7DQoJICAgICAgICAgICAgaWYgKHN1YkNsYXNzICYmIHN1YkNsYXNzW2NvbW1hbmRdICYmIHR5cGVvZiBzdWJDbGFzc1tjb21tYW5kXSA9PT0gJ2Z1bmN0aW9uJykgew0KCSAgICAgICAgICAgICAgICBjb25zdCBjbWQgPSBzdWJDbGFzc1tjb21tYW5kXQ0KCSAgICAgICAgICAgICAgICAgICAgLmFwcGx5KHN1YkNsYXNzLCBtZXNzYWdlKTsNCgkgICAgICAgICAgICAgICAgaWYgKCEhY21kICYmIHR5cGVvZiBjbWQudGhlbiA9PT0gJ2Z1bmN0aW9uJykgew0KCSAgICAgICAgICAgICAgICAgICAgLy8gSXQncyBhIHByb21pc2UsIHNvIHdhaXQgZm9yIGl0DQoJICAgICAgICAgICAgICAgICAgICBjbWQNCgkgICAgICAgICAgICAgICAgICAgICAgICAudGhlbihyZXMgPT4gcG9zdChpZCwgdW5kZWZpbmVkLCByZXMpKQ0KCSAgICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaChlID0+IHBvc3QoaWQsIGUpKTsNCgkgICAgICAgICAgICAgICAgfQ0KCSAgICAgICAgICAgICAgICBlbHNlIHsNCgkgICAgICAgICAgICAgICAgICAgIC8vIE5vdCBhIHByb21pc2UsIGp1c3QgcmV0dXJuIGl0DQoJICAgICAgICAgICAgICAgICAgICBwb3N0KGlkLCB1bmRlZmluZWQsIGNtZCk7DQoJICAgICAgICAgICAgICAgIH0NCgkgICAgICAgICAgICB9DQoJICAgICAgICAgICAgZWxzZSB7DQoJICAgICAgICAgICAgICAgIC8vIEVycm9yDQoJICAgICAgICAgICAgICAgIHBvc3QoaWQsIG5ldyBFcnJvcihgY29tbWFuZCAiJHtjb21tYW5kfSIgbm90IGZvdW5kYCkpOw0KCSAgICAgICAgICAgIH0NCgkgICAgICAgIH0NCgkgICAgfTsNCgkgICAgaWYgKGNvbW1hbmRzW2RhdGEudHlwZV0pIHsNCgkgICAgICAgIGNvbW1hbmRzW2RhdGEudHlwZV0oZGF0YSk7DQoJICAgIH0NCgl9KTsKCn0pKCk7Cgo=",tg=null,sg=!1,eg?og(Gg,tg,sg):function(g,I,C){var A;return function(l){return A=A||dg(g,I,C),new Worker(A,l)}}(Gg,tg,sg));const mg=()=>Math.random().toString(36).substring(2);class Wg{constructor(g,I){this.initId=mg()+"-"+g,this.worker=new ng,this.handlers=new Map,this.worker.onmessage=g=>{const I=g.data,C=this.handlers.get(I.id),A=this;if(C){if("response"===I.type&&C.res(I.message),"error"===I.type){const g=I.error||new Error(`Unknown error with ${this.subClass}`);C.rej(g)}"init_response"===I.type&&(this._=Object.keys(I.message).map((g=>{const C=typeof I.message[g];return[g,function(){return C?A.exec(g)(...arguments):A.get(g)}]})).reduce(((g,I)=>({...g,[I[0]]:I[1]})),{}),C.res(this._))}},this.worker.postMessage({type:"init",id:this.initId,command:g,message:I})}onLoad(){return new Promise((g=>{void 0===this._?this.handlers.set(this.initId,{res:g,rej:g}):g(this._)}))}exec(g){const I=this;return function(){return new Promise(((C,A)=>{const l=mg()+"-"+g;I.handlers.set(l,{res:C,rej:A}),I.worker.postMessage({type:"exec",id:l,command:g,message:[...arguments]})}))}}get(g){return new Promise(((I,C)=>{const A=mg()+"-"+g;this.handlers.set(A,{res:I,rej:C}),this.worker.postMessage({type:"get",id:A,command:g,message:[]})}))}}const Bg=(g,I)=>{const C=g.url.split("://")[0],A=g.url.replace(new RegExp(`^${C}://`),"");return fetch(A).then((g=>{200==g.status?g.text().then((g=>{let A,l;["kml","tcx","gpx"].indexOf(C)>=0?(A=new bg(C,g),l=A.convert()):(A=new Wg("Converter",[C,g]),l=A.exec("convert")()),l.then((g=>{I(null,g,null,null)})).catch((g=>{I(g)}))})):I(new Error(`Data fetch error: ${g.statusText}`))})).catch((g=>{I(new Error(g))})),{cancel:()=>{}}};g.VectorTextProtocol=Bg,g.addProtocols=g=>{lg.forEach((I=>{g.addProtocol(I,Bg)}))},Object.defineProperty(g,"__esModule",{value:!0})}));
//# sourceMappingURL=maplibregl-vector-text-protocol.min.js.map
