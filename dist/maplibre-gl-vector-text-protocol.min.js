!function(g,I){"object"==typeof exports&&"undefined"!=typeof module?I(exports):"function"==typeof define&&define.amd?define(["exports"],I):I((g="undefined"!=typeof globalThis?globalThis:g||self).VectorTextProtocol={})}(this,(function(g){"use strict";"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var I={exports:{}};!function(g,I){!function(g){function I(g){return new Function("d","return {"+g.map((function(g,I){return JSON.stringify(g)+": d["+I+"]"})).join(",")+"}")}function C(g,C){var A=I(g);return function(I,l){return C(A(I),l,g)}}function A(g){var I=Object.create(null),C=[];return g.forEach((function(g){for(var A in g)A in I||C.push(I[A]=A)})),C}function l(g){var l=new RegExp('["'+g+"\n]"),b=g.charCodeAt(0);function c(g,A){var l,b,c=o(g,(function(g,c){if(l)return l(g,c-1);b=g,l=A?C(g,A):I(g)}));return c.columns=b,c}function o(g,I){var C,A,l={},c={},o=[],Z=g.length,d=0,n=0;function G(){if(d>=Z)return c;if(A)return A=!1,l;var I,C=d;if(34===g.charCodeAt(C)){for(var o=C;o++<Z;)if(34===g.charCodeAt(o)){if(34!==g.charCodeAt(o+1))break;++o}return d=o+2,13===(I=g.charCodeAt(o+1))?(A=!0,10===g.charCodeAt(o+2)&&++d):10===I&&(A=!0),g.slice(C+1,o).replace(/""/g,'"')}for(;d<Z;){var n=1;if(10===(I=g.charCodeAt(d++)))A=!0;else if(13===I)A=!0,10===g.charCodeAt(d)&&(++d,++n);else if(I!==b)continue;return g.slice(C,d-n)}return g.slice(C)}for(;(C=G())!==c;){for(var s=[];C!==l&&C!==c;)s.push(C),C=G();I&&null==(s=I(s,n++))||o.push(s)}return o}function Z(I,C){return null==C&&(C=A(I)),[C.map(G).join(g)].concat(I.map((function(I){return C.map((function(g){return G(I[g])})).join(g)}))).join("\n")}function d(g){return g.map(n).join("\n")}function n(I){return I.map(G).join(g)}function G(g){return null==g?"":l.test(g+="")?'"'+g.replace(/\"/g,'""')+'"':g}return{parse:c,parseRows:o,format:Z,formatRows:d}}var b=l(","),c=b.parse,o=b.parseRows,Z=b.format,d=b.formatRows,n=l("\t"),G=n.parse,s=n.parseRows,e=n.format,t=n.formatRows;g.dsvFormat=l,g.csvParse=c,g.csvParseRows=o,g.csvFormat=Z,g.csvFormatRows=d,g.tsvParse=G,g.tsvParseRows=s,g.tsvFormat=e,g.tsvFormatRows=t,Object.defineProperty(g,"__esModule",{value:!0})}(I)}(0,I.exports);var C={exports:{}};function A(g,I){var C=l(g,I);return C.whole+"° "+(C.minutes?C.minutes+"' ":"")+(C.seconds?C.seconds+'" ':"")+C.dir}function l(g,I){var C=({lat:["N","S"],lon:["E","W"]}[I]||"")[g>=0?0:1],A=Math.abs(g),l=Math.floor(A),b=60*(A-l),c=Math.floor(b);return{whole:l,minutes:c,seconds:Math.floor(60*(b-c)),dir:C}}function b(g,I){if(I||(I="NSEW"),"string"!=typeof g)return null;var C=(g=g.toUpperCase()).match(/^[\s\,]*([NSEW])?\s*([\-|\—|\―]?[0-9.]+)[°º˚]?\s*(?:([0-9.]+)['’′‘]\s*)?(?:([0-9.]+)(?:''|"|”|″)\s*)?([NSEW])?/);if(!C)return null;var A,l=C[0];if(C[1]&&C[5]?(A=C[1],l=l.slice(0,-1)):A=C[1]||C[5],A&&-1===I.indexOf(A))return null;var b=C[2]?parseFloat(C[2]):0,c=C[3]?parseFloat(C[3])/60:0,o=C[4]?parseFloat(C[4])/3600:0,Z=b<0?-1:1;return"S"!==A&&"W"!==A||(Z*=-1),{val:(Math.abs(b)+c+o)*Z,dim:A,matched:l,remain:g.slice(l.length)}}C.exports=function(g,I){var C=b(g,I);return null===C?null:C.val},C.exports.pair=function(g,I){var C=b(g=g.trim(),I);if(!C)return null;var A=b(g=C.remain.trim(),I);if(!A||A.remain)return null;return C.dim?function(g,I,C){if("N"===C||"S"===C)return[g,I];if("W"===C||"E"===C)return[I,g]}(C.val,A.val,C.dim):[C.val,A.val]},C.exports.format=A,C.exports.formatPair=function(g){return A(g.lat,"lat")+" "+A(g.lon,"lon")},C.exports.coordToDMS=l;var c=I.exports,o=C.exports,Z=/(Lat)(itude)?/gi,d=/(L)(on|ng)(gitude)?/i;function n(g,I){var C,A,l;for(var b in g)(A=b.match(I))&&(!C||A[0].length/b.length>l)&&(l=A[0].length/b.length,C=b);return C}function G(g){return n(g,Z)}function s(g){return n(g,d)}function e(g){return"object"==typeof g?Object.keys(g).length:0}function t(g){var I=[];return[",",";","\t","|"].forEach((function(C){var A=c.dsvFormat(C).parse(g);if(A.length>=1){for(var l=e(A[0]),b=0;b<A.length;b++)if(e(A[b])!==l)return;I.push({delimiter:C,arity:Object.keys(A[0]).length})}})),I.length?I.sort((function(g,I){return I.arity-g.arity}))[0].delimiter:null}var m={isLon:function(g){return!!g.match(d)},isLat:function(g){return!!g.match(Z)},guessLatHeader:G,guessLonHeader:s,csv:c.csvParse,tsv:c.tsvParse,dsv:c,auto:function(g){var I=t(g);return I?function(g){return delete g.columns,g}(c.dsvFormat(I).parse(g)):null},csv2geojson:function(g,I,C){C||(C=I,I={}),I.delimiter=I.delimiter||",";var A=I.latfield||"",l=I.lonfield||"",b=I.crs||"",Z=[],d={type:"FeatureCollection",features:Z};if(""!==b&&(d.crs={type:"name",properties:{name:b}}),"auto"!==I.delimiter||"string"!=typeof g||(I.delimiter=t(g),I.delimiter)){var n=I.numericFields?I.numericFields.split(","):null,e="string"==typeof g?c.dsvFormat(I.delimiter).parse(g,(function(g){if(n)for(var I in g)n.includes(I)&&(g[I]=+g[I]);return g})):g;if(e.length){var m,B=[];if(A||(A=G(e[0])),l||(l=s(e[0])),!A||!l){for(m=0;m<e.length;m++)Z.push({type:"Feature",properties:e[m],geometry:null});C(B.length?B:null,d)}else{for(m=0;m<e.length;m++)if(void 0!==e[m][l]&&void 0!==e[m][A]){var i,W,J,a=e[m][l],u=e[m][A];(J=o(a,"EW"))&&(a=J),(J=o(u,"NS"))&&(u=J),i=parseFloat(a),W=parseFloat(u),isNaN(i)||isNaN(W)?B.push({message:"A row contained an invalid value for latitude or longitude",row:e[m],index:m}):(I.includeLatLon||(delete e[m][l],delete e[m][A]),Z.push({type:"Feature",properties:e[m],geometry:{type:"Point",coordinates:[parseFloat(i),parseFloat(W)]}}))}C(B.length?B:null,d)}}else C(null,d)}else C({type:"Error",message:"Could not autodetect delimiter"})},toLine:function(g){for(var I=g.features,C={type:"Feature",geometry:{type:"LineString",coordinates:[]}},A=0;A<I.length;A++)C.geometry.coordinates.push(I[A].geometry.coordinates);return C.properties=I.reduce((function(g,I){for(var C in I.properties)g[C]||(g[C]=[]),g[C].push(I.properties[C]);return g}),{}),{type:"FeatureCollection",features:[C]}},toPolygon:function(g){for(var I=g.features,C={type:"Feature",geometry:{type:"Polygon",coordinates:[[]]}},A=0;A<I.length;A++)C.geometry.coordinates[0].push(I[A].geometry.coordinates);return C.properties=I.reduce((function(g,I){for(var C in I.properties)g[C]||(g[C]=[]),g[C].push(I.properties[C]);return g}),{}),{type:"FeatureCollection",features:[C]}}};function B(g){return g}function i(g,I){var C=I.id,A=I.bbox,l=null==I.properties?{}:I.properties,b=function(g,I){var C=function(g){if(null==g)return B;var I,C,A=g.scale[0],l=g.scale[1],b=g.translate[0],c=g.translate[1];return function(g,o){o||(I=C=0);var Z=2,d=g.length,n=new Array(d);for(n[0]=(I+=g[0])*A+b,n[1]=(C+=g[1])*l+c;Z<d;)n[Z]=g[Z],++Z;return n}}(g.transform),A=g.arcs;function l(g,I){I.length&&I.pop();for(var l=A[g<0?~g:g],b=0,c=l.length;b<c;++b)I.push(C(l[b],b));g<0&&function(g,I){for(var C,A=g.length,l=A-I;l<--A;)C=g[l],g[l++]=g[A],g[A]=C}(I,c)}function b(g){return C(g)}function c(g){for(var I=[],C=0,A=g.length;C<A;++C)l(g[C],I);return I.length<2&&I.push(I[0]),I}function o(g){for(var I=c(g);I.length<4;)I.push(I[0]);return I}function Z(g){return g.map(o)}function d(g){var I,C=g.type;switch(C){case"GeometryCollection":return{type:C,geometries:g.geometries.map(d)};case"Point":I=b(g.coordinates);break;case"MultiPoint":I=g.coordinates.map(b);break;case"LineString":I=c(g.arcs);break;case"MultiLineString":I=g.arcs.map(c);break;case"Polygon":I=Z(g.arcs);break;case"MultiPolygon":I=g.arcs.map(Z);break;default:return null}return{type:C,coordinates:I}}return d(I)}(g,I);return null==C&&null==A?{type:"Feature",properties:l,geometry:b}:null==A?{type:"Feature",id:C,properties:l,geometry:b}:{type:"Feature",id:C,bbox:A,properties:l,geometry:b}}function W(g,I){return Array.from(g.getElementsByTagName(I))}function J(g){return"#"===g[0]?g:`#${g}`}function a(g){return g?.normalize(),g&&g.textContent||""}function u(g,I,C){const A=g.getElementsByTagName(I),l=A.length?A[0]:null;return l&&C&&C(l),l}function S(g,I,C){const A={};if(!g)return A;const l=g.getElementsByTagName(I),b=l.length?l[0]:null;return b&&C?C(b,A):A}function k(g,I,C){const A=a(u(g,I));return A&&C&&C(A)||{}}function V(g,I,C){const A=parseFloat(a(u(g,I)));if(!isNaN(A))return A&&C&&C(A)||{}}function y(g,I,C){const A=parseFloat(a(u(g,I)));if(!isNaN(A))return A&&C&&C(A),A}function h(g,I){const C={};for(const A of I)k(g,A,(g=>{C[A]=g}));return C}function K(g){return 1===g?.nodeType}function H(g){return S(g,"line",(g=>Object.assign({},k(g,"color",(g=>({stroke:`#${g}`}))),V(g,"opacity",(g=>({"stroke-opacity":g}))),V(g,"width",(g=>({"stroke-width":96*g/25.4}))))))}function p(g){let I=[];if(null===g)return I;for(const C of Array.from(g.childNodes)){if(!K(C))continue;const g=X(C.nodeName);if("gpxtpx:TrackPointExtension"===g)I=I.concat(p(C));else{const A=a(C);I.push([g,r(A)])}}return I}function X(g){return["heart","gpxtpx:hr","hr"].includes(g)?"heart":g}function r(g){const I=parseFloat(g);return isNaN(I)?g:I}function R(g){const I=[parseFloat(g.getAttribute("lon")||""),parseFloat(g.getAttribute("lat")||"")];if(isNaN(I[0])||isNaN(I[1]))return null;y(g,"ele",(g=>{I.push(g)}));const C=u(g,"time");return{coordinates:I,time:C?a(C):null,extendedValues:p(u(g,"extensions"))}}function Y(g){const I=h(g,["name","cmt","desc","type","time","keywords"]),C=Array.from(g.getElementsByTagNameNS("http://www.garmin.com/xmlschemas/GpxExtensions/v3","*"));for(const A of C)A.parentNode?.parentNode===g&&(I[A.tagName.replace(":","_")]=a(A));const A=W(g,"link");return A.length&&(I.links=A.map((g=>Object.assign({href:g.getAttribute("href")},h(g,["text","type"]))))),I}function w(g,I){const C=W(g,I),A=[],l=[],b={};for(let g=0;g<C.length;g++){const I=R(C[g]);if(I){A.push(I.coordinates),I.time&&l.push(I.time);for(const[A,l]of I.extendedValues){const I="heart"===A?A:A.replace("gpxtpx:","")+"s";b[I]||(b[I]=Array(C.length).fill(null)),b[I][g]=l}}}if(!(A.length<2))return{line:A,times:l,extendedValues:b}}function v(g){const I=w(g,"rtept");if(I)return{type:"Feature",properties:Object.assign({_gpxType:"rte"},Y(g),H(u(g,"extensions"))),geometry:{type:"LineString",coordinates:I.line}}}function N(g){const I=W(g,"trkseg"),C=[],A=[],l=[];for(const g of I){const I=w(g,"trkpt");I&&(l.push(I),I.times&&I.times.length&&A.push(I.times))}if(0===l.length)return null;const b=l.length>1,c=Object.assign({_gpxType:"trk"},Y(g),H(u(g,"extensions")),A.length?{coordinateProperties:{times:b?A:A[0]}}:{});for(const g of l){C.push(g.line),c.coordinateProperties||(c.coordinateProperties={});const I=c.coordinateProperties,A=Object.entries(g.extendedValues);for(let g=0;g<A.length;g++){const[C,c]=A[g];b?(I[C]||(I[C]=l.map((g=>new Array(g.line.length).fill(null)))),I[C][g]=c):I[C]=c}}return{type:"Feature",properties:c,geometry:b?{type:"MultiLineString",coordinates:C}:{type:"LineString",coordinates:C[0]}}}function F(g){const I=Object.assign(Y(g),h(g,["sym"])),C=R(g);return C?{type:"Feature",properties:I,geometry:{type:"Point",coordinates:C.coordinates}}:null}function*z(g){for(const I of W(g,"trk")){const g=N(I);g&&(yield g)}for(const I of W(g,"rte")){const g=v(I);g&&(yield g)}for(const I of W(g,"wpt")){const g=F(I);g&&(yield g)}}const Q=[["heartRate","heartRates"],["Cadence","cadences"],["Speed","speeds"],["Watts","watts"]],f=[["TotalTimeSeconds","totalTimeSeconds"],["DistanceMeters","distanceMeters"],["MaximumSpeed","maxSpeed"],["AverageHeartRateBpm","avgHeartRate"],["MaximumHeartRateBpm","maxHeartRate"],["AvgSpeed","avgSpeed"],["AvgWatts","avgWatts"],["MaxWatts","maxWatts"]];function x(g,I){const C=[];for(const[A,l]of I){let I=u(g,A);if(!I){const C=g.getElementsByTagNameNS("http://www.garmin.com/xmlschemas/ActivityExtension/v2",A);C.length&&(I=C[0])}const b=parseFloat(a(I));isNaN(b)||C.push([l,b])}return C}function L(g){const I=[y(g,"LongitudeDegrees"),y(g,"LatitudeDegrees")];if(void 0===I[0]||isNaN(I[0])||void 0===I[1]||isNaN(I[1]))return null;const C=u(g,"HeartRateBpm"),A=a(u(g,"Time"));return u(g,"AltitudeMeters",(g=>{const C=parseFloat(a(g));isNaN(C)||I.push(C)})),{coordinates:I,time:A||null,heartRate:C?parseFloat(a(C)):null,extensions:x(g,Q)}}function T(g){const I=W(g,"Trackpoint"),C=[],A=[],l=[];if(I.length<2)return null;const b={},c={extendedProperties:b};for(let g=0;g<I.length;g++){const c=L(I[g]);if(null===c)continue;C.push(c.coordinates);const{time:o,heartRate:Z,extensions:d}=c;o&&A.push(o),Z&&l.push(Z);for(const[C,A]of d)b[C]||(b[C]=Array(I.length).fill(null)),b[C][g]=A}return C.length<2?null:Object.assign(c,{line:C,times:A,heartRates:l})}function U(g){const I=W(g,"Track"),C=[],A=[],l=[],b=[];let c;const o=Object.assign(Object.fromEntries(x(g,f)),S(g,"Name",(g=>({name:a(g)}))));for(const g of I)c=T(g),c&&(C.push(c.line),c.times.length&&A.push(c.times),c.heartRates.length&&l.push(c.heartRates),b.push(c.extendedProperties));for(let g=0;g<b.length;g++){const A=b[g];for(const l in A)1===I.length?c&&(o[l]=c.extendedProperties[l]):(o[l]||(o[l]=C.map((g=>Array(g.length).fill(null)))),o[l][g]=A[l])}return 0===C.length?null:((A.length||l.length)&&(o.coordinateProperties=Object.assign(A.length?{times:1===C.length?A[0]:A}:{},l.length?{heart:1===C.length?l[0]:l}:{})),{type:"Feature",properties:o,geometry:1===C.length?{type:"LineString",coordinates:C[0]}:{type:"MultiLineString",coordinates:C}})}function*O(g){for(const I of W(g,"Lap")){const g=U(I);g&&(yield g)}for(const I of W(g,"Courses")){const g=U(I);g&&(yield g)}}function j(g,I){const C={},A="stroke"==I||"fill"===I?I:I+"-color";return"#"===g[0]&&(g=g.substring(1)),6===g.length||3===g.length?C[A]="#"+g:8===g.length&&(C[I+"-opacity"]=parseInt(g.substring(0,2),16)/255,C[A]="#"+g.substring(6,8)+g.substring(4,6)+g.substring(2,4)),C}function M(g,I,C){const A={};return y(g,I,(g=>{A[C]=g})),A}function D(g,I){return S(g,"color",(g=>j(a(g),I)))}function P(g){return Object.assign({},function(g){return S(g,"PolyStyle",((g,I)=>Object.assign(I,S(g,"color",(g=>j(a(g),"fill"))),k(g,"fill",(g=>{if("0"===g)return{"fill-opacity":0}})),k(g,"outline",(g=>{if("0"===g)return{"stroke-opacity":0}})))))}(g),function(g){return S(g,"LineStyle",(g=>Object.assign(D(g,"stroke"),M(g,"width","stroke-width"))))}(g),function(g){return S(g,"LabelStyle",(g=>Object.assign(D(g,"label"),M(g,"scale","label-scale"))))}(g),function(g){return S(g,"IconStyle",(g=>Object.assign(D(g,"icon"),M(g,"scale","icon-scale"),M(g,"heading","icon-heading"),S(g,"hotSpot",(g=>{const I=parseFloat(g.getAttribute("x")||""),C=parseFloat(g.getAttribute("y")||""),A=g.getAttribute("xunits")||"",l=g.getAttribute("yunits")||"";return isNaN(I)||isNaN(C)?{}:{"icon-offset":[I,C],"icon-offset-units":[A,l]}})),S(g,"Icon",((g,I)=>(k(g,"href",(g=>{I.icon=g})),I))))))}(g))}const E=/\s*/g,q=/^\s*|\s*$/g,_=/\s+/;function $(g){return g.replace(E,"").split(",").map(parseFloat).filter((g=>!isNaN(g))).slice(0,3)}function gg(g){return g.replace(q,"").split(_).map($).filter((g=>g.length>=2))}function Ig(g){let I=W(g,"coord");0===I.length&&(I=function(g,I,C){return Array.from(g.getElementsByTagNameNS(C,I))}(g,"coord","*"));const C=I.map((g=>a(g).split(" ").map(parseFloat)));return 0===C.length?null:{geometry:C.length>2?{type:"LineString",coordinates:C}:{type:"Point",coordinates:C[0]},times:W(g,"when").map((g=>a(g)))}}function Cg(g){if(0===g.length)return g;const I=g[0],C=g[g.length-1];let A=!0;for(let g=0;g<Math.max(I.length,C.length);g++)if(I[g]!==C[g]){A=!1;break}return A?g:g.concat([g[0]])}const Ag=["Polygon","LineString","Point","Track","gx:Track"];function lg(g){return a(u(g,"coordinates"))}function bg(g){const I=[],C=[];for(const I of["MultiGeometry","MultiTrack","gx:MultiTrack"]){const C=u(g,I);if(C)return bg(C)}for(const A of Ag)for(const l of W(g,A))switch(A){case"Point":{const g=$(lg(l));g.length>=2&&I.push({type:"Point",coordinates:g});break}case"LineString":{const g=gg(lg(l));g.length>=2&&I.push({type:"LineString",coordinates:g});break}case"Polygon":{const g=[];for(const I of W(l,"LinearRing")){const C=Cg(gg(lg(I)));C.length>=4&&g.push(C)}g.length&&I.push({type:"Polygon",coordinates:g});break}case"Track":case"gx:Track":{const g=Ig(l);if(!g)break;const{times:A,geometry:b}=g;I.push(b),A.length&&C.push(A);break}}return{geometries:I,coordTimes:C}}function cg(g){return S(g,"ExtendedData",((g,I)=>{for(const C of W(g,"Data"))I[C.getAttribute("name")||""]=a(u(C,"value"));for(const C of W(g,"SimpleData"))I[C.getAttribute("name")||""]=a(C);return I}))}function og(g){return 0===g.length?null:1===g.length?g[0]:{type:"GeometryCollection",geometries:g}}function Zg(g){return S(g,"TimeSpan",(g=>({timespan:{begin:a(u(g,"begin")),end:a(u(g,"end"))}})))}function dg(g){return S(g,"TimeStamp",(g=>({timestamp:a(u(g,"when"))})))}function ng(g,I){return k(g,"styleUrl",(g=>(g=J(g),I[g]?Object.assign({styleUrl:g},I[g]):{styleUrl:g})))}function Gg(g){const I=u(g,"description");for(const g of Array.from(I?.childNodes||[]))if(4===g.nodeType)return{description:{"@type":"html",value:a(g)}};return{}}function sg(g,I){const{coordTimes:C,geometries:A}=bg(g),l={type:"Feature",geometry:og(A),properties:Object.assign(h(g,["name","address","visibility","open","phoneNumber","description"]),Gg(g),ng(g,I),P(g),cg(g),Zg(g),dg(g),C.length?{coordinateProperties:{times:1===C.length?C[0]:C}}:{})},b=g.getAttribute("id");return null!==b&&""!==b&&(l.id=b),l}function eg(g){let I=g.getAttribute("id");const C=g.parentNode;return!I&&K(C)&&"CascadingStyle"===C.localName&&(I=C.getAttribute("kml:id")||C.getAttribute("id")),J(I||"")}function tg(g){const I={};for(const C of W(g,"Style"))I[eg(C)]=P(C);for(const C of W(g,"StyleMap")){const g=J(C.getAttribute("id")||"");k(C,"styleUrl",(C=>{C=J(C),I[C]&&(I[g]=I[C])}))}return I}const mg=["name","visibility","open","address","description","phoneNumber","visibility"];function*Bg(g){const I=tg(g);for(const C of W(g,"Placemark")){const g=sg(C,I);g&&(yield g)}}var ig=Object.freeze({__proto__:null,gpx:function(g){return{type:"FeatureCollection",features:Array.from(z(g))}},gpxGen:z,kml:function(g){return{type:"FeatureCollection",features:Array.from(Bg(g))}},kmlGen:Bg,kmlWithFolders:function(g){const I=tg(g),C={type:"root",children:[]};return function g(C,A){if(K(C))switch(C.tagName){case"Placemark":{const g=sg(C,I);g&&A.children.push(g);break}case"Folder":{const g=function(g){const I={};for(const C of Array.from(g.childNodes))K(C)&&mg.includes(C.tagName)&&(I[C.tagName]=a(C));return{type:"folder",meta:I,children:[]}}(C);A.children.push(g),A=g;break}}if(C.childNodes)for(let I=0;I<C.childNodes.length;I++)g(C.childNodes[I],A)}(g,C),C},tcx:function(g){return{type:"FeatureCollection",features:Array.from(O(g))}},tcxGen:O});const Wg=["topojson","kml","gpx","tcx","csv","tsv"];class Jg{constructor(g,I){this.blankGeoJSON=()=>({type:"FeatureCollection",features:[]}),this._rawData=I,this._format=g;const C={topojson:this.loadTopoJson,kml:this.loadXml,gpx:this.loadXml,tcx:this.loadXml,csv:this.loadCsv,tsv:this.loadCsv};this._conversionFn=C[g]}async convert(){return this._conversionFn?this._conversionFn():new Promise(((g,I)=>I(`No converter exists for ${this._format}`)))}async loadXml(){return ig[this._format]((new DOMParser).parseFromString(this._rawData,"text/xml"))}async loadCsv(){let g=this.blankGeoJSON(),I={};return"tsv"===this._format&&(I.delimiter="\t"),g=await new Promise(((g,C)=>{m.csv2geojson(this._rawData,I,((I,A)=>I?C(I):g(A)))})),g}async loadTopoJson(){let g={};try{g=JSON.parse(this._rawData)}catch(g){throw"Invalid TopoJson"}let I=this.blankGeoJSON();return"Topology"===g.type&&void 0!==g.objects&&(I={type:"FeatureCollection",features:I.features=Object.keys(g.objects).map((I=>{return C=g,"string"==typeof(A=I)&&(A=C.objects[A]),"GeometryCollection"===A.type?{type:"FeatureCollection",features:A.geometries.map((function(g){return i(C,g)}))}:i(C,A);var C,A})).reduce(((g,I)=>[...g,...I.features]),[])}),I}}var ag=null;try{var ug="undefined"!=typeof module&&"function"==typeof module.require&&module.require("worker_threads")||"function"==typeof __non_webpack_require__&&__non_webpack_require__("worker_threads")||"function"==typeof require&&require("worker_threads");ag=ug.Worker}catch(g){}function Sg(g,I,C){var A=void 0===I?null:I,l=function(g,I){return Buffer.from(g,"base64").toString(I?"utf16":"utf8")}(g,void 0!==C&&C),b=l.indexOf("\n",10)+1,c=l.substring(b)+(A?"//# sourceMappingURL="+A:"");return function(g){return new ag(c,Object.assign({},g,{eval:!0}))}}function kg(g,I,C){var A=void 0===I?null:I,l=function(g,I){var C=atob(g);if(I){for(var A=new Uint8Array(C.length),l=0,b=C.length;l<b;++l)A[l]=C.charCodeAt(l);return String.fromCharCode.apply(null,new Uint16Array(A.buffer))}return C}(g,void 0!==C&&C),b=l.indexOf("\n",10)+1,c=l.substring(b)+(A?"//# sourceMappingURL="+A:""),o=new Blob([c],{type:"application/javascript"});return URL.createObjectURL(o)}var Vg="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);var yg,hg,Kg,Hg=(yg="Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewoJJ3VzZSBzdHJpY3QnOwoKCXZhciBjb21tb25qc0dsb2JhbCA9IHR5cGVvZiBnbG9iYWxUaGlzICE9PSAndW5kZWZpbmVkJyA/IGdsb2JhbFRoaXMgOiB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyA/IHdpbmRvdyA6IHR5cGVvZiBnbG9iYWwgIT09ICd1bmRlZmluZWQnID8gZ2xvYmFsIDogdHlwZW9mIHNlbGYgIT09ICd1bmRlZmluZWQnID8gc2VsZiA6IHt9OwoKCXZhciBkM0RzdiA9IHtleHBvcnRzOiB7fX07CgoJKGZ1bmN0aW9uIChtb2R1bGUsIGV4cG9ydHMpIHsKCQkvLyBodHRwczovL2QzanMub3JnL2QzLWRzdi8gVmVyc2lvbiAxLjAuMS4gQ29weXJpZ2h0IDIwMTYgTWlrZSBCb3N0b2NrLgoJCShmdW5jdGlvbiAoZ2xvYmFsLCBmYWN0b3J5KSB7CgkJICBmYWN0b3J5KGV4cG9ydHMpIDsKCQl9KGNvbW1vbmpzR2xvYmFsLCBmdW5jdGlvbiAoZXhwb3J0cykgewoJCSAgZnVuY3Rpb24gb2JqZWN0Q29udmVydGVyKGNvbHVtbnMpIHsKCQkgICAgcmV0dXJuIG5ldyBGdW5jdGlvbigiZCIsICJyZXR1cm4geyIgKyBjb2x1bW5zLm1hcChmdW5jdGlvbihuYW1lLCBpKSB7CgkJICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KG5hbWUpICsgIjogZFsiICsgaSArICJdIjsKCQkgICAgfSkuam9pbigiLCIpICsgIn0iKTsKCQkgIH0KCgkJICBmdW5jdGlvbiBjdXN0b21Db252ZXJ0ZXIoY29sdW1ucywgZikgewoJCSAgICB2YXIgb2JqZWN0ID0gb2JqZWN0Q29udmVydGVyKGNvbHVtbnMpOwoJCSAgICByZXR1cm4gZnVuY3Rpb24ocm93LCBpKSB7CgkJICAgICAgcmV0dXJuIGYob2JqZWN0KHJvdyksIGksIGNvbHVtbnMpOwoJCSAgICB9OwoJCSAgfQoKCQkgIC8vIENvbXB1dGUgdW5pcXVlIGNvbHVtbnMgaW4gb3JkZXIgb2YgZGlzY292ZXJ5LgoJCSAgZnVuY3Rpb24gaW5mZXJDb2x1bW5zKHJvd3MpIHsKCQkgICAgdmFyIGNvbHVtblNldCA9IE9iamVjdC5jcmVhdGUobnVsbCksCgkJICAgICAgICBjb2x1bW5zID0gW107CgoJCSAgICByb3dzLmZvckVhY2goZnVuY3Rpb24ocm93KSB7CgkJICAgICAgZm9yICh2YXIgY29sdW1uIGluIHJvdykgewoJCSAgICAgICAgaWYgKCEoY29sdW1uIGluIGNvbHVtblNldCkpIHsKCQkgICAgICAgICAgY29sdW1ucy5wdXNoKGNvbHVtblNldFtjb2x1bW5dID0gY29sdW1uKTsKCQkgICAgICAgIH0KCQkgICAgICB9CgkJICAgIH0pOwoKCQkgICAgcmV0dXJuIGNvbHVtbnM7CgkJICB9CgoJCSAgZnVuY3Rpb24gZHN2KGRlbGltaXRlcikgewoJCSAgICB2YXIgcmVGb3JtYXQgPSBuZXcgUmVnRXhwKCJbXCIiICsgZGVsaW1pdGVyICsgIlxuXSIpLAoJCSAgICAgICAgZGVsaW1pdGVyQ29kZSA9IGRlbGltaXRlci5jaGFyQ29kZUF0KDApOwoKCQkgICAgZnVuY3Rpb24gcGFyc2UodGV4dCwgZikgewoJCSAgICAgIHZhciBjb252ZXJ0LCBjb2x1bW5zLCByb3dzID0gcGFyc2VSb3dzKHRleHQsIGZ1bmN0aW9uKHJvdywgaSkgewoJCSAgICAgICAgaWYgKGNvbnZlcnQpIHJldHVybiBjb252ZXJ0KHJvdywgaSAtIDEpOwoJCSAgICAgICAgY29sdW1ucyA9IHJvdywgY29udmVydCA9IGYgPyBjdXN0b21Db252ZXJ0ZXIocm93LCBmKSA6IG9iamVjdENvbnZlcnRlcihyb3cpOwoJCSAgICAgIH0pOwoJCSAgICAgIHJvd3MuY29sdW1ucyA9IGNvbHVtbnM7CgkJICAgICAgcmV0dXJuIHJvd3M7CgkJICAgIH0KCgkJICAgIGZ1bmN0aW9uIHBhcnNlUm93cyh0ZXh0LCBmKSB7CgkJICAgICAgdmFyIEVPTCA9IHt9LCAvLyBzZW50aW5lbCB2YWx1ZSBmb3IgZW5kLW9mLWxpbmUKCQkgICAgICAgICAgRU9GID0ge30sIC8vIHNlbnRpbmVsIHZhbHVlIGZvciBlbmQtb2YtZmlsZQoJCSAgICAgICAgICByb3dzID0gW10sIC8vIG91dHB1dCByb3dzCgkJICAgICAgICAgIE4gPSB0ZXh0Lmxlbmd0aCwKCQkgICAgICAgICAgSSA9IDAsIC8vIGN1cnJlbnQgY2hhcmFjdGVyIGluZGV4CgkJICAgICAgICAgIG4gPSAwLCAvLyB0aGUgY3VycmVudCBsaW5lIG51bWJlcgoJCSAgICAgICAgICB0LCAvLyB0aGUgY3VycmVudCB0b2tlbgoJCSAgICAgICAgICBlb2w7IC8vIGlzIHRoZSBjdXJyZW50IHRva2VuIGZvbGxvd2VkIGJ5IEVPTD8KCgkJICAgICAgZnVuY3Rpb24gdG9rZW4oKSB7CgkJICAgICAgICBpZiAoSSA+PSBOKSByZXR1cm4gRU9GOyAvLyBzcGVjaWFsIGNhc2U6IGVuZCBvZiBmaWxlCgkJICAgICAgICBpZiAoZW9sKSByZXR1cm4gZW9sID0gZmFsc2UsIEVPTDsgLy8gc3BlY2lhbCBjYXNlOiBlbmQgb2YgbGluZQoKCQkgICAgICAgIC8vIHNwZWNpYWwgY2FzZTogcXVvdGVzCgkJICAgICAgICB2YXIgaiA9IEksIGM7CgkJICAgICAgICBpZiAodGV4dC5jaGFyQ29kZUF0KGopID09PSAzNCkgewoJCSAgICAgICAgICB2YXIgaSA9IGo7CgkJICAgICAgICAgIHdoaWxlIChpKysgPCBOKSB7CgkJICAgICAgICAgICAgaWYgKHRleHQuY2hhckNvZGVBdChpKSA9PT0gMzQpIHsKCQkgICAgICAgICAgICAgIGlmICh0ZXh0LmNoYXJDb2RlQXQoaSArIDEpICE9PSAzNCkgYnJlYWs7CgkJICAgICAgICAgICAgICArK2k7CgkJICAgICAgICAgICAgfQoJCSAgICAgICAgICB9CgkJICAgICAgICAgIEkgPSBpICsgMjsKCQkgICAgICAgICAgYyA9IHRleHQuY2hhckNvZGVBdChpICsgMSk7CgkJICAgICAgICAgIGlmIChjID09PSAxMykgewoJCSAgICAgICAgICAgIGVvbCA9IHRydWU7CgkJICAgICAgICAgICAgaWYgKHRleHQuY2hhckNvZGVBdChpICsgMikgPT09IDEwKSArK0k7CgkJICAgICAgICAgIH0gZWxzZSBpZiAoYyA9PT0gMTApIHsKCQkgICAgICAgICAgICBlb2wgPSB0cnVlOwoJCSAgICAgICAgICB9CgkJICAgICAgICAgIHJldHVybiB0ZXh0LnNsaWNlKGogKyAxLCBpKS5yZXBsYWNlKC8iIi9nLCAiXCIiKTsKCQkgICAgICAgIH0KCgkJICAgICAgICAvLyBjb21tb24gY2FzZTogZmluZCBuZXh0IGRlbGltaXRlciBvciBuZXdsaW5lCgkJICAgICAgICB3aGlsZSAoSSA8IE4pIHsKCQkgICAgICAgICAgdmFyIGsgPSAxOwoJCSAgICAgICAgICBjID0gdGV4dC5jaGFyQ29kZUF0KEkrKyk7CgkJICAgICAgICAgIGlmIChjID09PSAxMCkgZW9sID0gdHJ1ZTsgLy8gXG4KCQkgICAgICAgICAgZWxzZSBpZiAoYyA9PT0gMTMpIHsgZW9sID0gdHJ1ZTsgaWYgKHRleHQuY2hhckNvZGVBdChJKSA9PT0gMTApICsrSSwgKytrOyB9IC8vIFxyfFxyXG4KCQkgICAgICAgICAgZWxzZSBpZiAoYyAhPT0gZGVsaW1pdGVyQ29kZSkgY29udGludWU7CgkJICAgICAgICAgIHJldHVybiB0ZXh0LnNsaWNlKGosIEkgLSBrKTsKCQkgICAgICAgIH0KCgkJICAgICAgICAvLyBzcGVjaWFsIGNhc2U6IGxhc3QgdG9rZW4gYmVmb3JlIEVPRgoJCSAgICAgICAgcmV0dXJuIHRleHQuc2xpY2Uoaik7CgkJICAgICAgfQoKCQkgICAgICB3aGlsZSAoKHQgPSB0b2tlbigpKSAhPT0gRU9GKSB7CgkJICAgICAgICB2YXIgYSA9IFtdOwoJCSAgICAgICAgd2hpbGUgKHQgIT09IEVPTCAmJiB0ICE9PSBFT0YpIHsKCQkgICAgICAgICAgYS5wdXNoKHQpOwoJCSAgICAgICAgICB0ID0gdG9rZW4oKTsKCQkgICAgICAgIH0KCQkgICAgICAgIGlmIChmICYmIChhID0gZihhLCBuKyspKSA9PSBudWxsKSBjb250aW51ZTsKCQkgICAgICAgIHJvd3MucHVzaChhKTsKCQkgICAgICB9CgoJCSAgICAgIHJldHVybiByb3dzOwoJCSAgICB9CgoJCSAgICBmdW5jdGlvbiBmb3JtYXQocm93cywgY29sdW1ucykgewoJCSAgICAgIGlmIChjb2x1bW5zID09IG51bGwpIGNvbHVtbnMgPSBpbmZlckNvbHVtbnMocm93cyk7CgkJICAgICAgcmV0dXJuIFtjb2x1bW5zLm1hcChmb3JtYXRWYWx1ZSkuam9pbihkZWxpbWl0ZXIpXS5jb25jYXQocm93cy5tYXAoZnVuY3Rpb24ocm93KSB7CgkJICAgICAgICByZXR1cm4gY29sdW1ucy5tYXAoZnVuY3Rpb24oY29sdW1uKSB7CgkJICAgICAgICAgIHJldHVybiBmb3JtYXRWYWx1ZShyb3dbY29sdW1uXSk7CgkJICAgICAgICB9KS5qb2luKGRlbGltaXRlcik7CgkJICAgICAgfSkpLmpvaW4oIlxuIik7CgkJICAgIH0KCgkJICAgIGZ1bmN0aW9uIGZvcm1hdFJvd3Mocm93cykgewoJCSAgICAgIHJldHVybiByb3dzLm1hcChmb3JtYXRSb3cpLmpvaW4oIlxuIik7CgkJICAgIH0KCgkJICAgIGZ1bmN0aW9uIGZvcm1hdFJvdyhyb3cpIHsKCQkgICAgICByZXR1cm4gcm93Lm1hcChmb3JtYXRWYWx1ZSkuam9pbihkZWxpbWl0ZXIpOwoJCSAgICB9CgoJCSAgICBmdW5jdGlvbiBmb3JtYXRWYWx1ZSh0ZXh0KSB7CgkJICAgICAgcmV0dXJuIHRleHQgPT0gbnVsbCA/ICIiCgkJICAgICAgICAgIDogcmVGb3JtYXQudGVzdCh0ZXh0ICs9ICIiKSA/ICJcIiIgKyB0ZXh0LnJlcGxhY2UoL1wiL2csICJcIlwiIikgKyAiXCIiCgkJICAgICAgICAgIDogdGV4dDsKCQkgICAgfQoKCQkgICAgcmV0dXJuIHsKCQkgICAgICBwYXJzZTogcGFyc2UsCgkJICAgICAgcGFyc2VSb3dzOiBwYXJzZVJvd3MsCgkJICAgICAgZm9ybWF0OiBmb3JtYXQsCgkJICAgICAgZm9ybWF0Um93czogZm9ybWF0Um93cwoJCSAgICB9OwoJCSAgfQoKCQkgIHZhciBjc3YgPSBkc3YoIiwiKTsKCgkJICB2YXIgY3N2UGFyc2UgPSBjc3YucGFyc2U7CgkJICB2YXIgY3N2UGFyc2VSb3dzID0gY3N2LnBhcnNlUm93czsKCQkgIHZhciBjc3ZGb3JtYXQgPSBjc3YuZm9ybWF0OwoJCSAgdmFyIGNzdkZvcm1hdFJvd3MgPSBjc3YuZm9ybWF0Um93czsKCgkJICB2YXIgdHN2ID0gZHN2KCJcdCIpOwoKCQkgIHZhciB0c3ZQYXJzZSA9IHRzdi5wYXJzZTsKCQkgIHZhciB0c3ZQYXJzZVJvd3MgPSB0c3YucGFyc2VSb3dzOwoJCSAgdmFyIHRzdkZvcm1hdCA9IHRzdi5mb3JtYXQ7CgkJICB2YXIgdHN2Rm9ybWF0Um93cyA9IHRzdi5mb3JtYXRSb3dzOwoKCQkgIGV4cG9ydHMuZHN2Rm9ybWF0ID0gZHN2OwoJCSAgZXhwb3J0cy5jc3ZQYXJzZSA9IGNzdlBhcnNlOwoJCSAgZXhwb3J0cy5jc3ZQYXJzZVJvd3MgPSBjc3ZQYXJzZVJvd3M7CgkJICBleHBvcnRzLmNzdkZvcm1hdCA9IGNzdkZvcm1hdDsKCQkgIGV4cG9ydHMuY3N2Rm9ybWF0Um93cyA9IGNzdkZvcm1hdFJvd3M7CgkJICBleHBvcnRzLnRzdlBhcnNlID0gdHN2UGFyc2U7CgkJICBleHBvcnRzLnRzdlBhcnNlUm93cyA9IHRzdlBhcnNlUm93czsKCQkgIGV4cG9ydHMudHN2Rm9ybWF0ID0gdHN2Rm9ybWF0OwoJCSAgZXhwb3J0cy50c3ZGb3JtYXRSb3dzID0gdHN2Rm9ybWF0Um93czsKCgkJICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7IHZhbHVlOiB0cnVlIH0pOwoKCQl9KSk7Cgl9IChkM0RzdiwgZDNEc3YuZXhwb3J0cykpOwoKCXZhciBzZXhhZ2VzaW1hbCQxID0ge2V4cG9ydHM6IHt9fTsKCglzZXhhZ2VzaW1hbCQxLmV4cG9ydHMgPSBlbGVtZW50OwoJc2V4YWdlc2ltYWwkMS5leHBvcnRzLnBhaXIgPSBwYWlyOwoJc2V4YWdlc2ltYWwkMS5leHBvcnRzLmZvcm1hdCA9IGZvcm1hdDsKCXNleGFnZXNpbWFsJDEuZXhwb3J0cy5mb3JtYXRQYWlyID0gZm9ybWF0UGFpcjsKCXNleGFnZXNpbWFsJDEuZXhwb3J0cy5jb29yZFRvRE1TID0gY29vcmRUb0RNUzsKCgoJZnVuY3Rpb24gZWxlbWVudChpbnB1dCwgZGltcykgewoJICB2YXIgcmVzdWx0ID0gc2VhcmNoKGlucHV0LCBkaW1zKTsKCSAgcmV0dXJuIChyZXN1bHQgPT09IG51bGwpID8gbnVsbCA6IHJlc3VsdC52YWw7Cgl9CgoKCWZ1bmN0aW9uIGZvcm1hdFBhaXIoaW5wdXQpIHsKCSAgcmV0dXJuIGZvcm1hdChpbnB1dC5sYXQsICdsYXQnKSArICcgJyArIGZvcm1hdChpbnB1dC5sb24sICdsb24nKTsKCX0KCgoJLy8gSXMgMCBOb3J0aCBvciBTb3V0aD8KCWZ1bmN0aW9uIGZvcm1hdChpbnB1dCwgZGltKSB7CgkgIHZhciBkbXMgPSBjb29yZFRvRE1TKGlucHV0LCBkaW0pOwoJICByZXR1cm4gZG1zLndob2xlICsgJ8KwICcgKwoJICAgIChkbXMubWludXRlcyA/IGRtcy5taW51dGVzICsgJ1wnICcgOiAnJykgKwoJICAgIChkbXMuc2Vjb25kcyA/IGRtcy5zZWNvbmRzICsgJyIgJyA6ICcnKSArIGRtcy5kaXI7Cgl9CgoKCWZ1bmN0aW9uIGNvb3JkVG9ETVMoaW5wdXQsIGRpbSkgewoJICB2YXIgZGlycyA9IHsgbGF0OiBbJ04nLCAnUyddLCBsb246IFsnRScsICdXJ10gfVtkaW1dIHx8ICcnOwoJICB2YXIgZGlyID0gZGlyc1tpbnB1dCA+PSAwID8gMCA6IDFdOwoJICB2YXIgYWJzID0gTWF0aC5hYnMoaW5wdXQpOwoJICB2YXIgd2hvbGUgPSBNYXRoLmZsb29yKGFicyk7CgkgIHZhciBmcmFjdGlvbiA9IGFicyAtIHdob2xlOwoJICB2YXIgZnJhY3Rpb25NaW51dGVzID0gZnJhY3Rpb24gKiA2MDsKCSAgdmFyIG1pbnV0ZXMgPSBNYXRoLmZsb29yKGZyYWN0aW9uTWludXRlcyk7CgkgIHZhciBzZWNvbmRzID0gTWF0aC5mbG9vcigoZnJhY3Rpb25NaW51dGVzIC0gbWludXRlcykgKiA2MCk7CgoJICByZXR1cm4gewoJICAgIHdob2xlOiB3aG9sZSwKCSAgICBtaW51dGVzOiBtaW51dGVzLAoJICAgIHNlY29uZHM6IHNlY29uZHMsCgkgICAgZGlyOiBkaXIKCSAgfTsKCX0KCgoJZnVuY3Rpb24gc2VhcmNoKGlucHV0LCBkaW1zKSB7CgkgIGlmICghZGltcykgZGltcyA9ICdOU0VXJzsKCSAgaWYgKHR5cGVvZiBpbnB1dCAhPT0gJ3N0cmluZycpIHJldHVybiBudWxsOwoKCSAgaW5wdXQgPSBpbnB1dC50b1VwcGVyQ2FzZSgpOwoJICB2YXIgcmVnZXggPSAvXltcc1wsXSooW05TRVddKT9ccyooW1wtfFzigJR8XOKAlV0/WzAtOS5dKylbwrDCusuaXT9ccyooPzooWzAtOS5dKylbJ+KAmeKAsuKAmF1ccyopPyg/OihbMC05Ll0rKSg/OicnfCJ84oCdfOKAsylccyopPyhbTlNFV10pPy87CgoJICB2YXIgbSA9IGlucHV0Lm1hdGNoKHJlZ2V4KTsKCSAgaWYgKCFtKSByZXR1cm4gbnVsbDsgIC8vIG5vIG1hdGNoCgoJICB2YXIgbWF0Y2hlZCA9IG1bMF07CgoJICAvLyBleHRyYWN0IGRpbWVuc2lvbi4uIG1bMV0gPSBsZWFkaW5nLCBtWzVdID0gdHJhaWxpbmcKCSAgdmFyIGRpbTsKCSAgaWYgKG1bMV0gJiYgbVs1XSkgeyAgICAgICAgICAgICAgICAgLy8gaWYgbWF0Y2hlZCBib3RoLi4KCSAgICBkaW0gPSBtWzFdOyAgICAgICAgICAgICAgICAgICAgICAgLy8ga2VlcCBsZWFkaW5nCgkgICAgbWF0Y2hlZCA9IG1hdGNoZWQuc2xpY2UoMCwgLTEpOyAgIC8vIHJlbW92ZSB0cmFpbGluZyBkaW1lbnNpb24gZnJvbSBtYXRjaAoJICB9IGVsc2UgewoJICAgIGRpbSA9IG1bMV0gfHwgbVs1XTsKCSAgfQoKCSAgLy8gaWYgdW5yZWNvZ25pemVkIGRpbWVuc2lvbgoJICBpZiAoZGltICYmIGRpbXMuaW5kZXhPZihkaW0pID09PSAtMSkgcmV0dXJuIG51bGw7CgoJICAvLyBleHRyYWN0IERNUwoJICB2YXIgZGVnID0gbVsyXSA/IHBhcnNlRmxvYXQobVsyXSkgOiAwOwoJICB2YXIgbWluID0gbVszXSA/IHBhcnNlRmxvYXQobVszXSkgLyA2MCA6IDA7CgkgIHZhciBzZWMgPSBtWzRdID8gcGFyc2VGbG9hdChtWzRdKSAvIDM2MDAgOiAwOwoJICB2YXIgc2lnbiA9IChkZWcgPCAwKSA/IC0xIDogMTsKCSAgaWYgKGRpbSA9PT0gJ1MnIHx8IGRpbSA9PT0gJ1cnKSBzaWduICo9IC0xOwoKCSAgcmV0dXJuIHsKCSAgICB2YWw6IChNYXRoLmFicyhkZWcpICsgbWluICsgc2VjKSAqIHNpZ24sCgkgICAgZGltOiBkaW0sCgkgICAgbWF0Y2hlZDogbWF0Y2hlZCwKCSAgICByZW1haW46IGlucHV0LnNsaWNlKG1hdGNoZWQubGVuZ3RoKQoJICB9OwoJfQoKCglmdW5jdGlvbiBwYWlyKGlucHV0LCBkaW1zKSB7CgkgIGlucHV0ID0gaW5wdXQudHJpbSgpOwoJICB2YXIgb25lID0gc2VhcmNoKGlucHV0LCBkaW1zKTsKCSAgaWYgKCFvbmUpIHJldHVybiBudWxsOwoKCSAgaW5wdXQgPSBvbmUucmVtYWluLnRyaW0oKTsKCSAgdmFyIHR3byA9IHNlYXJjaChpbnB1dCwgZGltcyk7CgkgIGlmICghdHdvIHx8IHR3by5yZW1haW4pIHJldHVybiBudWxsOwoKCSAgaWYgKG9uZS5kaW0pIHsKCSAgICByZXR1cm4gc3dhcGRpbShvbmUudmFsLCB0d28udmFsLCBvbmUuZGltKTsKCSAgfSBlbHNlIHsKCSAgICByZXR1cm4gW29uZS52YWwsIHR3by52YWxdOwoJICB9Cgl9CgoKCWZ1bmN0aW9uIHN3YXBkaW0oYSwgYiwgZGltKSB7CgkgIGlmIChkaW0gPT09ICdOJyB8fCBkaW0gPT09ICdTJykgcmV0dXJuIFthLCBiXTsKCSAgaWYgKGRpbSA9PT0gJ1cnIHx8IGRpbSA9PT0gJ0UnKSByZXR1cm4gW2IsIGFdOwoJfQoKCXZhciBkc3YgPSBkM0Rzdi5leHBvcnRzLAoJICAgIHNleGFnZXNpbWFsID0gc2V4YWdlc2ltYWwkMS5leHBvcnRzOwoKCXZhciBsYXRSZWdleCA9IC8oTGF0KShpdHVkZSk/L2dpLAoJICAgIGxvblJlZ2V4ID0gLyhMKShvbnxuZykoZ2l0dWRlKT8vaTsKCglmdW5jdGlvbiBndWVzc0hlYWRlcihyb3csIHJlZ2V4cCkgewoJICAgIHZhciBuYW1lLCBtYXRjaCwgc2NvcmU7CgkgICAgZm9yICh2YXIgZiBpbiByb3cpIHsKCSAgICAgICAgbWF0Y2ggPSBmLm1hdGNoKHJlZ2V4cCk7CgkgICAgICAgIGlmIChtYXRjaCAmJiAoIW5hbWUgfHwgbWF0Y2hbMF0ubGVuZ3RoIC8gZi5sZW5ndGggPiBzY29yZSkpIHsKCSAgICAgICAgICAgIHNjb3JlID0gbWF0Y2hbMF0ubGVuZ3RoIC8gZi5sZW5ndGg7CgkgICAgICAgICAgICBuYW1lID0gZjsKCSAgICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gbmFtZTsKCX0KCglmdW5jdGlvbiBndWVzc0xhdEhlYWRlcihyb3cpIHsgcmV0dXJuIGd1ZXNzSGVhZGVyKHJvdywgbGF0UmVnZXgpOyB9CglmdW5jdGlvbiBndWVzc0xvbkhlYWRlcihyb3cpIHsgcmV0dXJuIGd1ZXNzSGVhZGVyKHJvdywgbG9uUmVnZXgpOyB9CgoJZnVuY3Rpb24gaXNMYXQoZikgeyByZXR1cm4gISFmLm1hdGNoKGxhdFJlZ2V4KTsgfQoJZnVuY3Rpb24gaXNMb24oZikgeyByZXR1cm4gISFmLm1hdGNoKGxvblJlZ2V4KTsgfQoKCWZ1bmN0aW9uIGtleUNvdW50KG8pIHsKCSAgICByZXR1cm4gKHR5cGVvZiBvID09ICdvYmplY3QnKSA/IE9iamVjdC5rZXlzKG8pLmxlbmd0aCA6IDA7Cgl9CgoJZnVuY3Rpb24gYXV0b0RlbGltaXRlcih4KSB7CgkgICAgdmFyIGRlbGltaXRlcnMgPSBbJywnLCAnOycsICdcdCcsICd8J107CgkgICAgdmFyIHJlc3VsdHMgPSBbXTsKCgkgICAgZGVsaW1pdGVycy5mb3JFYWNoKGZ1bmN0aW9uIChkZWxpbWl0ZXIpIHsKCSAgICAgICAgdmFyIHJlcyA9IGRzdi5kc3ZGb3JtYXQoZGVsaW1pdGVyKS5wYXJzZSh4KTsKCSAgICAgICAgaWYgKHJlcy5sZW5ndGggPj0gMSkgewoJICAgICAgICAgICAgdmFyIGNvdW50ID0ga2V5Q291bnQocmVzWzBdKTsKCSAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzLmxlbmd0aDsgaSsrKSB7CgkgICAgICAgICAgICAgICAgaWYgKGtleUNvdW50KHJlc1tpXSkgIT09IGNvdW50KSByZXR1cm47CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXN1bHRzLnB1c2goewoJICAgICAgICAgICAgICAgIGRlbGltaXRlcjogZGVsaW1pdGVyLAoJICAgICAgICAgICAgICAgIGFyaXR5OiBPYmplY3Qua2V5cyhyZXNbMF0pLmxlbmd0aCwKCSAgICAgICAgICAgIH0pOwoJICAgICAgICB9CgkgICAgfSk7CgoJICAgIGlmIChyZXN1bHRzLmxlbmd0aCkgewoJICAgICAgICByZXR1cm4gcmVzdWx0cy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CgkgICAgICAgICAgICByZXR1cm4gYi5hcml0eSAtIGEuYXJpdHk7CgkgICAgICAgIH0pWzBdLmRlbGltaXRlcjsKCSAgICB9IGVsc2UgewoJICAgICAgICByZXR1cm4gbnVsbDsKCSAgICB9Cgl9CgoJLyoqCgkgKiBTaWxseSBzdG9wZ2FwIGZvciBkc3YgdG8gZDMtZHN2IHVwZ3JhZGUKCSAqCgkgKiBAcGFyYW0ge0FycmF5fSB4IGRzdiBvdXRwdXQKCSAqIEByZXR1cm5zIHtBcnJheX0gYXJyYXkgd2l0aG91dCBjb2x1bW5zIG1lbWJlcgoJICovCglmdW5jdGlvbiBkZWxldGVDb2x1bW5zKHgpIHsKCSAgICBkZWxldGUgeC5jb2x1bW5zOwoJICAgIHJldHVybiB4OwoJfQoKCWZ1bmN0aW9uIGF1dG8oeCkgewoJICAgIHZhciBkZWxpbWl0ZXIgPSBhdXRvRGVsaW1pdGVyKHgpOwoJICAgIGlmICghZGVsaW1pdGVyKSByZXR1cm4gbnVsbDsKCSAgICByZXR1cm4gZGVsZXRlQ29sdW1ucyhkc3YuZHN2Rm9ybWF0KGRlbGltaXRlcikucGFyc2UoeCkpOwoJfQoKCWZ1bmN0aW9uIGNzdjJnZW9qc29uKHgsIG9wdGlvbnMsIGNhbGxiYWNrKSB7CgoJICAgIGlmICghY2FsbGJhY2spIHsKCSAgICAgICAgY2FsbGJhY2sgPSBvcHRpb25zOwoJICAgICAgICBvcHRpb25zID0ge307CgkgICAgfQoKCSAgICBvcHRpb25zLmRlbGltaXRlciA9IG9wdGlvbnMuZGVsaW1pdGVyIHx8ICcsJzsKCgkgICAgdmFyIGxhdGZpZWxkID0gb3B0aW9ucy5sYXRmaWVsZCB8fCAnJywKCSAgICAgICAgbG9uZmllbGQgPSBvcHRpb25zLmxvbmZpZWxkIHx8ICcnLAoJICAgICAgICBjcnMgPSBvcHRpb25zLmNycyB8fCAnJzsKCgkgICAgdmFyIGZlYXR1cmVzID0gW10sCgkgICAgICAgIGZlYXR1cmVjb2xsZWN0aW9uID0ge3R5cGU6ICdGZWF0dXJlQ29sbGVjdGlvbicsIGZlYXR1cmVzOiBmZWF0dXJlc307CgoJICAgIGlmIChjcnMgIT09ICcnKSB7CgkgICAgICAgIGZlYXR1cmVjb2xsZWN0aW9uLmNycyA9IHt0eXBlOiAnbmFtZScsIHByb3BlcnRpZXM6IHtuYW1lOiBjcnN9fTsKCSAgICB9CgoJICAgIGlmIChvcHRpb25zLmRlbGltaXRlciA9PT0gJ2F1dG8nICYmIHR5cGVvZiB4ID09ICdzdHJpbmcnKSB7CgkgICAgICAgIG9wdGlvbnMuZGVsaW1pdGVyID0gYXV0b0RlbGltaXRlcih4KTsKCSAgICAgICAgaWYgKCFvcHRpb25zLmRlbGltaXRlcikgewoJICAgICAgICAgICAgY2FsbGJhY2soewoJICAgICAgICAgICAgICAgIHR5cGU6ICdFcnJvcicsCgkgICAgICAgICAgICAgICAgbWVzc2FnZTogJ0NvdWxkIG5vdCBhdXRvZGV0ZWN0IGRlbGltaXRlcicKCSAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICB9CgkgICAgfQoKCSAgICB2YXIgbnVtZXJpY0ZpZWxkcyA9IG9wdGlvbnMubnVtZXJpY0ZpZWxkcyA/IG9wdGlvbnMubnVtZXJpY0ZpZWxkcy5zcGxpdCgnLCcpIDogbnVsbDsKCgkgICAgdmFyIHBhcnNlZCA9ICh0eXBlb2YgeCA9PSAnc3RyaW5nJykgPwoJICAgICAgICBkc3YuZHN2Rm9ybWF0KG9wdGlvbnMuZGVsaW1pdGVyKS5wYXJzZSh4LCBmdW5jdGlvbiAoZCkgewoJICAgICAgICAgICAgaWYgKG51bWVyaWNGaWVsZHMpIHsKCSAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZCkgewoJICAgICAgICAgICAgICAgICAgICBpZiAobnVtZXJpY0ZpZWxkcy5pbmNsdWRlcyhrZXkpKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBkW2tleV0gPSArZFtrZXldOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIGQ7CgkgICAgICAgIH0pIDogeDsKCgkgICAgaWYgKCFwYXJzZWQubGVuZ3RoKSB7CgkgICAgICAgIGNhbGxiYWNrKG51bGwsIGZlYXR1cmVjb2xsZWN0aW9uKTsKCSAgICAgICAgcmV0dXJuOwoJICAgIH0KCgkgICAgdmFyIGVycm9ycyA9IFtdOwoJICAgIHZhciBpOwoKCgkgICAgaWYgKCFsYXRmaWVsZCkgbGF0ZmllbGQgPSBndWVzc0xhdEhlYWRlcihwYXJzZWRbMF0pOwoJICAgIGlmICghbG9uZmllbGQpIGxvbmZpZWxkID0gZ3Vlc3NMb25IZWFkZXIocGFyc2VkWzBdKTsKCSAgICB2YXIgbm9HZW9tZXRyeSA9ICghbGF0ZmllbGQgfHwgIWxvbmZpZWxkKTsKCgkgICAgaWYgKG5vR2VvbWV0cnkpIHsKCSAgICAgICAgZm9yIChpID0gMDsgaSA8IHBhcnNlZC5sZW5ndGg7IGkrKykgewoJICAgICAgICAgICAgZmVhdHVyZXMucHVzaCh7CgkgICAgICAgICAgICAgICAgdHlwZTogJ0ZlYXR1cmUnLAoJICAgICAgICAgICAgICAgIHByb3BlcnRpZXM6IHBhcnNlZFtpXSwKCSAgICAgICAgICAgICAgICBnZW9tZXRyeTogbnVsbAoJICAgICAgICAgICAgfSk7CgkgICAgICAgIH0KCSAgICAgICAgY2FsbGJhY2soZXJyb3JzLmxlbmd0aCA/IGVycm9ycyA6IG51bGwsIGZlYXR1cmVjb2xsZWN0aW9uKTsKCSAgICAgICAgcmV0dXJuOwoJICAgIH0KCgkgICAgZm9yIChpID0gMDsgaSA8IHBhcnNlZC5sZW5ndGg7IGkrKykgewoJICAgICAgICBpZiAocGFyc2VkW2ldW2xvbmZpZWxkXSAhPT0gdW5kZWZpbmVkICYmCgkgICAgICAgICAgICBwYXJzZWRbaV1bbGF0ZmllbGRdICE9PSB1bmRlZmluZWQpIHsKCgkgICAgICAgICAgICB2YXIgbG9uayA9IHBhcnNlZFtpXVtsb25maWVsZF0sCgkgICAgICAgICAgICAgICAgbGF0ayA9IHBhcnNlZFtpXVtsYXRmaWVsZF0sCgkgICAgICAgICAgICAgICAgbG9uZiwgbGF0ZiwKCSAgICAgICAgICAgICAgICBhOwoKCSAgICAgICAgICAgIGEgPSBzZXhhZ2VzaW1hbChsb25rLCAnRVcnKTsKCSAgICAgICAgICAgIGlmIChhKSBsb25rID0gYTsKCSAgICAgICAgICAgIGEgPSBzZXhhZ2VzaW1hbChsYXRrLCAnTlMnKTsKCSAgICAgICAgICAgIGlmIChhKSBsYXRrID0gYTsKCgkgICAgICAgICAgICBsb25mID0gcGFyc2VGbG9hdChsb25rKTsKCSAgICAgICAgICAgIGxhdGYgPSBwYXJzZUZsb2F0KGxhdGspOwoKCSAgICAgICAgICAgIGlmIChpc05hTihsb25mKSB8fAoJICAgICAgICAgICAgICAgIGlzTmFOKGxhdGYpKSB7CgkgICAgICAgICAgICAgICAgZXJyb3JzLnB1c2goewoJICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiAnQSByb3cgY29udGFpbmVkIGFuIGludmFsaWQgdmFsdWUgZm9yIGxhdGl0dWRlIG9yIGxvbmdpdHVkZScsCgkgICAgICAgICAgICAgICAgICAgIHJvdzogcGFyc2VkW2ldLAoJICAgICAgICAgICAgICAgICAgICBpbmRleDogaQoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMuaW5jbHVkZUxhdExvbikgewoJICAgICAgICAgICAgICAgICAgICBkZWxldGUgcGFyc2VkW2ldW2xvbmZpZWxkXTsKCSAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHBhcnNlZFtpXVtsYXRmaWVsZF07CgkgICAgICAgICAgICAgICAgfQoKCSAgICAgICAgICAgICAgICBmZWF0dXJlcy5wdXNoKHsKCSAgICAgICAgICAgICAgICAgICAgdHlwZTogJ0ZlYXR1cmUnLAoJICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiBwYXJzZWRbaV0sCgkgICAgICAgICAgICAgICAgICAgIGdlb21ldHJ5OiB7CgkgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnUG9pbnQnLAoJICAgICAgICAgICAgICAgICAgICAgICAgY29vcmRpbmF0ZXM6IFsKCSAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJzZUZsb2F0KGxvbmYpLAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlRmxvYXQobGF0ZikKCSAgICAgICAgICAgICAgICAgICAgICAgIF0KCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0pOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgfQoKCSAgICBjYWxsYmFjayhlcnJvcnMubGVuZ3RoID8gZXJyb3JzIDogbnVsbCwgZmVhdHVyZWNvbGxlY3Rpb24pOwoJfQoKCWZ1bmN0aW9uIHRvTGluZShnaikgewoJICAgIHZhciBmZWF0dXJlcyA9IGdqLmZlYXR1cmVzOwoJICAgIHZhciBsaW5lID0gewoJICAgICAgICB0eXBlOiAnRmVhdHVyZScsCgkgICAgICAgIGdlb21ldHJ5OiB7CgkgICAgICAgICAgICB0eXBlOiAnTGluZVN0cmluZycsCgkgICAgICAgICAgICBjb29yZGluYXRlczogW10KCSAgICAgICAgfQoJICAgIH07CgkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmZWF0dXJlcy5sZW5ndGg7IGkrKykgewoJICAgICAgICBsaW5lLmdlb21ldHJ5LmNvb3JkaW5hdGVzLnB1c2goZmVhdHVyZXNbaV0uZ2VvbWV0cnkuY29vcmRpbmF0ZXMpOwoJICAgIH0KCSAgICBsaW5lLnByb3BlcnRpZXMgPSBmZWF0dXJlcy5yZWR1Y2UoZnVuY3Rpb24gKGFnZ3JlZ2F0ZWRQcm9wZXJ0aWVzLCBuZXdGZWF0dXJlKSB7CgkgICAgICAgIGZvciAodmFyIGtleSBpbiBuZXdGZWF0dXJlLnByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgIGlmICghYWdncmVnYXRlZFByb3BlcnRpZXNba2V5XSkgewoJICAgICAgICAgICAgICAgIGFnZ3JlZ2F0ZWRQcm9wZXJ0aWVzW2tleV0gPSBbXTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGFnZ3JlZ2F0ZWRQcm9wZXJ0aWVzW2tleV0ucHVzaChuZXdGZWF0dXJlLnByb3BlcnRpZXNba2V5XSk7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIGFnZ3JlZ2F0ZWRQcm9wZXJ0aWVzOwoJICAgIH0sIHt9KTsKCSAgICByZXR1cm4gewoJICAgICAgICB0eXBlOiAnRmVhdHVyZUNvbGxlY3Rpb24nLAoJICAgICAgICBmZWF0dXJlczogW2xpbmVdCgkgICAgfTsKCX0KCglmdW5jdGlvbiB0b1BvbHlnb24oZ2opIHsKCSAgICB2YXIgZmVhdHVyZXMgPSBnai5mZWF0dXJlczsKCSAgICB2YXIgcG9seSA9IHsKCSAgICAgICAgdHlwZTogJ0ZlYXR1cmUnLAoJICAgICAgICBnZW9tZXRyeTogewoJICAgICAgICAgICAgdHlwZTogJ1BvbHlnb24nLAoJICAgICAgICAgICAgY29vcmRpbmF0ZXM6IFtbXV0KCSAgICAgICAgfQoJICAgIH07CgkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmZWF0dXJlcy5sZW5ndGg7IGkrKykgewoJICAgICAgICBwb2x5Lmdlb21ldHJ5LmNvb3JkaW5hdGVzWzBdLnB1c2goZmVhdHVyZXNbaV0uZ2VvbWV0cnkuY29vcmRpbmF0ZXMpOwoJICAgIH0KCSAgICBwb2x5LnByb3BlcnRpZXMgPSBmZWF0dXJlcy5yZWR1Y2UoZnVuY3Rpb24gKGFnZ3JlZ2F0ZWRQcm9wZXJ0aWVzLCBuZXdGZWF0dXJlKSB7CgkgICAgICAgIGZvciAodmFyIGtleSBpbiBuZXdGZWF0dXJlLnByb3BlcnRpZXMpIHsKCSAgICAgICAgICAgIGlmICghYWdncmVnYXRlZFByb3BlcnRpZXNba2V5XSkgewoJICAgICAgICAgICAgICAgIGFnZ3JlZ2F0ZWRQcm9wZXJ0aWVzW2tleV0gPSBbXTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGFnZ3JlZ2F0ZWRQcm9wZXJ0aWVzW2tleV0ucHVzaChuZXdGZWF0dXJlLnByb3BlcnRpZXNba2V5XSk7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIGFnZ3JlZ2F0ZWRQcm9wZXJ0aWVzOwoJICAgIH0sIHt9KTsKCSAgICByZXR1cm4gewoJICAgICAgICB0eXBlOiAnRmVhdHVyZUNvbGxlY3Rpb24nLAoJICAgICAgICBmZWF0dXJlczogW3BvbHldCgkgICAgfTsKCX0KCgl2YXIgY3N2Mmdlb2pzb25fMSA9IHsKCSAgICBpc0xvbjogaXNMb24sCgkgICAgaXNMYXQ6IGlzTGF0LAoJICAgIGd1ZXNzTGF0SGVhZGVyOiBndWVzc0xhdEhlYWRlciwKCSAgICBndWVzc0xvbkhlYWRlcjogZ3Vlc3NMb25IZWFkZXIsCgkgICAgY3N2OiBkc3YuY3N2UGFyc2UsCgkgICAgdHN2OiBkc3YudHN2UGFyc2UsCgkgICAgZHN2OiBkc3YsCgkgICAgYXV0bzogYXV0bywKCSAgICBjc3YyZ2VvanNvbjogY3N2Mmdlb2pzb24sCgkgICAgdG9MaW5lOiB0b0xpbmUsCgkgICAgdG9Qb2x5Z29uOiB0b1BvbHlnb24KCX07CgoJZnVuY3Rpb24gaWRlbnRpdHkoeCkgewoJICByZXR1cm4geDsKCX0KCglmdW5jdGlvbiB0cmFuc2Zvcm0odHJhbnNmb3JtKSB7CgkgIGlmICh0cmFuc2Zvcm0gPT0gbnVsbCkgcmV0dXJuIGlkZW50aXR5OwoJICB2YXIgeDAsCgkgICAgICB5MCwKCSAgICAgIGt4ID0gdHJhbnNmb3JtLnNjYWxlWzBdLAoJICAgICAga3kgPSB0cmFuc2Zvcm0uc2NhbGVbMV0sCgkgICAgICBkeCA9IHRyYW5zZm9ybS50cmFuc2xhdGVbMF0sCgkgICAgICBkeSA9IHRyYW5zZm9ybS50cmFuc2xhdGVbMV07CgkgIHJldHVybiBmdW5jdGlvbihpbnB1dCwgaSkgewoJICAgIGlmICghaSkgeDAgPSB5MCA9IDA7CgkgICAgdmFyIGogPSAyLCBuID0gaW5wdXQubGVuZ3RoLCBvdXRwdXQgPSBuZXcgQXJyYXkobik7CgkgICAgb3V0cHV0WzBdID0gKHgwICs9IGlucHV0WzBdKSAqIGt4ICsgZHg7CgkgICAgb3V0cHV0WzFdID0gKHkwICs9IGlucHV0WzFdKSAqIGt5ICsgZHk7CgkgICAgd2hpbGUgKGogPCBuKSBvdXRwdXRbal0gPSBpbnB1dFtqXSwgKytqOwoJICAgIHJldHVybiBvdXRwdXQ7CgkgIH07Cgl9CgoJZnVuY3Rpb24gcmV2ZXJzZShhcnJheSwgbikgewoJICB2YXIgdCwgaiA9IGFycmF5Lmxlbmd0aCwgaSA9IGogLSBuOwoJICB3aGlsZSAoaSA8IC0taikgdCA9IGFycmF5W2ldLCBhcnJheVtpKytdID0gYXJyYXlbal0sIGFycmF5W2pdID0gdDsKCX0KCglmdW5jdGlvbiB0b3BvanNvbkZlYXR1cmUodG9wb2xvZ3ksIG8pIHsKCSAgaWYgKHR5cGVvZiBvID09PSAic3RyaW5nIikgbyA9IHRvcG9sb2d5Lm9iamVjdHNbb107CgkgIHJldHVybiBvLnR5cGUgPT09ICJHZW9tZXRyeUNvbGxlY3Rpb24iCgkgICAgICA/IHt0eXBlOiAiRmVhdHVyZUNvbGxlY3Rpb24iLCBmZWF0dXJlczogby5nZW9tZXRyaWVzLm1hcChmdW5jdGlvbihvKSB7IHJldHVybiBmZWF0dXJlKHRvcG9sb2d5LCBvKTsgfSl9CgkgICAgICA6IGZlYXR1cmUodG9wb2xvZ3ksIG8pOwoJfQoKCWZ1bmN0aW9uIGZlYXR1cmUodG9wb2xvZ3ksIG8pIHsKCSAgdmFyIGlkID0gby5pZCwKCSAgICAgIGJib3ggPSBvLmJib3gsCgkgICAgICBwcm9wZXJ0aWVzID0gby5wcm9wZXJ0aWVzID09IG51bGwgPyB7fSA6IG8ucHJvcGVydGllcywKCSAgICAgIGdlb21ldHJ5ID0gb2JqZWN0KHRvcG9sb2d5LCBvKTsKCSAgcmV0dXJuIGlkID09IG51bGwgJiYgYmJveCA9PSBudWxsID8ge3R5cGU6ICJGZWF0dXJlIiwgcHJvcGVydGllczogcHJvcGVydGllcywgZ2VvbWV0cnk6IGdlb21ldHJ5fQoJICAgICAgOiBiYm94ID09IG51bGwgPyB7dHlwZTogIkZlYXR1cmUiLCBpZDogaWQsIHByb3BlcnRpZXM6IHByb3BlcnRpZXMsIGdlb21ldHJ5OiBnZW9tZXRyeX0KCSAgICAgIDoge3R5cGU6ICJGZWF0dXJlIiwgaWQ6IGlkLCBiYm94OiBiYm94LCBwcm9wZXJ0aWVzOiBwcm9wZXJ0aWVzLCBnZW9tZXRyeTogZ2VvbWV0cnl9OwoJfQoKCWZ1bmN0aW9uIG9iamVjdCh0b3BvbG9neSwgbykgewoJICB2YXIgdHJhbnNmb3JtUG9pbnQgPSB0cmFuc2Zvcm0odG9wb2xvZ3kudHJhbnNmb3JtKSwKCSAgICAgIGFyY3MgPSB0b3BvbG9neS5hcmNzOwoKCSAgZnVuY3Rpb24gYXJjKGksIHBvaW50cykgewoJICAgIGlmIChwb2ludHMubGVuZ3RoKSBwb2ludHMucG9wKCk7CgkgICAgZm9yICh2YXIgYSA9IGFyY3NbaSA8IDAgPyB+aSA6IGldLCBrID0gMCwgbiA9IGEubGVuZ3RoOyBrIDwgbjsgKytrKSB7CgkgICAgICBwb2ludHMucHVzaCh0cmFuc2Zvcm1Qb2ludChhW2tdLCBrKSk7CgkgICAgfQoJICAgIGlmIChpIDwgMCkgcmV2ZXJzZShwb2ludHMsIG4pOwoJICB9CgoJICBmdW5jdGlvbiBwb2ludChwKSB7CgkgICAgcmV0dXJuIHRyYW5zZm9ybVBvaW50KHApOwoJICB9CgoJICBmdW5jdGlvbiBsaW5lKGFyY3MpIHsKCSAgICB2YXIgcG9pbnRzID0gW107CgkgICAgZm9yICh2YXIgaSA9IDAsIG4gPSBhcmNzLmxlbmd0aDsgaSA8IG47ICsraSkgYXJjKGFyY3NbaV0sIHBvaW50cyk7CgkgICAgaWYgKHBvaW50cy5sZW5ndGggPCAyKSBwb2ludHMucHVzaChwb2ludHNbMF0pOyAvLyBUaGlzIHNob3VsZCBuZXZlciBoYXBwZW4gcGVyIHRoZSBzcGVjaWZpY2F0aW9uLgoJICAgIHJldHVybiBwb2ludHM7CgkgIH0KCgkgIGZ1bmN0aW9uIHJpbmcoYXJjcykgewoJICAgIHZhciBwb2ludHMgPSBsaW5lKGFyY3MpOwoJICAgIHdoaWxlIChwb2ludHMubGVuZ3RoIDwgNCkgcG9pbnRzLnB1c2gocG9pbnRzWzBdKTsgLy8gVGhpcyBtYXkgaGFwcGVuIGlmIGFuIGFyYyBoYXMgb25seSB0d28gcG9pbnRzLgoJICAgIHJldHVybiBwb2ludHM7CgkgIH0KCgkgIGZ1bmN0aW9uIHBvbHlnb24oYXJjcykgewoJICAgIHJldHVybiBhcmNzLm1hcChyaW5nKTsKCSAgfQoKCSAgZnVuY3Rpb24gZ2VvbWV0cnkobykgewoJICAgIHZhciB0eXBlID0gby50eXBlLCBjb29yZGluYXRlczsKCSAgICBzd2l0Y2ggKHR5cGUpIHsKCSAgICAgIGNhc2UgIkdlb21ldHJ5Q29sbGVjdGlvbiI6IHJldHVybiB7dHlwZTogdHlwZSwgZ2VvbWV0cmllczogby5nZW9tZXRyaWVzLm1hcChnZW9tZXRyeSl9OwoJICAgICAgY2FzZSAiUG9pbnQiOiBjb29yZGluYXRlcyA9IHBvaW50KG8uY29vcmRpbmF0ZXMpOyBicmVhazsKCSAgICAgIGNhc2UgIk11bHRpUG9pbnQiOiBjb29yZGluYXRlcyA9IG8uY29vcmRpbmF0ZXMubWFwKHBvaW50KTsgYnJlYWs7CgkgICAgICBjYXNlICJMaW5lU3RyaW5nIjogY29vcmRpbmF0ZXMgPSBsaW5lKG8uYXJjcyk7IGJyZWFrOwoJICAgICAgY2FzZSAiTXVsdGlMaW5lU3RyaW5nIjogY29vcmRpbmF0ZXMgPSBvLmFyY3MubWFwKGxpbmUpOyBicmVhazsKCSAgICAgIGNhc2UgIlBvbHlnb24iOiBjb29yZGluYXRlcyA9IHBvbHlnb24oby5hcmNzKTsgYnJlYWs7CgkgICAgICBjYXNlICJNdWx0aVBvbHlnb24iOiBjb29yZGluYXRlcyA9IG8uYXJjcy5tYXAocG9seWdvbik7IGJyZWFrOwoJICAgICAgZGVmYXVsdDogcmV0dXJuIG51bGw7CgkgICAgfQoJICAgIHJldHVybiB7dHlwZTogdHlwZSwgY29vcmRpbmF0ZXM6IGNvb3JkaW5hdGVzfTsKCSAgfQoKCSAgcmV0dXJuIGdlb21ldHJ5KG8pOwoJfQoKCWZ1bmN0aW9uICQoZWxlbWVudCwgdGFnTmFtZSkgewoJICAgIHJldHVybiBBcnJheS5mcm9tKGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFnTmFtZSkpOwoJfQoJZnVuY3Rpb24gbm9ybWFsaXplSWQoaWQpIHsKCSAgICByZXR1cm4gaWRbMF0gPT09ICIjIiA/IGlkIDogYCMke2lkfWA7Cgl9CglmdW5jdGlvbiAkbnMoZWxlbWVudCwgdGFnTmFtZSwgbnMpIHsKCSAgICByZXR1cm4gQXJyYXkuZnJvbShlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lTlMobnMsIHRhZ05hbWUpKTsKCX0KCS8qKgoJICogZ2V0IHRoZSBjb250ZW50IG9mIGEgdGV4dCBub2RlLCBpZiBhbnkKCSAqLwoJZnVuY3Rpb24gbm9kZVZhbChub2RlKSB7CgkgICAgbm9kZT8ubm9ybWFsaXplKCk7CgkgICAgcmV0dXJuIChub2RlICYmIG5vZGUudGV4dENvbnRlbnQpIHx8ICIiOwoJfQoJLyoqCgkgKiBHZXQgb25lIFkgY2hpbGQgb2YgWCwgaWYgYW55LCBvdGhlcndpc2UgbnVsbAoJICovCglmdW5jdGlvbiBnZXQxKG5vZGUsIHRhZ05hbWUsIGNhbGxiYWNrKSB7CgkgICAgY29uc3QgbiA9IG5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFnTmFtZSk7CgkgICAgY29uc3QgcmVzdWx0ID0gbi5sZW5ndGggPyBuWzBdIDogbnVsbDsKCSAgICBpZiAocmVzdWx0ICYmIGNhbGxiYWNrKQoJICAgICAgICBjYWxsYmFjayhyZXN1bHQpOwoJICAgIHJldHVybiByZXN1bHQ7Cgl9CglmdW5jdGlvbiBnZXQobm9kZSwgdGFnTmFtZSwgY2FsbGJhY2spIHsKCSAgICBjb25zdCBwcm9wZXJ0aWVzID0ge307CgkgICAgaWYgKCFub2RlKQoJICAgICAgICByZXR1cm4gcHJvcGVydGllczsKCSAgICBjb25zdCBuID0gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWdOYW1lKTsKCSAgICBjb25zdCByZXN1bHQgPSBuLmxlbmd0aCA/IG5bMF0gOiBudWxsOwoJICAgIGlmIChyZXN1bHQgJiYgY2FsbGJhY2spIHsKCSAgICAgICAgcmV0dXJuIGNhbGxiYWNrKHJlc3VsdCwgcHJvcGVydGllcyk7CgkgICAgfQoJICAgIHJldHVybiBwcm9wZXJ0aWVzOwoJfQoJZnVuY3Rpb24gdmFsMShub2RlLCB0YWdOYW1lLCBjYWxsYmFjaykgewoJICAgIGNvbnN0IHZhbCA9IG5vZGVWYWwoZ2V0MShub2RlLCB0YWdOYW1lKSk7CgkgICAgaWYgKHZhbCAmJiBjYWxsYmFjaykKCSAgICAgICAgcmV0dXJuIGNhbGxiYWNrKHZhbCkgfHwge307CgkgICAgcmV0dXJuIHt9OwoJfQoJZnVuY3Rpb24gJG51bShub2RlLCB0YWdOYW1lLCBjYWxsYmFjaykgewoJICAgIGNvbnN0IHZhbCA9IHBhcnNlRmxvYXQobm9kZVZhbChnZXQxKG5vZGUsIHRhZ05hbWUpKSk7CgkgICAgaWYgKGlzTmFOKHZhbCkpCgkgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CgkgICAgaWYgKHZhbCAmJiBjYWxsYmFjaykKCSAgICAgICAgcmV0dXJuIGNhbGxiYWNrKHZhbCkgfHwge307CgkgICAgcmV0dXJuIHt9OwoJfQoJZnVuY3Rpb24gbnVtMShub2RlLCB0YWdOYW1lLCBjYWxsYmFjaykgewoJICAgIGNvbnN0IHZhbCA9IHBhcnNlRmxvYXQobm9kZVZhbChnZXQxKG5vZGUsIHRhZ05hbWUpKSk7CgkgICAgaWYgKGlzTmFOKHZhbCkpCgkgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CgkgICAgaWYgKHZhbCAmJiBjYWxsYmFjaykKCSAgICAgICAgY2FsbGJhY2sodmFsKTsKCSAgICByZXR1cm4gdmFsOwoJfQoJZnVuY3Rpb24gZ2V0TXVsdGkobm9kZSwgcHJvcGVydHlOYW1lcykgewoJICAgIGNvbnN0IHByb3BlcnRpZXMgPSB7fTsKCSAgICBmb3IgKGNvbnN0IHByb3BlcnR5IG9mIHByb3BlcnR5TmFtZXMpIHsKCSAgICAgICAgdmFsMShub2RlLCBwcm9wZXJ0eSwgKHZhbCkgPT4gewoJICAgICAgICAgICAgcHJvcGVydGllc1twcm9wZXJ0eV0gPSB2YWw7CgkgICAgICAgIH0pOwoJICAgIH0KCSAgICByZXR1cm4gcHJvcGVydGllczsKCX0KCWZ1bmN0aW9uIGlzRWxlbWVudChub2RlKSB7CgkgICAgcmV0dXJuIG5vZGU/Lm5vZGVUeXBlID09PSAxOwoJfQoKCWZ1bmN0aW9uIGdldExpbmVTdHlsZShub2RlKSB7CgkgICAgcmV0dXJuIGdldChub2RlLCAibGluZSIsIChsaW5lU3R5bGUpID0+IHsKCSAgICAgICAgY29uc3QgdmFsID0gT2JqZWN0LmFzc2lnbih7fSwgdmFsMShsaW5lU3R5bGUsICJjb2xvciIsIChjb2xvcikgPT4gewoJICAgICAgICAgICAgcmV0dXJuIHsgc3Ryb2tlOiBgIyR7Y29sb3J9YCB9OwoJICAgICAgICB9KSwgJG51bShsaW5lU3R5bGUsICJvcGFjaXR5IiwgKG9wYWNpdHkpID0+IHsKCSAgICAgICAgICAgIHJldHVybiB7ICJzdHJva2Utb3BhY2l0eSI6IG9wYWNpdHkgfTsKCSAgICAgICAgfSksICRudW0obGluZVN0eWxlLCAid2lkdGgiLCAod2lkdGgpID0+IHsKCSAgICAgICAgICAgIC8vIEdQWCB3aWR0aCBpcyBpbiBtbSwgY29udmVydCB0byBweCB3aXRoIDk2IHB4IHBlciBpbmNoCgkgICAgICAgICAgICByZXR1cm4geyAic3Ryb2tlLXdpZHRoIjogKHdpZHRoICogOTYpIC8gMjUuNCB9OwoJICAgICAgICB9KSk7CgkgICAgICAgIHJldHVybiB2YWw7CgkgICAgfSk7Cgl9CgoJZnVuY3Rpb24gZ2V0RXh0ZW5zaW9ucyhub2RlKSB7CgkgICAgbGV0IHZhbHVlcyA9IFtdOwoJICAgIGlmIChub2RlID09PSBudWxsKQoJICAgICAgICByZXR1cm4gdmFsdWVzOwoJICAgIGZvciAoY29uc3QgY2hpbGQgb2YgQXJyYXkuZnJvbShub2RlLmNoaWxkTm9kZXMpKSB7CgkgICAgICAgIGlmICghaXNFbGVtZW50KGNoaWxkKSkKCSAgICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICBjb25zdCBuYW1lID0gYWJicmV2aWF0ZU5hbWUoY2hpbGQubm9kZU5hbWUpOwoJICAgICAgICBpZiAobmFtZSA9PT0gImdweHRweDpUcmFja1BvaW50RXh0ZW5zaW9uIikgewoJICAgICAgICAgICAgLy8gbG9vcCBhZ2FpbiBmb3IgbmVzdGVkIGdhcm1pbiBleHRlbnNpb25zIChlZy4gImdweHRweDpociIpCgkgICAgICAgICAgICB2YWx1ZXMgPSB2YWx1ZXMuY29uY2F0KGdldEV4dGVuc2lvbnMoY2hpbGQpKTsKCSAgICAgICAgfQoJICAgICAgICBlbHNlIHsKCSAgICAgICAgICAgIC8vIHB1c2ggY3VzdG9tIGV4dGVuc2lvbiAoZWcuICJwb3dlciIpCgkgICAgICAgICAgICBjb25zdCB2YWwgPSBub2RlVmFsKGNoaWxkKTsKCSAgICAgICAgICAgIHZhbHVlcy5wdXNoKFtuYW1lLCBwYXJzZU51bWVyaWModmFsKV0pOwoJICAgICAgICB9CgkgICAgfQoJICAgIHJldHVybiB2YWx1ZXM7Cgl9CglmdW5jdGlvbiBhYmJyZXZpYXRlTmFtZShuYW1lKSB7CgkgICAgcmV0dXJuIFsiaGVhcnQiLCAiZ3B4dHB4OmhyIiwgImhyIl0uaW5jbHVkZXMobmFtZSkgPyAiaGVhcnQiIDogbmFtZTsKCX0KCWZ1bmN0aW9uIHBhcnNlTnVtZXJpYyh2YWwpIHsKCSAgICBjb25zdCBudW0gPSBwYXJzZUZsb2F0KHZhbCk7CgkgICAgcmV0dXJuIGlzTmFOKG51bSkgPyB2YWwgOiBudW07Cgl9CgoJZnVuY3Rpb24gY29vcmRQYWlyJDEobm9kZSkgewoJICAgIGNvbnN0IGxsID0gWwoJICAgICAgICBwYXJzZUZsb2F0KG5vZGUuZ2V0QXR0cmlidXRlKCJsb24iKSB8fCAiIiksCgkgICAgICAgIHBhcnNlRmxvYXQobm9kZS5nZXRBdHRyaWJ1dGUoImxhdCIpIHx8ICIiKSwKCSAgICBdOwoJICAgIGlmIChpc05hTihsbFswXSkgfHwgaXNOYU4obGxbMV0pKSB7CgkgICAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICBudW0xKG5vZGUsICJlbGUiLCAodmFsKSA9PiB7CgkgICAgICAgIGxsLnB1c2godmFsKTsKCSAgICB9KTsKCSAgICBjb25zdCB0aW1lID0gZ2V0MShub2RlLCAidGltZSIpOwoJICAgIHJldHVybiB7CgkgICAgICAgIGNvb3JkaW5hdGVzOiBsbCwKCSAgICAgICAgdGltZTogdGltZSA/IG5vZGVWYWwodGltZSkgOiBudWxsLAoJICAgICAgICBleHRlbmRlZFZhbHVlczogZ2V0RXh0ZW5zaW9ucyhnZXQxKG5vZGUsICJleHRlbnNpb25zIikpLAoJICAgIH07Cgl9CgoJZnVuY3Rpb24gZXh0cmFjdFByb3BlcnRpZXMobm9kZSkgewoJICAgIGNvbnN0IHByb3BlcnRpZXMgPSBnZXRNdWx0aShub2RlLCBbCgkgICAgICAgICJuYW1lIiwKCSAgICAgICAgImNtdCIsCgkgICAgICAgICJkZXNjIiwKCSAgICAgICAgInR5cGUiLAoJICAgICAgICAidGltZSIsCgkgICAgICAgICJrZXl3b3JkcyIsCgkgICAgXSk7CgkgICAgY29uc3QgZXh0ZW5zaW9ucyA9IEFycmF5LmZyb20obm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZU5TKCJodHRwOi8vd3d3Lmdhcm1pbi5jb20veG1sc2NoZW1hcy9HcHhFeHRlbnNpb25zL3YzIiwgIioiKSk7CgkgICAgZm9yIChjb25zdCBjaGlsZCBvZiBleHRlbnNpb25zKSB7CgkgICAgICAgIGlmIChjaGlsZC5wYXJlbnROb2RlPy5wYXJlbnROb2RlID09PSBub2RlKSB7CgkgICAgICAgICAgICBwcm9wZXJ0aWVzW2NoaWxkLnRhZ05hbWUucmVwbGFjZSgiOiIsICJfIildID0gbm9kZVZhbChjaGlsZCk7CgkgICAgICAgIH0KCSAgICB9CgkgICAgY29uc3QgbGlua3MgPSAkKG5vZGUsICJsaW5rIik7CgkgICAgaWYgKGxpbmtzLmxlbmd0aCkgewoJICAgICAgICBwcm9wZXJ0aWVzLmxpbmtzID0gbGlua3MubWFwKChsaW5rKSA9PiBPYmplY3QuYXNzaWduKHsgaHJlZjogbGluay5nZXRBdHRyaWJ1dGUoImhyZWYiKSB9LCBnZXRNdWx0aShsaW5rLCBbInRleHQiLCAidHlwZSJdKSkpOwoJICAgIH0KCSAgICByZXR1cm4gcHJvcGVydGllczsKCX0KCgkvKioKCSAqIEV4dHJhY3QgcG9pbnRzIGZyb20gYSB0cmtzZWcgb3IgcnRlIGVsZW1lbnQuCgkgKi8KCWZ1bmN0aW9uIGdldFBvaW50cyQxKG5vZGUsIHBvaW50bmFtZSkgewoJICAgIGNvbnN0IHB0cyA9ICQobm9kZSwgcG9pbnRuYW1lKTsKCSAgICBjb25zdCBsaW5lID0gW107CgkgICAgY29uc3QgdGltZXMgPSBbXTsKCSAgICBjb25zdCBleHRlbmRlZFZhbHVlcyA9IHt9OwoJICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHRzLmxlbmd0aDsgaSsrKSB7CgkgICAgICAgIGNvbnN0IGMgPSBjb29yZFBhaXIkMShwdHNbaV0pOwoJICAgICAgICBpZiAoIWMpIHsKCSAgICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICB9CgkgICAgICAgIGxpbmUucHVzaChjLmNvb3JkaW5hdGVzKTsKCSAgICAgICAgaWYgKGMudGltZSkKCSAgICAgICAgICAgIHRpbWVzLnB1c2goYy50aW1lKTsKCSAgICAgICAgZm9yIChjb25zdCBbbmFtZSwgdmFsXSBvZiBjLmV4dGVuZGVkVmFsdWVzKSB7CgkgICAgICAgICAgICBjb25zdCBwbHVyYWwgPSBuYW1lID09PSAiaGVhcnQiID8gbmFtZSA6IG5hbWUucmVwbGFjZSgiZ3B4dHB4OiIsICIiKSArICJzIjsKCSAgICAgICAgICAgIGlmICghZXh0ZW5kZWRWYWx1ZXNbcGx1cmFsXSkgewoJICAgICAgICAgICAgICAgIGV4dGVuZGVkVmFsdWVzW3BsdXJhbF0gPSBBcnJheShwdHMubGVuZ3RoKS5maWxsKG51bGwpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgZXh0ZW5kZWRWYWx1ZXNbcGx1cmFsXVtpXSA9IHZhbDsKCSAgICAgICAgfQoJICAgIH0KCSAgICBpZiAobGluZS5sZW5ndGggPCAyKQoJICAgICAgICByZXR1cm47IC8vIEludmFsaWQgbGluZSBpbiBHZW9KU09OCgkgICAgcmV0dXJuIHsKCSAgICAgICAgbGluZTogbGluZSwKCSAgICAgICAgdGltZXM6IHRpbWVzLAoJICAgICAgICBleHRlbmRlZFZhbHVlczogZXh0ZW5kZWRWYWx1ZXMsCgkgICAgfTsKCX0KCS8qKgoJICogRXh0cmFjdCBhIExpbmVTdHJpbmcgZ2VvbWV0cnkgZnJvbSBhIHJ0ZQoJICogZWxlbWVudC4KCSAqLwoJZnVuY3Rpb24gZ2V0Um91dGUobm9kZSkgewoJICAgIGNvbnN0IGxpbmUgPSBnZXRQb2ludHMkMShub2RlLCAicnRlcHQiKTsKCSAgICBpZiAoIWxpbmUpCgkgICAgICAgIHJldHVybjsKCSAgICByZXR1cm4gewoJICAgICAgICB0eXBlOiAiRmVhdHVyZSIsCgkgICAgICAgIHByb3BlcnRpZXM6IE9iamVjdC5hc3NpZ24oeyBfZ3B4VHlwZTogInJ0ZSIgfSwgZXh0cmFjdFByb3BlcnRpZXMobm9kZSksIGdldExpbmVTdHlsZShnZXQxKG5vZGUsICJleHRlbnNpb25zIikpKSwKCSAgICAgICAgZ2VvbWV0cnk6IHsKCSAgICAgICAgICAgIHR5cGU6ICJMaW5lU3RyaW5nIiwKCSAgICAgICAgICAgIGNvb3JkaW5hdGVzOiBsaW5lLmxpbmUsCgkgICAgICAgIH0sCgkgICAgfTsKCX0KCWZ1bmN0aW9uIGdldFRyYWNrKG5vZGUpIHsKCSAgICBjb25zdCBzZWdtZW50cyA9ICQobm9kZSwgInRya3NlZyIpOwoJICAgIGNvbnN0IHRyYWNrID0gW107CgkgICAgY29uc3QgdGltZXMgPSBbXTsKCSAgICBjb25zdCBleHRyYWN0ZWRMaW5lcyA9IFtdOwoJICAgIGZvciAoY29uc3Qgc2VnbWVudCBvZiBzZWdtZW50cykgewoJICAgICAgICBjb25zdCBsaW5lID0gZ2V0UG9pbnRzJDEoc2VnbWVudCwgInRya3B0Iik7CgkgICAgICAgIGlmIChsaW5lKSB7CgkgICAgICAgICAgICBleHRyYWN0ZWRMaW5lcy5wdXNoKGxpbmUpOwoJICAgICAgICAgICAgaWYgKGxpbmUudGltZXMgJiYgbGluZS50aW1lcy5sZW5ndGgpCgkgICAgICAgICAgICAgICAgdGltZXMucHVzaChsaW5lLnRpbWVzKTsKCSAgICAgICAgfQoJICAgIH0KCSAgICBpZiAoZXh0cmFjdGVkTGluZXMubGVuZ3RoID09PSAwKQoJICAgICAgICByZXR1cm4gbnVsbDsKCSAgICBjb25zdCBtdWx0aSA9IGV4dHJhY3RlZExpbmVzLmxlbmd0aCA+IDE7CgkgICAgY29uc3QgcHJvcGVydGllcyA9IE9iamVjdC5hc3NpZ24oeyBfZ3B4VHlwZTogInRyayIgfSwgZXh0cmFjdFByb3BlcnRpZXMobm9kZSksIGdldExpbmVTdHlsZShnZXQxKG5vZGUsICJleHRlbnNpb25zIikpLCB0aW1lcy5sZW5ndGgKCSAgICAgICAgPyB7CgkgICAgICAgICAgICBjb29yZGluYXRlUHJvcGVydGllczogewoJICAgICAgICAgICAgICAgIHRpbWVzOiBtdWx0aSA/IHRpbWVzIDogdGltZXNbMF0sCgkgICAgICAgICAgICB9LAoJICAgICAgICB9CgkgICAgICAgIDoge30pOwoJICAgIGZvciAoY29uc3QgbGluZSBvZiBleHRyYWN0ZWRMaW5lcykgewoJICAgICAgICB0cmFjay5wdXNoKGxpbmUubGluZSk7CgkgICAgICAgIGlmICghcHJvcGVydGllcy5jb29yZGluYXRlUHJvcGVydGllcykgewoJICAgICAgICAgICAgcHJvcGVydGllcy5jb29yZGluYXRlUHJvcGVydGllcyA9IHt9OwoJICAgICAgICB9CgkgICAgICAgIGNvbnN0IHByb3BzID0gcHJvcGVydGllcy5jb29yZGluYXRlUHJvcGVydGllczsKCSAgICAgICAgY29uc3QgZW50cmllcyA9IE9iamVjdC5lbnRyaWVzKGxpbmUuZXh0ZW5kZWRWYWx1ZXMpOwoJICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVudHJpZXMubGVuZ3RoOyBpKyspIHsKCSAgICAgICAgICAgIGNvbnN0IFtuYW1lLCB2YWxdID0gZW50cmllc1tpXTsKCSAgICAgICAgICAgIGlmIChtdWx0aSkgewoJICAgICAgICAgICAgICAgIGlmICghcHJvcHNbbmFtZV0pIHsKCSAgICAgICAgICAgICAgICAgICAgcHJvcHNbbmFtZV0gPSBleHRyYWN0ZWRMaW5lcy5tYXAoKGxpbmUpID0+IG5ldyBBcnJheShsaW5lLmxpbmUubGVuZ3RoKS5maWxsKG51bGwpKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgcHJvcHNbbmFtZV1baV0gPSB2YWw7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBlbHNlIHsKCSAgICAgICAgICAgICAgICBwcm9wc1tuYW1lXSA9IHZhbDsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgIH0KCSAgICByZXR1cm4gewoJICAgICAgICB0eXBlOiAiRmVhdHVyZSIsCgkgICAgICAgIHByb3BlcnRpZXM6IHByb3BlcnRpZXMsCgkgICAgICAgIGdlb21ldHJ5OiBtdWx0aQoJICAgICAgICAgICAgPyB7CgkgICAgICAgICAgICAgICAgdHlwZTogIk11bHRpTGluZVN0cmluZyIsCgkgICAgICAgICAgICAgICAgY29vcmRpbmF0ZXM6IHRyYWNrLAoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgOiB7CgkgICAgICAgICAgICAgICAgdHlwZTogIkxpbmVTdHJpbmciLAoJICAgICAgICAgICAgICAgIGNvb3JkaW5hdGVzOiB0cmFja1swXSwKCSAgICAgICAgICAgIH0sCgkgICAgfTsKCX0KCS8qKgoJICogRXh0cmFjdCBhIHBvaW50LCBpZiBwb3NzaWJsZSwgZnJvbSBhIGdpdmVuIG5vZGUsCgkgKiB3aGljaCBpcyB1c3VhbGx5IGEgd3B0IG9yIHRya3B0CgkgKi8KCWZ1bmN0aW9uIGdldFBvaW50KG5vZGUpIHsKCSAgICBjb25zdCBwcm9wZXJ0aWVzID0gT2JqZWN0LmFzc2lnbihleHRyYWN0UHJvcGVydGllcyhub2RlKSwgZ2V0TXVsdGkobm9kZSwgWyJzeW0iXSkpOwoJICAgIGNvbnN0IHBhaXIgPSBjb29yZFBhaXIkMShub2RlKTsKCSAgICBpZiAoIXBhaXIpCgkgICAgICAgIHJldHVybiBudWxsOwoJICAgIHJldHVybiB7CgkgICAgICAgIHR5cGU6ICJGZWF0dXJlIiwKCSAgICAgICAgcHJvcGVydGllcywKCSAgICAgICAgZ2VvbWV0cnk6IHsKCSAgICAgICAgICAgIHR5cGU6ICJQb2ludCIsCgkgICAgICAgICAgICBjb29yZGluYXRlczogcGFpci5jb29yZGluYXRlcywKCSAgICAgICAgfSwKCSAgICB9OwoJfQoJLyoqCgkgKiBDb252ZXJ0IEdQWCB0byBHZW9KU09OIGluY3JlbWVudGFsbHksIHJldHVybmluZwoJICogYSBbR2VuZXJhdG9yXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9KYXZhU2NyaXB0L0d1aWRlL0l0ZXJhdG9yc19hbmRfR2VuZXJhdG9ycykKCSAqIHRoYXQgeWllbGRzIG91dHB1dCBmZWF0dXJlIGJ5IGZlYXR1cmUuCgkgKi8KCWZ1bmN0aW9uKiBncHhHZW4obm9kZSkgewoJICAgIGZvciAoY29uc3QgdHJhY2sgb2YgJChub2RlLCAidHJrIikpIHsKCSAgICAgICAgY29uc3QgZmVhdHVyZSA9IGdldFRyYWNrKHRyYWNrKTsKCSAgICAgICAgaWYgKGZlYXR1cmUpCgkgICAgICAgICAgICB5aWVsZCBmZWF0dXJlOwoJICAgIH0KCSAgICBmb3IgKGNvbnN0IHJvdXRlIG9mICQobm9kZSwgInJ0ZSIpKSB7CgkgICAgICAgIGNvbnN0IGZlYXR1cmUgPSBnZXRSb3V0ZShyb3V0ZSk7CgkgICAgICAgIGlmIChmZWF0dXJlKQoJICAgICAgICAgICAgeWllbGQgZmVhdHVyZTsKCSAgICB9CgkgICAgZm9yIChjb25zdCB3YXlwb2ludCBvZiAkKG5vZGUsICJ3cHQiKSkgewoJICAgICAgICBjb25zdCBwb2ludCA9IGdldFBvaW50KHdheXBvaW50KTsKCSAgICAgICAgaWYgKHBvaW50KQoJICAgICAgICAgICAgeWllbGQgcG9pbnQ7CgkgICAgfQoJfQoJLyoqCgkgKgoJICogQ29udmVydCBhIEdQWCBkb2N1bWVudCB0byBHZW9KU09OLiBUaGUgZmlyc3QgYXJndW1lbnQsIGBkb2NgLCBtdXN0IGJlIGEgR1BYCgkgKiBkb2N1bWVudCBhcyBhbiBYTUwgRE9NIC0gbm90IGFzIGEgc3RyaW5nLiBZb3UgY2FuIGdldCB0aGlzIHVzaW5nIGpRdWVyeSdzIGRlZmF1bHQKCSAqIGAuYWpheGAgZnVuY3Rpb24gb3IgdXNpbmcgYSBiYXJlIFhNTEh0dHBSZXF1ZXN0IHdpdGggdGhlIGAucmVzcG9uc2VgIHByb3BlcnR5CgkgKiBob2xkaW5nIGFuIFhNTCBET00uCgkgKgoJICogVGhlIG91dHB1dCBpcyBhIEphdmFTY3JpcHQgb2JqZWN0IG9mIEdlb0pTT04gZGF0YSwgc2FtZSBhcyBgLmttbGAgb3V0cHV0cywgd2l0aCB0aGUKCSAqIGFkZGl0aW9uIG9mIGEgYF9ncHhUeXBlYCBwcm9wZXJ0eSBvbiBlYWNoIGBMaW5lU3RyaW5nYCBmZWF0dXJlIHRoYXQgaW5kaWNhdGVzIHdoZXRoZXIKCSAqIHRoZSBmZWF0dXJlIHdhcyBlbmNvZGVkIGFzIGEgcm91dGUgKGBydGVgKSBvciB0cmFjayAoYHRya2ApIGluIHRoZSBHUFggZG9jdW1lbnQuCgkgKi8KCWZ1bmN0aW9uIGdweChub2RlKSB7CgkgICAgcmV0dXJuIHsKCSAgICAgICAgdHlwZTogIkZlYXR1cmVDb2xsZWN0aW9uIiwKCSAgICAgICAgZmVhdHVyZXM6IEFycmF5LmZyb20oZ3B4R2VuKG5vZGUpKSwKCSAgICB9OwoJfQoKCWNvbnN0IEVYVEVOU0lPTlNfTlMgPSAiaHR0cDovL3d3dy5nYXJtaW4uY29tL3htbHNjaGVtYXMvQWN0aXZpdHlFeHRlbnNpb24vdjIiOwoJY29uc3QgVFJBQ0tQT0lOVF9BVFRSSUJVVEVTID0gWwoJICAgIFsiaGVhcnRSYXRlIiwgImhlYXJ0UmF0ZXMiXSwKCSAgICBbIkNhZGVuY2UiLCAiY2FkZW5jZXMiXSwKCSAgICAvLyBFeHRlbmRlZCBUcmFja3BvaW50IGF0dHJpYnV0ZXMKCSAgICBbIlNwZWVkIiwgInNwZWVkcyJdLAoJICAgIFsiV2F0dHMiLCAid2F0dHMiXSwKCV07Cgljb25zdCBMQVBfQVRUUklCVVRFUyA9IFsKCSAgICBbIlRvdGFsVGltZVNlY29uZHMiLCAidG90YWxUaW1lU2Vjb25kcyJdLAoJICAgIFsiRGlzdGFuY2VNZXRlcnMiLCAiZGlzdGFuY2VNZXRlcnMiXSwKCSAgICBbIk1heGltdW1TcGVlZCIsICJtYXhTcGVlZCJdLAoJICAgIFsiQXZlcmFnZUhlYXJ0UmF0ZUJwbSIsICJhdmdIZWFydFJhdGUiXSwKCSAgICBbIk1heGltdW1IZWFydFJhdGVCcG0iLCAibWF4SGVhcnRSYXRlIl0sCgkgICAgLy8gRXh0ZW5kZWQgTGFwIGF0dHJpYnV0ZXMKCSAgICBbIkF2Z1NwZWVkIiwgImF2Z1NwZWVkIl0sCgkgICAgWyJBdmdXYXR0cyIsICJhdmdXYXR0cyJdLAoJICAgIFsiTWF4V2F0dHMiLCAibWF4V2F0dHMiXSwKCV07CglmdW5jdGlvbiBnZXRQcm9wZXJ0aWVzKG5vZGUsIGF0dHJpYnV0ZU5hbWVzKSB7CgkgICAgY29uc3QgcHJvcGVydGllcyA9IFtdOwoJICAgIGZvciAoY29uc3QgW3RhZywgYWxpYXNdIG9mIGF0dHJpYnV0ZU5hbWVzKSB7CgkgICAgICAgIGxldCBlbGVtID0gZ2V0MShub2RlLCB0YWcpOwoJICAgICAgICBpZiAoIWVsZW0pIHsKCSAgICAgICAgICAgIGNvbnN0IGVsZW1lbnRzID0gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZU5TKEVYVEVOU0lPTlNfTlMsIHRhZyk7CgkgICAgICAgICAgICBpZiAoZWxlbWVudHMubGVuZ3RoKSB7CgkgICAgICAgICAgICAgICAgZWxlbSA9IGVsZW1lbnRzWzBdOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgICAgIGNvbnN0IHZhbCA9IHBhcnNlRmxvYXQobm9kZVZhbChlbGVtKSk7CgkgICAgICAgIGlmICghaXNOYU4odmFsKSkgewoJICAgICAgICAgICAgcHJvcGVydGllcy5wdXNoKFthbGlhcywgdmFsXSk7CgkgICAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIHByb3BlcnRpZXM7Cgl9CglmdW5jdGlvbiBjb29yZFBhaXIobm9kZSkgewoJICAgIGNvbnN0IGxsID0gW251bTEobm9kZSwgIkxvbmdpdHVkZURlZ3JlZXMiKSwgbnVtMShub2RlLCAiTGF0aXR1ZGVEZWdyZWVzIildOwoJICAgIGlmIChsbFswXSA9PT0gdW5kZWZpbmVkIHx8CgkgICAgICAgIGlzTmFOKGxsWzBdKSB8fAoJICAgICAgICBsbFsxXSA9PT0gdW5kZWZpbmVkIHx8CgkgICAgICAgIGlzTmFOKGxsWzFdKSkgewoJICAgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgkgICAgY29uc3QgaGVhcnRSYXRlID0gZ2V0MShub2RlLCAiSGVhcnRSYXRlQnBtIik7CgkgICAgY29uc3QgdGltZSA9IG5vZGVWYWwoZ2V0MShub2RlLCAiVGltZSIpKTsKCSAgICBnZXQxKG5vZGUsICJBbHRpdHVkZU1ldGVycyIsIChhbHQpID0+IHsKCSAgICAgICAgY29uc3QgYSA9IHBhcnNlRmxvYXQobm9kZVZhbChhbHQpKTsKCSAgICAgICAgaWYgKCFpc05hTihhKSkgewoJICAgICAgICAgICAgbGwucHVzaChhKTsKCSAgICAgICAgfQoJICAgIH0pOwoJICAgIHJldHVybiB7CgkgICAgICAgIGNvb3JkaW5hdGVzOiBsbCwKCSAgICAgICAgdGltZTogdGltZSB8fCBudWxsLAoJICAgICAgICBoZWFydFJhdGU6IGhlYXJ0UmF0ZSA/IHBhcnNlRmxvYXQobm9kZVZhbChoZWFydFJhdGUpKSA6IG51bGwsCgkgICAgICAgIGV4dGVuc2lvbnM6IGdldFByb3BlcnRpZXMobm9kZSwgVFJBQ0tQT0lOVF9BVFRSSUJVVEVTKSwKCSAgICB9OwoJfQoJZnVuY3Rpb24gZ2V0UG9pbnRzKG5vZGUpIHsKCSAgICBjb25zdCBwdHMgPSAkKG5vZGUsICJUcmFja3BvaW50Iik7CgkgICAgY29uc3QgbGluZSA9IFtdOwoJICAgIGNvbnN0IHRpbWVzID0gW107CgkgICAgY29uc3QgaGVhcnRSYXRlcyA9IFtdOwoJICAgIGlmIChwdHMubGVuZ3RoIDwgMikKCSAgICAgICAgcmV0dXJuIG51bGw7IC8vIEludmFsaWQgbGluZSBpbiBHZW9KU09OCgkgICAgY29uc3QgZXh0ZW5kZWRQcm9wZXJ0aWVzID0ge307CgkgICAgY29uc3QgcmVzdWx0ID0geyBleHRlbmRlZFByb3BlcnRpZXMgfTsKCSAgICBmb3IgKGxldCBpID0gMDsgaSA8IHB0cy5sZW5ndGg7IGkrKykgewoJICAgICAgICBjb25zdCBjID0gY29vcmRQYWlyKHB0c1tpXSk7CgkgICAgICAgIGlmIChjID09PSBudWxsKQoJICAgICAgICAgICAgY29udGludWU7CgkgICAgICAgIGxpbmUucHVzaChjLmNvb3JkaW5hdGVzKTsKCSAgICAgICAgY29uc3QgeyB0aW1lLCBoZWFydFJhdGUsIGV4dGVuc2lvbnMgfSA9IGM7CgkgICAgICAgIGlmICh0aW1lKQoJICAgICAgICAgICAgdGltZXMucHVzaCh0aW1lKTsKCSAgICAgICAgaWYgKGhlYXJ0UmF0ZSkKCSAgICAgICAgICAgIGhlYXJ0UmF0ZXMucHVzaChoZWFydFJhdGUpOwoJICAgICAgICBmb3IgKGNvbnN0IFthbGlhcywgdmFsdWVdIG9mIGV4dGVuc2lvbnMpIHsKCSAgICAgICAgICAgIGlmICghZXh0ZW5kZWRQcm9wZXJ0aWVzW2FsaWFzXSkgewoJICAgICAgICAgICAgICAgIGV4dGVuZGVkUHJvcGVydGllc1thbGlhc10gPSBBcnJheShwdHMubGVuZ3RoKS5maWxsKG51bGwpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgZXh0ZW5kZWRQcm9wZXJ0aWVzW2FsaWFzXVtpXSA9IHZhbHVlOwoJICAgICAgICB9CgkgICAgfQoJICAgIGlmIChsaW5lLmxlbmd0aCA8IDIpCgkgICAgICAgIHJldHVybiBudWxsOwoJICAgIHJldHVybiBPYmplY3QuYXNzaWduKHJlc3VsdCwgewoJICAgICAgICBsaW5lOiBsaW5lLAoJICAgICAgICB0aW1lczogdGltZXMsCgkgICAgICAgIGhlYXJ0UmF0ZXM6IGhlYXJ0UmF0ZXMsCgkgICAgfSk7Cgl9CglmdW5jdGlvbiBnZXRMYXAobm9kZSkgewoJICAgIGNvbnN0IHNlZ21lbnRzID0gJChub2RlLCAiVHJhY2siKTsKCSAgICBjb25zdCB0cmFjayA9IFtdOwoJICAgIGNvbnN0IHRpbWVzID0gW107CgkgICAgY29uc3QgaGVhcnRSYXRlcyA9IFtdOwoJICAgIGNvbnN0IGFsbEV4dGVuZGVkUHJvcGVydGllcyA9IFtdOwoJICAgIGxldCBsaW5lOwoJICAgIGNvbnN0IHByb3BlcnRpZXMgPSBPYmplY3QuYXNzaWduKE9iamVjdC5mcm9tRW50cmllcyhnZXRQcm9wZXJ0aWVzKG5vZGUsIExBUF9BVFRSSUJVVEVTKSksIGdldChub2RlLCAiTmFtZSIsIChuYW1lRWxlbWVudCkgPT4gewoJICAgICAgICByZXR1cm4geyBuYW1lOiBub2RlVmFsKG5hbWVFbGVtZW50KSB9OwoJICAgIH0pKTsKCSAgICBmb3IgKGNvbnN0IHNlZ21lbnQgb2Ygc2VnbWVudHMpIHsKCSAgICAgICAgbGluZSA9IGdldFBvaW50cyhzZWdtZW50KTsKCSAgICAgICAgaWYgKGxpbmUpIHsKCSAgICAgICAgICAgIHRyYWNrLnB1c2gobGluZS5saW5lKTsKCSAgICAgICAgICAgIGlmIChsaW5lLnRpbWVzLmxlbmd0aCkKCSAgICAgICAgICAgICAgICB0aW1lcy5wdXNoKGxpbmUudGltZXMpOwoJICAgICAgICAgICAgaWYgKGxpbmUuaGVhcnRSYXRlcy5sZW5ndGgpCgkgICAgICAgICAgICAgICAgaGVhcnRSYXRlcy5wdXNoKGxpbmUuaGVhcnRSYXRlcyk7CgkgICAgICAgICAgICBhbGxFeHRlbmRlZFByb3BlcnRpZXMucHVzaChsaW5lLmV4dGVuZGVkUHJvcGVydGllcyk7CgkgICAgICAgIH0KCSAgICB9CgkgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhbGxFeHRlbmRlZFByb3BlcnRpZXMubGVuZ3RoOyBpKyspIHsKCSAgICAgICAgY29uc3QgZXh0ZW5kZWRQcm9wZXJ0aWVzID0gYWxsRXh0ZW5kZWRQcm9wZXJ0aWVzW2ldOwoJICAgICAgICBmb3IgKGNvbnN0IHByb3BlcnR5IGluIGV4dGVuZGVkUHJvcGVydGllcykgewoJICAgICAgICAgICAgaWYgKHNlZ21lbnRzLmxlbmd0aCA9PT0gMSkgewoJICAgICAgICAgICAgICAgIGlmIChsaW5lKSB7CgkgICAgICAgICAgICAgICAgICAgIHByb3BlcnRpZXNbcHJvcGVydHldID0gbGluZS5leHRlbmRlZFByb3BlcnRpZXNbcHJvcGVydHldOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGVsc2UgewoJICAgICAgICAgICAgICAgIGlmICghcHJvcGVydGllc1twcm9wZXJ0eV0pIHsKCSAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllc1twcm9wZXJ0eV0gPSB0cmFjay5tYXAoKHRyYWNrKSA9PiBBcnJheSh0cmFjay5sZW5ndGgpLmZpbGwobnVsbCkpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzW3Byb3BlcnR5XVtpXSA9IGV4dGVuZGVkUHJvcGVydGllc1twcm9wZXJ0eV07CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9CgkgICAgaWYgKHRyYWNrLmxlbmd0aCA9PT0gMCkKCSAgICAgICAgcmV0dXJuIG51bGw7CgkgICAgaWYgKHRpbWVzLmxlbmd0aCB8fCBoZWFydFJhdGVzLmxlbmd0aCkgewoJICAgICAgICBwcm9wZXJ0aWVzLmNvb3JkaW5hdGVQcm9wZXJ0aWVzID0gT2JqZWN0LmFzc2lnbih0aW1lcy5sZW5ndGgKCSAgICAgICAgICAgID8gewoJICAgICAgICAgICAgICAgIHRpbWVzOiB0cmFjay5sZW5ndGggPT09IDEgPyB0aW1lc1swXSA6IHRpbWVzLAoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgOiB7fSwgaGVhcnRSYXRlcy5sZW5ndGgKCSAgICAgICAgICAgID8gewoJICAgICAgICAgICAgICAgIGhlYXJ0OiB0cmFjay5sZW5ndGggPT09IDEgPyBoZWFydFJhdGVzWzBdIDogaGVhcnRSYXRlcywKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIDoge30pOwoJICAgIH0KCSAgICByZXR1cm4gewoJICAgICAgICB0eXBlOiAiRmVhdHVyZSIsCgkgICAgICAgIHByb3BlcnRpZXM6IHByb3BlcnRpZXMsCgkgICAgICAgIGdlb21ldHJ5OiB0cmFjay5sZW5ndGggPT09IDEKCSAgICAgICAgICAgID8gewoJICAgICAgICAgICAgICAgIHR5cGU6ICJMaW5lU3RyaW5nIiwKCSAgICAgICAgICAgICAgICBjb29yZGluYXRlczogdHJhY2tbMF0sCgkgICAgICAgICAgICB9CgkgICAgICAgICAgICA6IHsKCSAgICAgICAgICAgICAgICB0eXBlOiAiTXVsdGlMaW5lU3RyaW5nIiwKCSAgICAgICAgICAgICAgICBjb29yZGluYXRlczogdHJhY2ssCgkgICAgICAgICAgICB9LAoJICAgIH07Cgl9CgkvKioKCSAqIEluY3JlbWVudGFsbHkgY29udmVydCBhIFRDWCBkb2N1bWVudCB0byBHZW9KU09OLiBUaGUKCSAqIGZpcnN0IGFyZ3VtZW50LCBgZG9jYCwgbXVzdCBiZSBhIFRDWAoJICogZG9jdW1lbnQgYXMgYW4gWE1MIERPTSAtIG5vdCBhcyBhIHN0cmluZy4KCSAqLwoJZnVuY3Rpb24qIHRjeEdlbihub2RlKSB7CgkgICAgZm9yIChjb25zdCBsYXAgb2YgJChub2RlLCAiTGFwIikpIHsKCSAgICAgICAgY29uc3QgZmVhdHVyZSA9IGdldExhcChsYXApOwoJICAgICAgICBpZiAoZmVhdHVyZSkKCSAgICAgICAgICAgIHlpZWxkIGZlYXR1cmU7CgkgICAgfQoJICAgIGZvciAoY29uc3QgY291cnNlIG9mICQobm9kZSwgIkNvdXJzZXMiKSkgewoJICAgICAgICBjb25zdCBmZWF0dXJlID0gZ2V0TGFwKGNvdXJzZSk7CgkgICAgICAgIGlmIChmZWF0dXJlKQoJICAgICAgICAgICAgeWllbGQgZmVhdHVyZTsKCSAgICB9Cgl9CgkvKioKCSAqIENvbnZlcnQgYSBUQ1ggZG9jdW1lbnQgdG8gR2VvSlNPTi4gVGhlIGZpcnN0IGFyZ3VtZW50LCBgZG9jYCwgbXVzdCBiZSBhIFRDWAoJICogZG9jdW1lbnQgYXMgYW4gWE1MIERPTSAtIG5vdCBhcyBhIHN0cmluZy4KCSAqLwoJZnVuY3Rpb24gdGN4KG5vZGUpIHsKCSAgICByZXR1cm4gewoJICAgICAgICB0eXBlOiAiRmVhdHVyZUNvbGxlY3Rpb24iLAoJICAgICAgICBmZWF0dXJlczogQXJyYXkuZnJvbSh0Y3hHZW4obm9kZSkpLAoJICAgIH07Cgl9CgoJZnVuY3Rpb24gZml4Q29sb3IodiwgcHJlZml4KSB7CgkgICAgY29uc3QgcHJvcGVydGllcyA9IHt9OwoJICAgIGNvbnN0IGNvbG9yUHJvcCA9IHByZWZpeCA9PSAic3Ryb2tlIiB8fCBwcmVmaXggPT09ICJmaWxsIiA/IHByZWZpeCA6IHByZWZpeCArICItY29sb3IiOwoJICAgIGlmICh2WzBdID09PSAiIyIpIHsKCSAgICAgICAgdiA9IHYuc3Vic3RyaW5nKDEpOwoJICAgIH0KCSAgICBpZiAodi5sZW5ndGggPT09IDYgfHwgdi5sZW5ndGggPT09IDMpIHsKCSAgICAgICAgcHJvcGVydGllc1tjb2xvclByb3BdID0gIiMiICsgdjsKCSAgICB9CgkgICAgZWxzZSBpZiAodi5sZW5ndGggPT09IDgpIHsKCSAgICAgICAgcHJvcGVydGllc1twcmVmaXggKyAiLW9wYWNpdHkiXSA9IHBhcnNlSW50KHYuc3Vic3RyaW5nKDAsIDIpLCAxNikgLyAyNTU7CgkgICAgICAgIHByb3BlcnRpZXNbY29sb3JQcm9wXSA9CgkgICAgICAgICAgICAiIyIgKyB2LnN1YnN0cmluZyg2LCA4KSArIHYuc3Vic3RyaW5nKDQsIDYpICsgdi5zdWJzdHJpbmcoMiwgNCk7CgkgICAgfQoJICAgIHJldHVybiBwcm9wZXJ0aWVzOwoJfQoKCWZ1bmN0aW9uIG51bWVyaWNQcm9wZXJ0eShub2RlLCBzb3VyY2UsIHRhcmdldCkgewoJICAgIGNvbnN0IHByb3BlcnRpZXMgPSB7fTsKCSAgICBudW0xKG5vZGUsIHNvdXJjZSwgKHZhbCkgPT4gewoJICAgICAgICBwcm9wZXJ0aWVzW3RhcmdldF0gPSB2YWw7CgkgICAgfSk7CgkgICAgcmV0dXJuIHByb3BlcnRpZXM7Cgl9CglmdW5jdGlvbiBnZXRDb2xvcihub2RlLCBvdXRwdXQpIHsKCSAgICByZXR1cm4gZ2V0KG5vZGUsICJjb2xvciIsIChlbGVtKSA9PiBmaXhDb2xvcihub2RlVmFsKGVsZW0pLCBvdXRwdXQpKTsKCX0KCWZ1bmN0aW9uIGV4dHJhY3RJY29uKG5vZGUpIHsKCSAgICByZXR1cm4gZ2V0KG5vZGUsICJJY29uU3R5bGUiLCAoaWNvblN0eWxlKSA9PiB7CgkgICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKGdldENvbG9yKGljb25TdHlsZSwgImljb24iKSwgbnVtZXJpY1Byb3BlcnR5KGljb25TdHlsZSwgInNjYWxlIiwgImljb24tc2NhbGUiKSwgbnVtZXJpY1Byb3BlcnR5KGljb25TdHlsZSwgImhlYWRpbmciLCAiaWNvbi1oZWFkaW5nIiksIGdldChpY29uU3R5bGUsICJob3RTcG90IiwgKGhvdHNwb3QpID0+IHsKCSAgICAgICAgICAgIGNvbnN0IGxlZnQgPSBwYXJzZUZsb2F0KGhvdHNwb3QuZ2V0QXR0cmlidXRlKCJ4IikgfHwgIiIpOwoJICAgICAgICAgICAgY29uc3QgdG9wID0gcGFyc2VGbG9hdChob3RzcG90LmdldEF0dHJpYnV0ZSgieSIpIHx8ICIiKTsKCSAgICAgICAgICAgIGNvbnN0IHh1bml0cyA9IGhvdHNwb3QuZ2V0QXR0cmlidXRlKCJ4dW5pdHMiKSB8fCAiIjsKCSAgICAgICAgICAgIGNvbnN0IHl1bml0cyA9IGhvdHNwb3QuZ2V0QXR0cmlidXRlKCJ5dW5pdHMiKSB8fCAiIjsKCSAgICAgICAgICAgIGlmICghaXNOYU4obGVmdCkgJiYgIWlzTmFOKHRvcCkpCgkgICAgICAgICAgICAgICAgcmV0dXJuIHsKCSAgICAgICAgICAgICAgICAgICAgImljb24tb2Zmc2V0IjogW2xlZnQsIHRvcF0sCgkgICAgICAgICAgICAgICAgICAgICJpY29uLW9mZnNldC11bml0cyI6IFt4dW5pdHMsIHl1bml0c10sCgkgICAgICAgICAgICAgICAgfTsKCSAgICAgICAgICAgIHJldHVybiB7fTsKCSAgICAgICAgfSksIGdldChpY29uU3R5bGUsICJJY29uIiwgKGljb24sIHByb3BlcnRpZXMpID0+IHsKCSAgICAgICAgICAgIHZhbDEoaWNvbiwgImhyZWYiLCAoaHJlZikgPT4gewoJICAgICAgICAgICAgICAgIHByb3BlcnRpZXMuaWNvbiA9IGhyZWY7CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIHJldHVybiBwcm9wZXJ0aWVzOwoJICAgICAgICB9KSk7CgkgICAgfSk7Cgl9CglmdW5jdGlvbiBleHRyYWN0TGFiZWwobm9kZSkgewoJICAgIHJldHVybiBnZXQobm9kZSwgIkxhYmVsU3R5bGUiLCAobGFiZWxTdHlsZSkgPT4gewoJICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihnZXRDb2xvcihsYWJlbFN0eWxlLCAibGFiZWwiKSwgbnVtZXJpY1Byb3BlcnR5KGxhYmVsU3R5bGUsICJzY2FsZSIsICJsYWJlbC1zY2FsZSIpKTsKCSAgICB9KTsKCX0KCWZ1bmN0aW9uIGV4dHJhY3RMaW5lKG5vZGUpIHsKCSAgICByZXR1cm4gZ2V0KG5vZGUsICJMaW5lU3R5bGUiLCAobGluZVN0eWxlKSA9PiB7CgkgICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKGdldENvbG9yKGxpbmVTdHlsZSwgInN0cm9rZSIpLCBudW1lcmljUHJvcGVydHkobGluZVN0eWxlLCAid2lkdGgiLCAic3Ryb2tlLXdpZHRoIikpOwoJICAgIH0pOwoJfQoJZnVuY3Rpb24gZXh0cmFjdFBvbHkobm9kZSkgewoJICAgIHJldHVybiBnZXQobm9kZSwgIlBvbHlTdHlsZSIsIChwb2x5U3R5bGUsIHByb3BlcnRpZXMpID0+IHsKCSAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24ocHJvcGVydGllcywgZ2V0KHBvbHlTdHlsZSwgImNvbG9yIiwgKGVsZW0pID0+IGZpeENvbG9yKG5vZGVWYWwoZWxlbSksICJmaWxsIikpLCB2YWwxKHBvbHlTdHlsZSwgImZpbGwiLCAoZmlsbCkgPT4gewoJICAgICAgICAgICAgaWYgKGZpbGwgPT09ICIwIikKCSAgICAgICAgICAgICAgICByZXR1cm4geyAiZmlsbC1vcGFjaXR5IjogMCB9OwoJICAgICAgICB9KSwgdmFsMShwb2x5U3R5bGUsICJvdXRsaW5lIiwgKG91dGxpbmUpID0+IHsKCSAgICAgICAgICAgIGlmIChvdXRsaW5lID09PSAiMCIpCgkgICAgICAgICAgICAgICAgcmV0dXJuIHsgInN0cm9rZS1vcGFjaXR5IjogMCB9OwoJICAgICAgICB9KSk7CgkgICAgfSk7Cgl9CglmdW5jdGlvbiBleHRyYWN0U3R5bGUobm9kZSkgewoJICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBleHRyYWN0UG9seShub2RlKSwgZXh0cmFjdExpbmUobm9kZSksIGV4dHJhY3RMYWJlbChub2RlKSwgZXh0cmFjdEljb24obm9kZSkpOwoJfQoKCWNvbnN0IHJlbW92ZVNwYWNlID0gL1xzKi9nOwoJY29uc3QgdHJpbVNwYWNlID0gL15ccyp8XHMqJC9nOwoJY29uc3Qgc3BsaXRTcGFjZSA9IC9ccysvOwoJLyoqCgkgKiBHZXQgb25lIGNvb3JkaW5hdGUgZnJvbSBhIGNvb3JkaW5hdGUgYXJyYXksIGlmIGFueQoJICovCglmdW5jdGlvbiBjb29yZDEodmFsdWUpIHsKCSAgICByZXR1cm4gdmFsdWUKCSAgICAgICAgLnJlcGxhY2UocmVtb3ZlU3BhY2UsICIiKQoJICAgICAgICAuc3BsaXQoIiwiKQoJICAgICAgICAubWFwKHBhcnNlRmxvYXQpCgkgICAgICAgIC5maWx0ZXIoKG51bSkgPT4gIWlzTmFOKG51bSkpCgkgICAgICAgIC5zbGljZSgwLCAzKTsKCX0KCS8qKgoJICogR2V0IGFsbCBjb29yZGluYXRlcyBmcm9tIGEgY29vcmRpbmF0ZSBhcnJheSBhcyBbW10sW11dCgkgKi8KCWZ1bmN0aW9uIGNvb3JkKHZhbHVlKSB7CgkgICAgcmV0dXJuIHZhbHVlCgkgICAgICAgIC5yZXBsYWNlKHRyaW1TcGFjZSwgIiIpCgkgICAgICAgIC5zcGxpdChzcGxpdFNwYWNlKQoJICAgICAgICAubWFwKGNvb3JkMSkKCSAgICAgICAgLmZpbHRlcigoY29vcmQpID0+IHsKCSAgICAgICAgcmV0dXJuIGNvb3JkLmxlbmd0aCA+PSAyOwoJICAgIH0pOwoJfQoJZnVuY3Rpb24gZ3hDb29yZHMobm9kZSkgewoJICAgIGxldCBlbGVtcyA9ICQobm9kZSwgImNvb3JkIik7CgkgICAgaWYgKGVsZW1zLmxlbmd0aCA9PT0gMCkgewoJICAgICAgICBlbGVtcyA9ICRucyhub2RlLCAiY29vcmQiLCAiKiIpOwoJICAgIH0KCSAgICBjb25zdCBjb29yZGluYXRlcyA9IGVsZW1zLm1hcCgoZWxlbSkgPT4gewoJICAgICAgICByZXR1cm4gbm9kZVZhbChlbGVtKS5zcGxpdCgiICIpLm1hcChwYXJzZUZsb2F0KTsKCSAgICB9KTsKCSAgICBpZiAoY29vcmRpbmF0ZXMubGVuZ3RoID09PSAwKSB7CgkgICAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCSAgICByZXR1cm4gewoJICAgICAgICBnZW9tZXRyeTogY29vcmRpbmF0ZXMubGVuZ3RoID4gMgoJICAgICAgICAgICAgPyB7CgkgICAgICAgICAgICAgICAgdHlwZTogIkxpbmVTdHJpbmciLAoJICAgICAgICAgICAgICAgIGNvb3JkaW5hdGVzLAoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgOiB7CgkgICAgICAgICAgICAgICAgdHlwZTogIlBvaW50IiwKCSAgICAgICAgICAgICAgICBjb29yZGluYXRlczogY29vcmRpbmF0ZXNbMF0sCgkgICAgICAgICAgICB9LAoJICAgICAgICB0aW1lczogJChub2RlLCAid2hlbiIpLm1hcCgoZWxlbSkgPT4gbm9kZVZhbChlbGVtKSksCgkgICAgfTsKCX0KCWZ1bmN0aW9uIGZpeFJpbmcocmluZykgewoJICAgIGlmIChyaW5nLmxlbmd0aCA9PT0gMCkKCSAgICAgICAgcmV0dXJuIHJpbmc7CgkgICAgY29uc3QgZmlyc3QgPSByaW5nWzBdOwoJICAgIGNvbnN0IGxhc3QgPSByaW5nW3JpbmcubGVuZ3RoIC0gMV07CgkgICAgbGV0IGVxdWFsID0gdHJ1ZTsKCSAgICBmb3IgKGxldCBpID0gMDsgaSA8IE1hdGgubWF4KGZpcnN0Lmxlbmd0aCwgbGFzdC5sZW5ndGgpOyBpKyspIHsKCSAgICAgICAgaWYgKGZpcnN0W2ldICE9PSBsYXN0W2ldKSB7CgkgICAgICAgICAgICBlcXVhbCA9IGZhbHNlOwoJICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgIH0KCSAgICB9CgkgICAgaWYgKCFlcXVhbCkgewoJICAgICAgICByZXR1cm4gcmluZy5jb25jYXQoW3JpbmdbMF1dKTsKCSAgICB9CgkgICAgcmV0dXJuIHJpbmc7Cgl9Cgljb25zdCBHRU9fVFlQRVMgPSBbCgkgICAgIlBvbHlnb24iLAoJICAgICJMaW5lU3RyaW5nIiwKCSAgICAiUG9pbnQiLAoJICAgICJUcmFjayIsCgkgICAgImd4OlRyYWNrIiwKCV07CglmdW5jdGlvbiBnZXRDb29yZGluYXRlcyhub2RlKSB7CgkgICAgcmV0dXJuIG5vZGVWYWwoZ2V0MShub2RlLCAiY29vcmRpbmF0ZXMiKSk7Cgl9CglmdW5jdGlvbiBnZXRHZW9tZXRyeShub2RlKSB7CgkgICAgY29uc3QgZ2VvbWV0cmllcyA9IFtdOwoJICAgIGNvbnN0IGNvb3JkVGltZXMgPSBbXTsKCSAgICBmb3IgKGNvbnN0IHQgb2YgWyJNdWx0aUdlb21ldHJ5IiwgIk11bHRpVHJhY2siLCAiZ3g6TXVsdGlUcmFjayJdKSB7CgkgICAgICAgIGNvbnN0IGVsZW0gPSBnZXQxKG5vZGUsIHQpOwoJICAgICAgICBpZiAoZWxlbSkgewoJICAgICAgICAgICAgcmV0dXJuIGdldEdlb21ldHJ5KGVsZW0pOwoJICAgICAgICB9CgkgICAgfQoJICAgIGZvciAoY29uc3QgZ2VvVHlwZSBvZiBHRU9fVFlQRVMpIHsKCSAgICAgICAgZm9yIChjb25zdCBnZW9tTm9kZSBvZiAkKG5vZGUsIGdlb1R5cGUpKSB7CgkgICAgICAgICAgICBzd2l0Y2ggKGdlb1R5cGUpIHsKCSAgICAgICAgICAgICAgICBjYXNlICJQb2ludCI6IHsKCSAgICAgICAgICAgICAgICAgICAgY29uc3QgY29vcmRpbmF0ZXMgPSBjb29yZDEoZ2V0Q29vcmRpbmF0ZXMoZ2VvbU5vZGUpKTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKGNvb3JkaW5hdGVzLmxlbmd0aCA+PSAyKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBnZW9tZXRyaWVzLnB1c2goewoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJQb2ludCIsCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29vcmRpbmF0ZXMsCgkgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgY2FzZSAiTGluZVN0cmluZyI6IHsKCSAgICAgICAgICAgICAgICAgICAgY29uc3QgY29vcmRpbmF0ZXMgPSBjb29yZChnZXRDb29yZGluYXRlcyhnZW9tTm9kZSkpOwoJICAgICAgICAgICAgICAgICAgICBpZiAoY29vcmRpbmF0ZXMubGVuZ3RoID49IDIpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGdlb21ldHJpZXMucHVzaCh7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIkxpbmVTdHJpbmciLAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvb3JkaW5hdGVzLAoJICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIGNhc2UgIlBvbHlnb24iOiB7CgkgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvb3JkcyA9IFtdOwoJICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGxpbmVhclJpbmcgb2YgJChnZW9tTm9kZSwgIkxpbmVhclJpbmciKSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmluZyA9IGZpeFJpbmcoY29vcmQoZ2V0Q29vcmRpbmF0ZXMobGluZWFyUmluZykpKTsKCSAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyaW5nLmxlbmd0aCA+PSA0KSB7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29vcmRzLnB1c2gocmluZyk7CgkgICAgICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAgICAgaWYgKGNvb3Jkcy5sZW5ndGgpIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIGdlb21ldHJpZXMucHVzaCh7CgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIlBvbHlnb24iLAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvb3JkaW5hdGVzOiBjb29yZHMsCgkgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgY2FzZSAiVHJhY2siOgoJICAgICAgICAgICAgICAgIGNhc2UgImd4OlRyYWNrIjogewoJICAgICAgICAgICAgICAgICAgICBjb25zdCBneCA9IGd4Q29vcmRzKGdlb21Ob2RlKTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKCFneCkKCSAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgICAgICBjb25zdCB7IHRpbWVzLCBnZW9tZXRyeSB9ID0gZ3g7CgkgICAgICAgICAgICAgICAgICAgIGdlb21ldHJpZXMucHVzaChnZW9tZXRyeSk7CgkgICAgICAgICAgICAgICAgICAgIGlmICh0aW1lcy5sZW5ndGgpCgkgICAgICAgICAgICAgICAgICAgICAgICBjb29yZFRpbWVzLnB1c2godGltZXMpOwoJICAgICAgICAgICAgICAgICAgICBicmVhazsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIHsKCSAgICAgICAgZ2VvbWV0cmllcywKCSAgICAgICAgY29vcmRUaW1lcywKCSAgICB9OwoJfQoKCWZ1bmN0aW9uIGV4dHJhY3RFeHRlbmRlZERhdGEobm9kZSkgewoJICAgIHJldHVybiBnZXQobm9kZSwgIkV4dGVuZGVkRGF0YSIsIChleHRlbmRlZERhdGEsIHByb3BlcnRpZXMpID0+IHsKCSAgICAgICAgZm9yIChjb25zdCBkYXRhIG9mICQoZXh0ZW5kZWREYXRhLCAiRGF0YSIpKSB7CgkgICAgICAgICAgICBwcm9wZXJ0aWVzW2RhdGEuZ2V0QXR0cmlidXRlKCJuYW1lIikgfHwgIiJdID0gbm9kZVZhbChnZXQxKGRhdGEsICJ2YWx1ZSIpKTsKCSAgICAgICAgfQoJICAgICAgICBmb3IgKGNvbnN0IHNpbXBsZURhdGEgb2YgJChleHRlbmRlZERhdGEsICJTaW1wbGVEYXRhIikpIHsKCSAgICAgICAgICAgIHByb3BlcnRpZXNbc2ltcGxlRGF0YS5nZXRBdHRyaWJ1dGUoIm5hbWUiKSB8fCAiIl0gPSBub2RlVmFsKHNpbXBsZURhdGEpOwoJICAgICAgICB9CgkgICAgICAgIHJldHVybiBwcm9wZXJ0aWVzOwoJICAgIH0pOwoJfQoJZnVuY3Rpb24gZ2VvbWV0cnlMaXN0VG9HZW9tZXRyeShnZW9tZXRyaWVzKSB7CgkgICAgcmV0dXJuIGdlb21ldHJpZXMubGVuZ3RoID09PSAwCgkgICAgICAgID8gbnVsbAoJICAgICAgICA6IGdlb21ldHJpZXMubGVuZ3RoID09PSAxCgkgICAgICAgICAgICA/IGdlb21ldHJpZXNbMF0KCSAgICAgICAgICAgIDogewoJICAgICAgICAgICAgICAgIHR5cGU6ICJHZW9tZXRyeUNvbGxlY3Rpb24iLAoJICAgICAgICAgICAgICAgIGdlb21ldHJpZXMsCgkgICAgICAgICAgICB9OwoJfQoJZnVuY3Rpb24gZXh0cmFjdFRpbWVTcGFuKG5vZGUpIHsKCSAgICByZXR1cm4gZ2V0KG5vZGUsICJUaW1lU3BhbiIsICh0aW1lU3BhbikgPT4gewoJICAgICAgICByZXR1cm4gewoJICAgICAgICAgICAgdGltZXNwYW46IHsKCSAgICAgICAgICAgICAgICBiZWdpbjogbm9kZVZhbChnZXQxKHRpbWVTcGFuLCAiYmVnaW4iKSksCgkgICAgICAgICAgICAgICAgZW5kOiBub2RlVmFsKGdldDEodGltZVNwYW4sICJlbmQiKSksCgkgICAgICAgICAgICB9LAoJICAgICAgICB9OwoJICAgIH0pOwoJfQoJZnVuY3Rpb24gZXh0cmFjdFRpbWVTdGFtcChub2RlKSB7CgkgICAgcmV0dXJuIGdldChub2RlLCAiVGltZVN0YW1wIiwgKHRpbWVTdGFtcCkgPT4gewoJICAgICAgICByZXR1cm4geyB0aW1lc3RhbXA6IG5vZGVWYWwoZ2V0MSh0aW1lU3RhbXAsICJ3aGVuIikpIH07CgkgICAgfSk7Cgl9CglmdW5jdGlvbiBleHRyYWN0Q2FzY2FkZWRTdHlsZShub2RlLCBzdHlsZU1hcCkgewoJICAgIHJldHVybiB2YWwxKG5vZGUsICJzdHlsZVVybCIsIChzdHlsZVVybCkgPT4gewoJICAgICAgICBzdHlsZVVybCA9IG5vcm1hbGl6ZUlkKHN0eWxlVXJsKTsKCSAgICAgICAgaWYgKHN0eWxlTWFwW3N0eWxlVXJsXSkgewoJICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oeyBzdHlsZVVybCB9LCBzdHlsZU1hcFtzdHlsZVVybF0pOwoJICAgICAgICB9CgkgICAgICAgIC8vIEZvciBiYWNrd2FyZC1jb21wYXRpYmlsaXR5LiBTaG91bGQgd2Ugc3RpbGwgaW5jbHVkZQoJICAgICAgICAvLyBzdHlsZVVybCBldmVuIGlmIGl0J3Mgbm90IHJlc29sdmVkPwoJICAgICAgICByZXR1cm4geyBzdHlsZVVybCB9OwoJICAgIH0pOwoJfQoJZnVuY3Rpb24gZ2V0TWF5YmVIVE1MRGVzY3JpcHRpb24obm9kZSkgewoJICAgIGNvbnN0IGRlc2NyaXB0aW9uTm9kZSA9IGdldDEobm9kZSwgImRlc2NyaXB0aW9uIik7CgkgICAgZm9yIChjb25zdCBjIG9mIEFycmF5LmZyb20oZGVzY3JpcHRpb25Ob2RlPy5jaGlsZE5vZGVzIHx8IFtdKSkgewoJICAgICAgICBpZiAoYy5ub2RlVHlwZSA9PT0gNCkgewoJICAgICAgICAgICAgcmV0dXJuIHsKCSAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogewoJICAgICAgICAgICAgICAgICAgICAiQHR5cGUiOiAiaHRtbCIsCgkgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBub2RlVmFsKGMpLAoJICAgICAgICAgICAgICAgIH0sCgkgICAgICAgICAgICB9OwoJICAgICAgICB9CgkgICAgfQoJICAgIHJldHVybiB7fTsKCX0KCWZ1bmN0aW9uIGdldFBsYWNlbWFyayhub2RlLCBzdHlsZU1hcCkgewoJICAgIGNvbnN0IHsgY29vcmRUaW1lcywgZ2VvbWV0cmllcyB9ID0gZ2V0R2VvbWV0cnkobm9kZSk7CgkgICAgY29uc3QgZmVhdHVyZSA9IHsKCSAgICAgICAgdHlwZTogIkZlYXR1cmUiLAoJICAgICAgICBnZW9tZXRyeTogZ2VvbWV0cnlMaXN0VG9HZW9tZXRyeShnZW9tZXRyaWVzKSwKCSAgICAgICAgcHJvcGVydGllczogT2JqZWN0LmFzc2lnbihnZXRNdWx0aShub2RlLCBbCgkgICAgICAgICAgICAibmFtZSIsCgkgICAgICAgICAgICAiYWRkcmVzcyIsCgkgICAgICAgICAgICAidmlzaWJpbGl0eSIsCgkgICAgICAgICAgICAib3BlbiIsCgkgICAgICAgICAgICAicGhvbmVOdW1iZXIiLAoJICAgICAgICAgICAgImRlc2NyaXB0aW9uIiwKCSAgICAgICAgXSksIGdldE1heWJlSFRNTERlc2NyaXB0aW9uKG5vZGUpLCBleHRyYWN0Q2FzY2FkZWRTdHlsZShub2RlLCBzdHlsZU1hcCksIGV4dHJhY3RTdHlsZShub2RlKSwgZXh0cmFjdEV4dGVuZGVkRGF0YShub2RlKSwgZXh0cmFjdFRpbWVTcGFuKG5vZGUpLCBleHRyYWN0VGltZVN0YW1wKG5vZGUpLCBjb29yZFRpbWVzLmxlbmd0aAoJICAgICAgICAgICAgPyB7CgkgICAgICAgICAgICAgICAgY29vcmRpbmF0ZVByb3BlcnRpZXM6IHsKCSAgICAgICAgICAgICAgICAgICAgdGltZXM6IGNvb3JkVGltZXMubGVuZ3RoID09PSAxID8gY29vcmRUaW1lc1swXSA6IGNvb3JkVGltZXMsCgkgICAgICAgICAgICAgICAgfSwKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIDoge30pLAoJICAgIH07CgkgICAgY29uc3QgaWQgPSBub2RlLmdldEF0dHJpYnV0ZSgiaWQiKTsKCSAgICBpZiAoaWQgIT09IG51bGwgJiYgaWQgIT09ICIiKQoJICAgICAgICBmZWF0dXJlLmlkID0gaWQ7CgkgICAgcmV0dXJuIGZlYXR1cmU7Cgl9CgoJZnVuY3Rpb24gZ2V0U3R5bGVJZChzdHlsZSkgewoJICAgIGxldCBpZCA9IHN0eWxlLmdldEF0dHJpYnV0ZSgiaWQiKTsKCSAgICBjb25zdCBwYXJlbnROb2RlID0gc3R5bGUucGFyZW50Tm9kZTsKCSAgICBpZiAoIWlkICYmCgkgICAgICAgIGlzRWxlbWVudChwYXJlbnROb2RlKSAmJgoJICAgICAgICBwYXJlbnROb2RlLmxvY2FsTmFtZSA9PT0gIkNhc2NhZGluZ1N0eWxlIikgewoJICAgICAgICBpZCA9IHBhcmVudE5vZGUuZ2V0QXR0cmlidXRlKCJrbWw6aWQiKSB8fCBwYXJlbnROb2RlLmdldEF0dHJpYnV0ZSgiaWQiKTsKCSAgICB9CgkgICAgcmV0dXJuIG5vcm1hbGl6ZUlkKGlkIHx8ICIiKTsKCX0KCWZ1bmN0aW9uIGJ1aWxkU3R5bGVNYXAobm9kZSkgewoJICAgIGNvbnN0IHN0eWxlTWFwID0ge307CgkgICAgZm9yIChjb25zdCBzdHlsZSBvZiAkKG5vZGUsICJTdHlsZSIpKSB7CgkgICAgICAgIHN0eWxlTWFwW2dldFN0eWxlSWQoc3R5bGUpXSA9IGV4dHJhY3RTdHlsZShzdHlsZSk7CgkgICAgfQoJICAgIGZvciAoY29uc3QgbWFwIG9mICQobm9kZSwgIlN0eWxlTWFwIikpIHsKCSAgICAgICAgY29uc3QgaWQgPSBub3JtYWxpemVJZChtYXAuZ2V0QXR0cmlidXRlKCJpZCIpIHx8ICIiKTsKCSAgICAgICAgdmFsMShtYXAsICJzdHlsZVVybCIsIChzdHlsZVVybCkgPT4gewoJICAgICAgICAgICAgc3R5bGVVcmwgPSBub3JtYWxpemVJZChzdHlsZVVybCk7CgkgICAgICAgICAgICBpZiAoc3R5bGVNYXBbc3R5bGVVcmxdKSB7CgkgICAgICAgICAgICAgICAgc3R5bGVNYXBbaWRdID0gc3R5bGVNYXBbc3R5bGVVcmxdOwoJICAgICAgICAgICAgfQoJICAgICAgICB9KTsKCSAgICB9CgkgICAgcmV0dXJuIHN0eWxlTWFwOwoJfQoJY29uc3QgRk9MREVSX1BST1BTID0gWwoJICAgICJuYW1lIiwKCSAgICAidmlzaWJpbGl0eSIsCgkgICAgIm9wZW4iLAoJICAgICJhZGRyZXNzIiwKCSAgICAiZGVzY3JpcHRpb24iLAoJICAgICJwaG9uZU51bWJlciIsCgkgICAgInZpc2liaWxpdHkiLAoJXTsKCWZ1bmN0aW9uIGdldEZvbGRlcihub2RlKSB7CgkgICAgY29uc3QgbWV0YSA9IHt9OwoJICAgIGZvciAoY29uc3QgY2hpbGQgb2YgQXJyYXkuZnJvbShub2RlLmNoaWxkTm9kZXMpKSB7CgkgICAgICAgIGlmIChpc0VsZW1lbnQoY2hpbGQpICYmIEZPTERFUl9QUk9QUy5pbmNsdWRlcyhjaGlsZC50YWdOYW1lKSkgewoJICAgICAgICAgICAgbWV0YVtjaGlsZC50YWdOYW1lXSA9IG5vZGVWYWwoY2hpbGQpOwoJICAgICAgICB9CgkgICAgfQoJICAgIHJldHVybiB7CgkgICAgICAgIHR5cGU6ICJmb2xkZXIiLAoJICAgICAgICBtZXRhLAoJICAgICAgICBjaGlsZHJlbjogW10sCgkgICAgfTsKCX0KCS8qKgoJICogWWllbGQgYSBuZXN0ZWQgdHJlZSB3aXRoIEtNTCBmb2xkZXIgc3RydWN0dXJlCgkgKgoJICogVGhpcyBnZW5lcmF0ZXMgYSB0cmVlIHdpdGggdGhlIGdpdmVuIHN0cnVjdHVyZToKCSAqCgkgKiBgYGBqcwoJICogewoJICogICAidHlwZSI6ICJyb290IiwKCSAqICAgImNoaWxkcmVuIjogWwoJICogICAgIHsKCSAqICAgICAgICJ0eXBlIjogImZvbGRlciIsCgkgKiAgICAgICAibWV0YSI6IHsKCSAqICAgICAgICAgIm5hbWUiOiAiVGVzdCIKCSAqICAgICAgIH0sCgkgKiAgICAgICAiY2hpbGRyZW4iOiBbCgkgKiAgICAgICAgICAvLyAuLi5mZWF0dXJlcyBhbmQgZm9sZGVycwoJICogICAgICAgXQoJICogICAgIH0KCSAqICAgICAvLyAuLi5mZWF0dXJlcwoJICogICBdCgkgKiB9CgkgKiBgYGAKCSAqLwoJZnVuY3Rpb24ga21sV2l0aEZvbGRlcnMobm9kZSkgewoJICAgIGNvbnN0IHN0eWxlTWFwID0gYnVpbGRTdHlsZU1hcChub2RlKTsKCSAgICBjb25zdCB0cmVlID0geyB0eXBlOiAicm9vdCIsIGNoaWxkcmVuOiBbXSB9OwoJICAgIGZ1bmN0aW9uIHRyYXZlcnNlKG5vZGUsIHBvaW50ZXIpIHsKCSAgICAgICAgaWYgKGlzRWxlbWVudChub2RlKSkgewoJICAgICAgICAgICAgc3dpdGNoIChub2RlLnRhZ05hbWUpIHsKCSAgICAgICAgICAgICAgICBjYXNlICJQbGFjZW1hcmsiOiB7CgkgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBsYWNlbWFyayA9IGdldFBsYWNlbWFyayhub2RlLCBzdHlsZU1hcCk7CgkgICAgICAgICAgICAgICAgICAgIGlmIChwbGFjZW1hcmspIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIHBvaW50ZXIuY2hpbGRyZW4ucHVzaChwbGFjZW1hcmspOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBjYXNlICJGb2xkZXIiOiB7CgkgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvbGRlciA9IGdldEZvbGRlcihub2RlKTsKCSAgICAgICAgICAgICAgICAgICAgcG9pbnRlci5jaGlsZHJlbi5wdXNoKGZvbGRlcik7CgkgICAgICAgICAgICAgICAgICAgIHBvaW50ZXIgPSBmb2xkZXI7CgkgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgICAgICBpZiAobm9kZS5jaGlsZE5vZGVzKSB7CgkgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUuY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykgewoJICAgICAgICAgICAgICAgIHRyYXZlcnNlKG5vZGUuY2hpbGROb2Rlc1tpXSwgcG9pbnRlcik7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9CgkgICAgdHJhdmVyc2Uobm9kZSwgdHJlZSk7CgkgICAgcmV0dXJuIHRyZWU7Cgl9CgkvKioKCSAqIENvbnZlcnQgS01MIHRvIEdlb0pTT04gaW5jcmVtZW50YWxseSwgcmV0dXJuaW5nCgkgKiBhIFtHZW5lcmF0b3JdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvR3VpZGUvSXRlcmF0b3JzX2FuZF9HZW5lcmF0b3JzKQoJICogdGhhdCB5aWVsZHMgb3V0cHV0IGZlYXR1cmUgYnkgZmVhdHVyZS4KCSAqLwoJZnVuY3Rpb24qIGttbEdlbihub2RlKSB7CgkgICAgY29uc3Qgc3R5bGVNYXAgPSBidWlsZFN0eWxlTWFwKG5vZGUpOwoJICAgIGZvciAoY29uc3QgcGxhY2VtYXJrIG9mICQobm9kZSwgIlBsYWNlbWFyayIpKSB7CgkgICAgICAgIGNvbnN0IGZlYXR1cmUgPSBnZXRQbGFjZW1hcmsocGxhY2VtYXJrLCBzdHlsZU1hcCk7CgkgICAgICAgIGlmIChmZWF0dXJlKQoJICAgICAgICAgICAgeWllbGQgZmVhdHVyZTsKCSAgICB9Cgl9CgkvKioKCSAqIENvbnZlcnQgYSBLTUwgZG9jdW1lbnQgdG8gR2VvSlNPTi4gVGhlIGZpcnN0IGFyZ3VtZW50LCBgZG9jYCwgbXVzdCBiZSBhIEtNTAoJICogZG9jdW1lbnQgYXMgYW4gWE1MIERPTSAtIG5vdCBhcyBhIHN0cmluZy4gWW91IGNhbiBnZXQgdGhpcyB1c2luZyBqUXVlcnkncyBkZWZhdWx0CgkgKiBgLmFqYXhgIGZ1bmN0aW9uIG9yIHVzaW5nIGEgYmFyZSBYTUxIdHRwUmVxdWVzdCB3aXRoIHRoZSBgLnJlc3BvbnNlYCBwcm9wZXJ0eQoJICogaG9sZGluZyBhbiBYTUwgRE9NLgoJICoKCSAqIFRoZSBvdXRwdXQgaXMgYSBKYXZhU2NyaXB0IG9iamVjdCBvZiBHZW9KU09OIGRhdGEuIFlvdSBjYW4gY29udmVydCBpdCB0byBhIHN0cmluZwoJICogd2l0aCBbSlNPTi5zdHJpbmdpZnldKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL0pTT04vc3RyaW5naWZ5KQoJICogb3IgdXNlIGl0IGRpcmVjdGx5IGluIGxpYnJhcmllcy4KCSAqLwoJZnVuY3Rpb24ga21sKG5vZGUpIHsKCSAgICByZXR1cm4gewoJICAgICAgICB0eXBlOiAiRmVhdHVyZUNvbGxlY3Rpb24iLAoJICAgICAgICBmZWF0dXJlczogQXJyYXkuZnJvbShrbWxHZW4obm9kZSkpLAoJICAgIH07Cgl9CgoJdmFyIHRvR2VvSnNvbiA9IC8qI19fUFVSRV9fKi9PYmplY3QuZnJlZXplKHsKCQlfX3Byb3RvX186IG51bGwsCgkJZ3B4OiBncHgsCgkJZ3B4R2VuOiBncHhHZW4sCgkJa21sOiBrbWwsCgkJa21sR2VuOiBrbWxHZW4sCgkJa21sV2l0aEZvbGRlcnM6IGttbFdpdGhGb2xkZXJzLAoJCXRjeDogdGN4LAoJCXRjeEdlbjogdGN4R2VuCgl9KTsKCgljbGFzcyBDb252ZXJ0ZXIgew0KCSAgICBjb25zdHJ1Y3Rvcihmb3JtYXQsIGRhdGEpIHsNCgkgICAgICAgIHRoaXMuYmxhbmtHZW9KU09OID0gKCkgPT4gKHsNCgkgICAgICAgICAgICAndHlwZSc6ICdGZWF0dXJlQ29sbGVjdGlvbicsDQoJICAgICAgICAgICAgJ2ZlYXR1cmVzJzogW10NCgkgICAgICAgIH0pOw0KCSAgICAgICAgdGhpcy5fcmF3RGF0YSA9IGRhdGE7DQoJICAgICAgICB0aGlzLl9mb3JtYXQgPSBmb3JtYXQ7DQoJICAgICAgICBjb25zdCBjb252ZXJ0ZXJzID0gew0KCSAgICAgICAgICAgICd0b3BvanNvbic6IHRoaXMubG9hZFRvcG9Kc29uLA0KCSAgICAgICAgICAgICdrbWwnOiB0aGlzLmxvYWRYbWwsDQoJICAgICAgICAgICAgJ2dweCc6IHRoaXMubG9hZFhtbCwNCgkgICAgICAgICAgICAndGN4JzogdGhpcy5sb2FkWG1sLA0KCSAgICAgICAgICAgICdjc3YnOiB0aGlzLmxvYWRDc3YsDQoJICAgICAgICAgICAgJ3Rzdic6IHRoaXMubG9hZENzdg0KCSAgICAgICAgfTsNCgkgICAgICAgIHRoaXMuX2NvbnZlcnNpb25GbiA9IGNvbnZlcnRlcnNbZm9ybWF0XTsNCgkgICAgfQ0KCSAgICBhc3luYyBjb252ZXJ0KCkgew0KCSAgICAgICAgaWYgKCF0aGlzLl9jb252ZXJzaW9uRm4pIHsNCgkgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKF8sIHJlaikgPT4gcmVqKGBObyBjb252ZXJ0ZXIgZXhpc3RzIGZvciAke3RoaXMuX2Zvcm1hdH1gKSk7DQoJICAgICAgICB9DQoJICAgICAgICBlbHNlIHsNCgkgICAgICAgICAgICByZXR1cm4gdGhpcy5fY29udmVyc2lvbkZuKCk7DQoJICAgICAgICB9DQoJICAgIH0NCgkgICAgYXN5bmMgbG9hZFhtbCgpIHsNCgkgICAgICAgIGNvbnN0IGdlb2pzb24gPSB0b0dlb0pzb25bdGhpcy5fZm9ybWF0XShuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKHRoaXMuX3Jhd0RhdGEsICJ0ZXh0L3htbCIpKTsNCgkgICAgICAgIHJldHVybiBnZW9qc29uOw0KCSAgICB9DQoJICAgIGFzeW5jIGxvYWRDc3YoKSB7DQoJICAgICAgICBsZXQgZ2VvanNvbiA9IHRoaXMuYmxhbmtHZW9KU09OKCk7DQoJICAgICAgICBsZXQgb3B0aW9ucyA9IHt9Ow0KCSAgICAgICAgaWYgKHRoaXMuX2Zvcm1hdCA9PT0gJ3RzdicpIHsNCgkgICAgICAgICAgICBvcHRpb25zLmRlbGltaXRlciA9ICdcdCc7DQoJICAgICAgICB9DQoJICAgICAgICBnZW9qc29uID0gYXdhaXQgbmV3IFByb21pc2UoKHJlcywgcmVqKSA9PiB7DQoJICAgICAgICAgICAgY3N2Mmdlb2pzb25fMS5jc3YyZ2VvanNvbih0aGlzLl9yYXdEYXRhLCBvcHRpb25zLCAoZXJyLCBkYXRhKSA9PiBlcnIgPyByZWooZXJyKSA6IHJlcyhkYXRhKSk7DQoJICAgICAgICB9KTsNCgkgICAgICAgIHJldHVybiBnZW9qc29uOw0KCSAgICB9DQoJICAgIGFzeW5jIGxvYWRUb3BvSnNvbigpIHsNCgkgICAgICAgIGxldCB0b3BvSnNvbkRhdGEgPSB7fTsNCgkgICAgICAgIHRyeSB7DQoJICAgICAgICAgICAgdG9wb0pzb25EYXRhID0gSlNPTi5wYXJzZSh0aGlzLl9yYXdEYXRhKTsNCgkgICAgICAgIH0NCgkgICAgICAgIGNhdGNoIChlKSB7DQoJICAgICAgICAgICAgdGhyb3cgIkludmFsaWQgVG9wb0pzb24iOw0KCSAgICAgICAgfQ0KCSAgICAgICAgLy8gQ29udmVydCB0aGUgZGF0YQ0KCSAgICAgICAgbGV0IHJlc3VsdCA9IHRoaXMuYmxhbmtHZW9KU09OKCk7DQoJICAgICAgICBpZiAodG9wb0pzb25EYXRhLnR5cGUgPT09ICJUb3BvbG9neSIgJiYgdG9wb0pzb25EYXRhLm9iamVjdHMgIT09IHVuZGVmaW5lZCkgew0KCSAgICAgICAgICAgIHJlc3VsdCA9IHsNCgkgICAgICAgICAgICAgICAgdHlwZTogIkZlYXR1cmVDb2xsZWN0aW9uIiwNCgkgICAgICAgICAgICAgICAgZmVhdHVyZXM6IHJlc3VsdC5mZWF0dXJlcyA9IE9iamVjdC5rZXlzKHRvcG9Kc29uRGF0YS5vYmplY3RzKS5tYXAoa2V5ID0+IHRvcG9qc29uRmVhdHVyZSh0b3BvSnNvbkRhdGEsIGtleSkpLnJlZHVjZSgoYSwgdikgPT4gWy4uLmEsIC4uLnYuZmVhdHVyZXNdLCBbXSkNCgkgICAgICAgICAgICB9Ow0KCSAgICAgICAgfQ0KCSAgICAgICAgcmV0dXJuIHJlc3VsdDsNCgkgICAgfQ0KCSAgICA7DQoJfQoKCWNvbnN0IGxpYnJhcmllcyA9IHsNCgkgICAgJ0NvbnZlcnRlcic6IENvbnZlcnRlcg0KCX07DQoJbGV0IHN1YkNsYXNzOw0KCXNlbGYuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGUgPT4gew0KCSAgICBjb25zdCBkYXRhID0gKGUuZGF0YSB8fCBlKTsNCgkgICAgY29uc3QgcG9zdCA9IChpZCwgZXJyLCByZXMsIHR5cGUpID0+IHsNCgkgICAgICAgIHBvc3RNZXNzYWdlKHsNCgkgICAgICAgICAgICB0eXBlOiB0eXBlID8gdHlwZSA6IChlcnIgPyAnZXJyb3InIDogJ3Jlc3BvbnNlJyksDQoJICAgICAgICAgICAgaWQ6IGlkLA0KCSAgICAgICAgICAgIG1lc3NhZ2U6IHJlcywNCgkgICAgICAgICAgICBlcnJvcjogZXJyDQoJICAgICAgICB9KTsNCgkgICAgfTsNCgkgICAgY29uc3QgY29tbWFuZHMgPSB7DQoJICAgICAgICAnaW5pdCc6IChtc2cpID0+IHsNCgkgICAgICAgICAgICBjb25zdCB7IGlkLCBjb21tYW5kLCBtZXNzYWdlIH0gPSBtc2c7DQoJICAgICAgICAgICAgc3ViQ2xhc3MgPSBuZXcgbGlicmFyaWVzW2NvbW1hbmRdKG1lc3NhZ2VbMF0sIG1lc3NhZ2VbMV0pOw0KCSAgICAgICAgICAgIC8vIHJldHVybiB0aGUgY2xhc3MnIG1ldGhvZHMNCgkgICAgICAgICAgICBjb25zdCBmbnMgPSBbDQoJICAgICAgICAgICAgICAgIC4uLk9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKGxpYnJhcmllc1tjb21tYW5kXS5wcm90b3R5cGUpLA0KCSAgICAgICAgICAgICAgICAuLi5PYmplY3Qua2V5cyhzdWJDbGFzcykNCgkgICAgICAgICAgICBdLm1hcChrZXkgPT4gW2tleSwgdHlwZW9mIGxpYnJhcmllc1tjb21tYW5kXS5wcm90b3R5cGVba2V5XV0pDQoJICAgICAgICAgICAgICAgIC5yZWR1Y2UoKGEsIGMpID0+ICh7IC4uLmEsIC4uLnsgW2NbMF1dOiBjWzFdIH0gfSksIHt9KTsNCgkgICAgICAgICAgICBwb3N0KGlkLCB1bmRlZmluZWQsIGZucywgJ2luaXRfcmVzcG9uc2UnKTsNCgkgICAgICAgIH0sDQoJICAgICAgICAnZ2V0JzogZnVuY3Rpb24gKG1zZykgew0KCSAgICAgICAgICAgIGNvbnN0IHsgaWQsIGNvbW1hbmQgfSA9IG1zZzsNCgkgICAgICAgICAgICBpZiAoc3ViQ2xhc3MgJiYgc3ViQ2xhc3NbY29tbWFuZF0pIHsNCgkgICAgICAgICAgICAgICAgcG9zdChpZCwgdW5kZWZpbmVkLCBzdWJDbGFzc1tjb21tYW5kXSk7DQoJICAgICAgICAgICAgfQ0KCSAgICAgICAgICAgIGVsc2Ugew0KCSAgICAgICAgICAgICAgICBwb3N0KGlkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCk7DQoJICAgICAgICAgICAgfQ0KCSAgICAgICAgfSwNCgkgICAgICAgICdleGVjJzogZnVuY3Rpb24gKG1zZykgew0KCSAgICAgICAgICAgIGNvbnN0IHsgaWQsIGNvbW1hbmQsIG1lc3NhZ2UgfSA9IG1zZzsNCgkgICAgICAgICAgICBpZiAoc3ViQ2xhc3MgJiYgc3ViQ2xhc3NbY29tbWFuZF0gJiYgdHlwZW9mIHN1YkNsYXNzW2NvbW1hbmRdID09PSAnZnVuY3Rpb24nKSB7DQoJICAgICAgICAgICAgICAgIGNvbnN0IGNtZCA9IHN1YkNsYXNzW2NvbW1hbmRdDQoJICAgICAgICAgICAgICAgICAgICAuYXBwbHkoc3ViQ2xhc3MsIG1lc3NhZ2UpOw0KCSAgICAgICAgICAgICAgICBpZiAoISFjbWQgJiYgdHlwZW9mIGNtZC50aGVuID09PSAnZnVuY3Rpb24nKSB7DQoJICAgICAgICAgICAgICAgICAgICAvLyBJdCdzIGEgcHJvbWlzZSwgc28gd2FpdCBmb3IgaXQNCgkgICAgICAgICAgICAgICAgICAgIGNtZA0KCSAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKHJlcyA9PiBwb3N0KGlkLCB1bmRlZmluZWQsIHJlcykpDQoJICAgICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGUgPT4gcG9zdChpZCwgZSkpOw0KCSAgICAgICAgICAgICAgICB9DQoJICAgICAgICAgICAgICAgIGVsc2Ugew0KCSAgICAgICAgICAgICAgICAgICAgLy8gTm90IGEgcHJvbWlzZSwganVzdCByZXR1cm4gaXQNCgkgICAgICAgICAgICAgICAgICAgIHBvc3QoaWQsIHVuZGVmaW5lZCwgY21kKTsNCgkgICAgICAgICAgICAgICAgfQ0KCSAgICAgICAgICAgIH0NCgkgICAgICAgICAgICBlbHNlIHsNCgkgICAgICAgICAgICAgICAgLy8gRXJyb3INCgkgICAgICAgICAgICAgICAgcG9zdChpZCwgbmV3IEVycm9yKGBjb21tYW5kICIke2NvbW1hbmR9IiBub3QgZm91bmRgKSk7DQoJICAgICAgICAgICAgfQ0KCSAgICAgICAgfQ0KCSAgICB9Ow0KCSAgICBpZiAoY29tbWFuZHNbZGF0YS50eXBlXSkgew0KCSAgICAgICAgY29tbWFuZHNbZGF0YS50eXBlXShkYXRhKTsNCgkgICAgfQ0KCX0pOwoKfSkoKTsKCg==",hg=null,Kg=!1,Vg?Sg(yg,hg,Kg):function(g,I,C){var A;return function(l){return A=A||kg(g,I,C),new Worker(A,l)}}(yg,hg,Kg));const pg=()=>Math.random().toString(36).substring(2);class Xg{constructor(g,I){this.initId=pg()+"-"+g,this.worker=new Hg,this.handlers=new Map,this.worker.onmessage=g=>{const I=g.data,C=this.handlers.get(I.id),A=this;if(C){if("response"===I.type&&C.res(I.message),"error"===I.type){const g=I.error||new Error(`Unknown error with ${this.subClass}`);C.rej(g)}"init_response"===I.type&&(this._=Object.keys(I.message).map((g=>{const C=typeof I.message[g];return[g,function(){return C?A.exec(g)(...arguments):A.get(g)}]})).reduce(((g,I)=>({...g,[I[0]]:I[1]})),{}),C.res(this._))}},this.worker.postMessage({type:"init",id:this.initId,command:g,message:I})}onLoad(){return new Promise((g=>{void 0===this._?this.handlers.set(this.initId,{res:g,rej:g}):g(this._)}))}exec(g){const I=this;return function(){return new Promise(((C,A)=>{const l=pg()+"-"+g;I.handlers.set(l,{res:C,rej:A}),I.worker.postMessage({type:"exec",id:l,command:g,message:[...arguments]})}))}}get(g){return new Promise(((I,C)=>{const A=pg()+"-"+g;this.handlers.set(A,{res:I,rej:C}),this.worker.postMessage({type:"get",id:A,command:g,message:[]})}))}}const rg="test://http://example.com"!==new URL("test://http://example.com").href,Rg=(g,I)=>{const C=new AbortController,A=g.url.split("://")[0],l=g.url.replace(new RegExp(`^${A}://`),""),b=rg?(g=>{const I=new RegExp("^(https?)(//)");return g.replace(I,"$1:$2")})(l):l;return b&&fetch(b,{signal:C.signal}).then((g=>{200==g.status?g.text().then((g=>{let C,l;["kml","tcx","gpx"].indexOf(A)>=0||!(()=>{let g=!1;try{g="function"==typeof window.Worker}catch(I){g=!1}return g})()?(C=new Jg(A,g),l=C.convert()):(C=new Xg("Converter",[A,g]),l=C.exec("convert")()),l.then((g=>{I(null,g,null,null)})).catch((g=>{I(g)}))})):I(new Error(`Data fetch error: ${g.statusText}`))})).catch((g=>{I(new Error(g))})),{cancel:()=>{C.abort()}}};g.VectorTextProtocol=Rg,g.addProtocols=g=>{Wg.forEach((I=>{g.addProtocol(I,Rg)}))},Object.defineProperty(g,"__esModule",{value:!0})}));
//# sourceMappingURL=maplibre-gl-vector-text-protocol.min.js.map
